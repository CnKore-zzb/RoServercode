----------------------------------------------------------------------------------------------------------------近战怪物普攻技能的伤害计算公式
function CommonFun.calcDamage_17(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  ---------------------------------------------------------------------------------------------------------------普攻-强效
  local Num1 = srcUser:GetRunePoint(11022)
  local Num2 = srcUser:GetRunePoint(11023)
  local Num3 = srcUser:GetRunePoint(11024)
  local Num4 = srcUser:GetRunePoint(12004)
  local Num5 = srcUser:GetRunePoint(12011)
  local RuneDamage = (Num1 + Num2 + Num3 + Num4 + Num5)*0.03
  local AtkPer1 = srcUser:GetProperty("AtkPer")
  local AtkPer  = AtkPer1 + RuneDamage

  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end   

  local Agi = srcUser:GetProperty("Agi")
  local WeaponType =srcUser:GetEquipedWeaponType()
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  local skilllv_2 = srcUser:GetLernedSkillLevel(damageParam.skill2_id)
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local StateEffect = targetUser:GetProperty("StateEffect")
  local bits=CommonFun.getBits(StateEffect)
  local Weapon=srcUser:GetEquipedID(7)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local SkillRealDam=0
  if skilllv_1<=5 then
     SkillRealDam=skilllv_1*20
  else   
     SkillRealDam=100+math.floor(Agi/5)*((skilllv_1-5)*0.5+0.5)
  end


  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(1-RefineDamReduc)*(1+DamIncrease)+SkillRealDam-Vit2*(1+VitPer2)
  
  ---------------------------------------------------------------------------------------------------------------------------------------------------------------判断二刀连击触发成功造成双倍伤害
  if  CommonFun.IsInRate(skilllv_2*5, srcUser:GetRandom())  then
        return A*2, CommonFun.DamageType.ErLianJi
  end 
 --------------------------------------------------------------------------------------------------------装备名刀不知火并且触发目标眩晕时额外造成50%伤害
  if bits[CommonFun.StateEffect.Dizzy]==1 and (Weapon == 40322 or Weapon == 140322) then
        return A*1.5
  end

  if 1 >= A then
      return 1
  end
   
  return A

end

-- refactory end
------------------------------------------------------------------------------------------------------------技能公式重构
-----------------------------------------------------------------------------------------------------------------近战战士系普攻及技能伤害计算公式(已改)
function CommonFun.calcDamage_18(srcUser, targetUser, params, damageParam, logger)
  local Str1 = srcUser:GetProperty("Str")
  --------------------------------------------------------------------------------------------------------商人星盘加成的力量转换的普攻加成率提升百分比
  local Num1 = srcUser:GetRunePoint(62080)
  local RuneDamage = Num1*0.01 + 1
  local Str = Str1*RuneDamage
  ---------------------------------------
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  ------------------------------------------------------普通攻击力
  local NormalAtk = srcUser:GetProperty("NormalAtk")
        NormalAtk = NormalAtk + 5*Str
  -------------------------------------------
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local WeaponType =srcUser:GetEquipedWeaponType()
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk   = Str1*2 + math.floor(Str1*Str1/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local BaseAtk1  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)

  local AtkFinal = ((Atk-BaseAtk+NormalAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk1)*raceparam*bossparam*bossparam2
  --print("NormalAtk="..NormalAtk,"AtkFinal="..AtkFinal)
  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
  ---------------------------------------------------------------------------------------------------------------------------------------------------------------判断二刀连击触发成功造成双倍伤害
  ------------------------------------------------------------------------------------------------------------二刀连击
  local skilllv_1 = srcUser:GetLernedSkillLevel(179)

  if WeaponType==250 and CommonFun.IsInRate(skilllv_1*5, srcUser:GetRandom())  then
        return A*2, CommonFun.DamageType.ErLianJi
  end 

   
   if 1 >= A then
         return 1
   end
   
   return A
end



----------------------------------------------------------------------------------------------------------------近战战士系普攻技能的伤害计算公式
function CommonFun.calcDamage_19(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  ---------------------------------------------------------------------------------------------------------------普攻-强效
  local Num1 = srcUser:GetRunePoint(11022)
  local Num2 = srcUser:GetRunePoint(11023)
  local Num3 = srcUser:GetRunePoint(11024)
  local Num4 = srcUser:GetRunePoint(12004)
  local Num5 = srcUser:GetRunePoint(12011)
  local RuneDamage = (Num1 + Num2 + Num3 + Num4 + Num5)*0.03
  local AtkPer1 = srcUser:GetProperty("AtkPer")
  local AtkPer  = AtkPer1 + RuneDamage
  ------------------------------------------------------普通攻击力
  local NormalAtk = srcUser:GetProperty("NormalAtk")
        NormalAtk = NormalAtk + 5*Str
  -------------------------------------------
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end   

  local Agi = srcUser:GetProperty("Agi")
  local WeaponType =srcUser:GetEquipedWeaponType()
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  local skilllv_2 = srcUser:GetLernedSkillLevel(damageParam.skill2_id)
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local StateEffect = targetUser:GetProperty("StateEffect")
  local bits=CommonFun.getBits(StateEffect)
  local Weapon=srcUser:GetEquipedID(7)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
  ---------------------------------灵气剑
  local SkillRealDam=0
  if skilllv_1<=5 then
      SkillRealDam=skilllv_1*20
  elseif skilllv_1>5 and skilllv_1<=10 then
      SkillRealDam=100+math.floor(Agi/5)*((skilllv_1-5)*0.5+0.5)
  else 
      SkillRealDam=100+(skilllv_1-10)*20+math.floor(Agi/5)*3+Luk*2
  end
  ---------------------------剑速增加
  local AtkSpdAdd = 0
  local skilllv_3 = srcUser:GetLernedSkillLevel(22)
  if srcUser:HasBuffID(80082) and skilllv_3>10 then
        AtkSpdAdd = (skilllv_3-10)*120
  end

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk+AtkSpdAdd+NormalAtk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  -------------------------------------------------------------------神圣复仇者
  local Weapon=srcUser:GetEquipedID(7)
  local RefineLv=srcUser:GetEquipedRefineLv(7)
  local HolyEquip = 1
  if Weapon==40319 or Weapon==140319 then
      HolyEquip = 1+0.05*RefineLv
  end   
  -------------------------------------------------------------------天谴
  if (Weapon==40360 or Weapon==140360) then
      HolyEquip = 1+0.05*RefineLv 
  end  

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine+SkillRealDam)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*HolyEquip
  
  ---------------------------------------------------------------------------------------------------------------------------------------------------------------判断二刀连击触发成功造成双倍伤害
  if WeaponType==250 and CommonFun.IsInRate(skilllv_2*5, srcUser:GetRandom())  then
        return A*2, CommonFun.DamageType.ErLianJi
  end 
 --------------------------------------------------------------------------------------------------------装备名刀不知火并且触发目标眩晕时额外造成50%伤害
  if bits[CommonFun.StateEffect.Dizzy]==1 and (Weapon == 40322 or Weapon == 140322) then
        return A*1.5
  end

  if 1 >= A then
      return 1
  end
   
  return A

end

-----------------------------------------------------------------------------------------------------------------近战战士系普攻及技能伤害计算公式(已改)
function CommonFun.calcDamage_20(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
   
   if 1 >= A then
         return 1
   end
   
   return A
end

------------------------------------------------------------------------------------------------------------------远程物理伤害计算公式(已改)
function CommonFun.calcDamage_21(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = targetUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------元素箭额外增加物理伤害      
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  local skilllv_1 = srcUser:GetLernedSkillLevel(127)
  local atk_add = 0
  if skilllv_1 >10 and (skillID == 300 or skillID==113) then
    atk_add = Dex * ((skilllv_1-10) * 0.5)
  end
  ------------------------------------------普攻攻击力
  local NormalAtk = 0
  if skillID == 300 or skillID==113 then
      local NormalAtkAttr = srcUser:GetProperty("NormalAtk")
      NormalAtk = NormalAtkAttr + 3*Dex
  end

  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5) 
  local AtkFinal = ((Atk-BaseAtk+NormalAtk+atk_add)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  -----------------------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ------------------------------------------------------------------------巅峰等级 苍鹰之眼
  local targetid = targetUser:GetGuid()
  local distance = srcUser:GetDistance(targetid)
  local skilllv_1 = srcUser:GetLernedSkillLevel(133)
  local DisDam= 1
  if skilllv_1>10 then 
      DisDam = 1 + distance/7.5*(skilllv_1-10)*0.06
  end
  ---------------------------重伤箭
  local Injured = 1
  if bits[CommonFun.AttrEffect.NormalSkillDam]==1 then
      Injured = 1.3
  end    
  local Num1 = srcUser:GetRunePoint(43030)
  local RuneDamage = Num1*0.01+1

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer)*(1-RefineDamReduc)*(1+DamIncrease-LongRangeDamReduc2)-Vit2*(1+VitPer2)
  
  if skillID == 300 or skillID==113 then 
        A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer)*(1-RefineDamReduc)*(1+DamIncrease-LongRangeDamReduc2)-Vit2*(1+VitPer2))*DisDam*Injured*RuneDamage
  end

   if 1 >= A then
         return 1
   end
   --print("DisDam="..DisDam,"Injured="..Injured,"NormalAtk="..NormalAtk,"A="..A)
   return A

end

------------------------------------------------------------------------------------------------------------------远程物理老鹰技能伤害计算公式(已改)
function CommonFun.calcDamage_22(srcUser, targetUser, params, damageParam, logger)
  local Dex = srcUser:GetProperty("Dex")
  local Int = srcUser:GetProperty("Int")
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  local skilllv_2 = srcUser:GetLernedSkillLevel(damageParam.skill2_id)
  local count=params.hitedCount
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")---老鹰伤害受精炼减伤

  local AttrEffect = srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)

  local damChangePer = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1
  local damChangePer2 = damageParam.damChangePer2
  local damChangePer3 = damageParam.damChangePer3

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ---------------------------------------------------------------------技能闪电冲击部分伤害
  local skilllv_1_value1 = 0
  local skilllv_1_value2 = 0
  ---------------------------------------------------------------------该部分为闪电冲击技能基础数值增伤部分,当技能未学习时没有对应伤害
  if skilllv_1<=0 then
     skilllv_1_value1=0
  else
     skilllv_1_value1=(skilllv_1*damChangePer+damChangePer1)
  end   

  ---------------------------------------------------------------------该部分为闪电冲击连击数增加的倍率,考虑到可能有玩家二转没有学习闪电冲击,但三转学习猎杀突击,不做判断会出现伤害为0的情况
  if skilllv_1<=0 then
     skilllv_1_value2 = 1
  elseif skilllv_1>0 and skilllv_1<=10 then
     skilllv_1_value2 = (skilllv_1*0.5+0.5)
  elseif skilllv_1>10 then
     skilllv_1_value2 = 5.5
  end
  ----------------------------------------------------------------------驯兽术10级的时候驯兽术伤害增加20%
  ---------------------------------------------------------------------猎鹰的范围技能当出现范围数小于1的时候按1个处理
  if count<=1 then
     count=1
  end 
  ---------------------------------------------------------------------星盘驯兽术
  local Num1=srcUser:GetRunePoint(42006)
  local Num2=srcUser:GetRunePoint(42007)
  local Num3=srcUser:GetRunePoint(42008)
  local Num4=srcUser:GetRunePoint(42009)
  local Num5=srcUser:GetRunePoint(42010)
  local RuneDamage=Num1*0.05+Num2*0.1+Num3*0.1+Num4*0.05+Num5*0.05+1
  local XuShouShuDam = skilllv_2*damChangePer2*RuneDamage
  ---------------------------------------------------------------------星盘精炼物攻影响猎鹰伤害,星盘闪电冲击
  local Refine = srcUser:GetProperty("Refine")
  local RefineLv=srcUser:GetEquipedRefineLv(7)
  local Num6=srcUser:GetRunePoint(42011)
  local Num7=srcUser:GetRunePoint(42012)
  local RuneDamage2=Num6*Refine
  local RuneDamage3=Num7*RefineLv*0.01+1
  ---------------------------------------------------------------------星盘闪电冲击连击概率
  local Num8=srcUser:GetRunePoint(42013)
  local Num9=srcUser:GetRunePoint(42014)
  local Num10=srcUser:GetRunePoint(42015)
  local RuneRate=Num8*10+Num9*10+Num10*30
  local RuneDamage4=1
  if CommonFun.IsInRate(RuneRate, srcUser:GetRandom()) then
        RuneDamage4=2
  end
  ---------------------------------------------------------------------星盘猎鹰对眩晕目标伤害加成
  local StateEffect = targetUser:GetProperty("StateEffect")
  local bits3=CommonFun.getBits(StateEffect)
  local Num11 = srcUser:GetRunePoint(42080)
  local RuneDamage5=1
  if bits3[CommonFun.StateEffect.Dizzy] ==1 then
        RuneDamage5=1+Num11*0.02
  end
  ---------------------------------------------------------------------诅咒之弓IV+山地游侠装IV
  local  taozhuang=1
  if srcUser:HasBuffID(90001463) and srcUser:HasBuffID(90001473)  then 
      taozhuang=1.15
  end
  ---------------------------------------------------------------------山地游侠装[第八档]
  local IntSD = srcUser:GetProperty("Int")
  if IntSD >= 180 then 
      taozhuang = taozhuang + 0.15
  end
  ---------------------------------------------------------------------痛苦折磨
  if srcUser:HasBuffID(41800)  then 
      taozhuang=taozhuang + 0.2
  end



  local A=((((skilllv_1_value1+XuShouShuDam+math.floor(Int/2)*2+math.floor(Dex/10)*2)*skilllv_1_value2)*damChangePer3*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2+RuneDamage2)*RuneDamage3*RuneDamage4*RuneDamage5+(Atk*(1+AtkPer)+Refine)*taozhuang*skilllv_1*0.05)*(1-RefineDamReduc)
  -------------------------------------------------------------------------------------------------------------诅咒之弓 或 痛苦折磨
  local Weapon=srcUser:GetEquipedID(7)
  local B = 1

  if (Weapon==41233 or Weapon==141233 or Weapon==41256 or Weapon==141256) then
     B = 2
  end 

  -------------------------------------------------------------------------诅咒之弓[第六档]
  if srcUser:HasBuffID(90001465) then 
     B = B +0.3
  end 

  ------------------------------------------------------------------------痛苦折磨
  if srcUser:HasBuffID(41800) then 
     B = B +0.3
  end 

  

  if      bits[CommonFun.AttrEffect.XuShouDam]==1 and skilllv_2==10 and bits2[CommonFun.AttrEffect.Shandiyouxiazhuang]==1 then
               A=(((((skilllv_1_value1+XuShouShuDam*1.2) + math.floor(Int/2)*2*4 + math.floor(Dex/10)*2)*skilllv_1_value2)*damChangePer3*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2+RuneDamage2)*RuneDamage3*RuneDamage4*RuneDamage5+(Atk*(1+AtkPer)+Refine)*taozhuang*skilllv_1*0.05)*(1-RefineDamReduc)
  elseif  bits[CommonFun.AttrEffect.XuShouDam]==1 and skilllv_2==10 then
               A=(((((skilllv_1_value1+XuShouShuDam*1.2) + math.floor(Int/2)*2 + math.floor(Dex/10)*2)*skilllv_1_value2)*damChangePer3*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2+RuneDamage2)*RuneDamage3*RuneDamage4*RuneDamage5+(Atk*(1+AtkPer)+Refine)*taozhuang*skilllv_1*0.05)*(1-RefineDamReduc)
  elseif  bits2[CommonFun.AttrEffect.Shandiyouxiazhuang]==1 then
               A=(((((skilllv_1_value1+XuShouShuDam)*B + math.floor(Int/2)*2*4+math.floor(Dex/10)*2)*skilllv_1_value2)*damChangePer3*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2+RuneDamage2)*RuneDamage3*RuneDamage4*RuneDamage5+(Atk*(1+AtkPer)+Refine)*taozhuang*skilllv_1*0.05)*(1-RefineDamReduc)   
  elseif  skilllv_2==10 then
               A=(((((skilllv_1_value1+XuShouShuDam)*B + math.floor(Int/2)*2 + math.floor(Dex/10)*2)*skilllv_1_value2)*damChangePer3*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2+RuneDamage2)*RuneDamage3*RuneDamage4*RuneDamage5+(Atk*(1+AtkPer)+Refine)*taozhuang*skilllv_1*0.05)*(1-RefineDamReduc)
  end
 -- print("A="..A,"RuneDamage="..RuneDamage,"RuneDamage3="..RuneDamage3,"RuneDamage4="..RuneDamage4)
  ----------------------------------------------------------------------------------狼突击
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  if skillID == 1253 or skillID == 1255 then
      local skilllv_wolf = srcUser:GetLernedSkillLevel(1242)-------狼牙
      ------------------------------------------------星盘
      local Num_wolf = srcUser:GetRunePoint(44020)
      local Num_all = srcUser:GetRunePoint(44030)
      local skilllv_1 = srcUser:GetLernedSkillLevel(128)---猎杀突击
      local skilllv_2 = srcUser:GetLernedSkillLevel(135)---猎鹰突击

      A = A * (1+skilllv_wolf*0.015)*(1+Num_wolf*0.04)*(1+(skilllv_1+skilllv_2)*Num_all*0.005)
     -- print("A="..A,"skilllv_wolf="..skilllv_wolf,"Num_wolf="..Num_wolf,"skilllv_1="..skilllv_1,"skilllv_2="..skilllv_2,"Num_all="..Num_all)
  end

  local skilllv_hezou= srcUser:GetBuffLevel(118830) ---------------与狼共舞合奏 

      A = A*(skilllv_hezou*0.06+1)

  if 1 >= A then
    return 1
  end
    
    return A
end

------------------------------------------------------------------------------------------------------------------远程物理陷阱技能（冰霜，爆散）伤害计算公式(已改)
function CommonFun.calcDamage_23(srcUser, targetUser, params, damageParam, logger)
  local BaseLv = srcUser.BaseLv
  local Dex = srcUser:GetProperty("Dex")
  local Int = srcUser:GetProperty("Int")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
 
  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
   ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  local skilllv_2 = srcUser:GetLernedSkillLevel(damageParam.skill2_id)

  local AttrEffect = srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)

  local damChangePer = damageParam.damChangePer

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  -------------------------------------------------------------------------------------------------------------------星盘冰霜爆散
  local StateEffect = targetUser:GetProperty("StateEffect")
  local bits2=CommonFun.getBits(StateEffect)
  local Num6 = srcUser:GetRunePoint(42070)
  local RuneDamage2=1
  if bits2[CommonFun.StateEffect.Sleep] ==1 then
        RuneDamage2=1+Num6*0.05
  end
  -------------------------------------------装备升级  星尘外套+月亮胸针
  local suit = 1
  if srcUser:HasBuffID(90000773) and srcUser:HasBuffID(90001005) then
      suit = 1.1
  end

    -------------------------------------------星尘外套[第八档]
  local RefineLv2=srcUser:GetEquipedRefineLv(2)
  if srcUser:HasBuffID(90000777) then 
        if (RefineLv2>=10 and RefineLv2<15) then 
        suit =suit+(RefineLv2-10)* 0.02 
         elseif RefineLv2 ==15 then
         suit =suit+(RefineLv2-10)* 0.02 + 0.05  
        end
    end
  -------------------------------------------露娜弓[第八档]
  local RefineLv7=srcUser:GetEquipedRefineLv(7)
    if srcUser:HasBuffID(90000999) then 
        if (RefineLv7>=10 and RefineLv7<15) then 
        suit =suit+0.08
        elseif RefineLv7 ==15 then
         suit =suit+0.08+0.12
        end
    end
  -------------------------------------------月光女神
    if srcUser:HasBuffID(41812) then 
      if (RefineLv7>=5 and RefineLv7<10) then 
           suit =suit+0.05
      elseif(RefineLv7>=10 and RefineLv7<15) then 
           suit =suit+0.05+0.1
      elseif RefineLv7 ==15 then
           suit =suit+0.05+0.1+0.15
      end
    end
----------------------------------------------------------------月亮胸针[第十档]
  
  local RefineLv5=srcUser:GetEquipedRefineLv(5)
  local RefineLv6=srcUser:GetEquipedRefineLv(6)
  local Ring1=srcUser:GetEquipedID(5)
  local Ring2=srcUser:GetEquipedID(6)

  local a = 0
  local b = 0
  if srcUser:HasBuffID(90001009) and (Ring1==44006 or Ring1==144006)  then
      a = RefineLv5*0.01
  end
  if srcUser:HasBuffID(90001009) and (Ring1==44006 or Ring1==144006)  then
      b = RefineLv6*0.01
  end
  suit = suit + a + b  


  -------------------------------------------炽天使精炼
  local Angel = 1
  if srcUser:HasBuffID(90001014) then 
      local RefineLv=srcUser:GetEquipedRefineLv(7)
      Angel = 1 + 0.02*RefineLv
  end
  -------------------------------------------------------------------------------------------------------------------星盘陷阱研究
  local Num7 = srcUser:GetRunePoint(42060)
  local RuneDamage3 = 1+Num7*0.03*skilllv_1
  ------------------------------------------------------三转器械专家
  local skilllv_trap = srcUser:GetLernedSkillLevel(1248)
  local trap = 1 + skilllv_trap*0.02

  local A = (Dex*(3+BaseLv/100)*(1+Int/35)*damChangePer+skilllv_1*20*RuneDamage3)*DefReduc*(1+MDamIncrease)*(1-MDamReduc2)*(1-RefineMDamReduc)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2*raceparam*bossparam*RuneDamage2*suit*Angel*trap

  if 1 >= A then
    return 1
  end
  ------------------------------------------------------------------------------------手动引爆时伤害额外增加
  local Num1 = srcUser:GetRunePoint(42031)--------------------------------------------星盘引爆伤害
  local Num2 = srcUser:GetRunePoint(42032)
  local Num3 = srcUser:GetRunePoint(42033)
  local Num4 = srcUser:GetRunePoint(42034)
  local Num5 = srcUser:GetRunePoint(42035)
  local RuneDamage = Num1*0.1+Num2*0.05+Num3*0.05+Num4*0.1+Num5*0.05+1

  if bits[CommonFun.AttrEffect.TriggerTrapMark]==1 then
      return A*(1+skilllv_2*0.1)*RuneDamage
  end
      
      return A     
end

-----------------------------------------------------------------------------------------------------------------乘胜追击技能伤害计算公式(已改)
function CommonFun.calcDamage_24(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2) + Luk*5 + math.floor(Luk*Luk/100)*5 + Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
   
   if 1 >= A then
         return 1
   end
   
   return A
end

-----------------------------------------------------------------------------------------------------------------近战十字军系普攻伤害计算公式(已改)
function CommonFun.calcDamage_25(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  ------------------------------------------------------普通攻击力
  local NormalAtk = srcUser:GetProperty("NormalAtk")
        NormalAtk = NormalAtk + 5*Str
  ---------------------------------------------------------------------------------------------------------------普攻-强效
  local Num1 = srcUser:GetRunePoint(70010)
  local RuneDamage = Num1*0.03
  local AtkPer1 = srcUser:GetProperty("AtkPer")
  local AtkPer  = AtkPer1 + RuneDamage

  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk+NormalAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  
  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  -------------------------------------------------------------------神圣复仇者
  local Weapon=srcUser:GetEquipedID(7)
  local RefineLv=srcUser:GetEquipedRefineLv(7)
  local HolyEquip = 1
  if Weapon==40319 or Weapon==140319 then
      HolyEquip = 1+0.05*RefineLv
  end
  -------------------------------------------------------------------天谴
  if (Weapon==40360 or Weapon==140360) then
      HolyEquip = 1+0.05*RefineLv 
  end  


  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*HolyEquip
   -----------------------------------------------------舍命攻击
   if srcUser:HasBuffID(115090) or srcUser:HasBuffID(115091) then
      elementparam =5
    local Hp = srcUser:GetProperty("Hp")
    local MaxHp = srcUser:GetProperty("MaxHp")
    local skilllv_1 = srcUser:GetLernedSkillLevel(361)

    local mapid,maptype = srcUser:GetMapInfo()-----------------获取所在地图
    local pvpRatio = 1
    ------------------------maptype 1 :野外 2：pvp 3:其他普通副本 4:gvg 
    if maptype==2 or maptype==4 then
        pvpRatio = 0.25
    end    
    ----------------舍命攻击 巅峰等级
    local dam = 0
    if skilllv_1>5 then 
      dam = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(skilllv_1-5)*0.3*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*HolyEquip
    end

    if Hp>MaxHp*0.09 then
        A = MaxHp*0.09*(1+math.max((skilllv_1-1)*0.1,0.4))*pvpRatio*(1-RefineDamReduc) + dam
    end 
   end

  -----------------------------------------------------------------------------------------------------------二刀连击
  local skilllv_1 = srcUser:GetLernedSkillLevel(179)
  local WeaponType =srcUser:GetEquipedWeaponType()
  
  if WeaponType==250 and CommonFun.IsInRate(skilllv_1*5, srcUser:GetRandom())  then
        return A*2, CommonFun.DamageType.ErLianJi
  end 


   if 1 >= A then
         return 1
   end

   return A
end

-----------------------------------------------------------------------------------------------------------------近战十字军系技能伤害计算公式(已改)
function CommonFun.calcDamage_26(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)

   if 1 >= A then
         return 1
   end

   return A
end

-----------------------------------------------------------------------------------------------------------------武僧普攻伤害计算公式
function CommonFun.calcDamage_27(srcUser, targetUser, params, damageParam, logger)
  local Str1 = srcUser:GetProperty("Str")
  --------------------------------------------------------------------------------------------------------星盘加成的力量转换的普攻加成率提升百分比
  local Num1 = srcUser:GetRunePoint(120010)
  local RuneDamage = Num1*0.05 + 1
  local Str = Str1*RuneDamage
  --------------------------------
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local Int = srcUser:GetProperty("Int")
  if srcUser:HasBuffID(100510) then
      Atk = Atk + 5*Int
  end
  local AtkPer1 = srcUser:GetProperty("AtkPer")
  -------------------------------------------------------------------------------------星盘物理攻击转换加成
  local Num2 = srcUser:GetRunePoint(120020)
  local RuneDamage2 = Num2*0.03
  local AtkPer = AtkPer1 + RuneDamage2
  ------------------------------------------------------普通攻击力
  local NormalAtk = srcUser:GetProperty("NormalAtk")
        NormalAtk = NormalAtk + 5*Str
  ------------------------------------
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str1*2 + math.floor(Str1*Str1/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local BaseAtk1 = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk+NormalAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk1)*raceparam*bossparam*bossparam2
  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
   
  -----------------------------------------------------------------------------------------------------------二刀连击
  local WeaponType =srcUser:GetEquipedWeaponType()
  local skilllv_1 = srcUser:GetLernedSkillLevel(179)

  if WeaponType==250 and CommonFun.IsInRate(skilllv_1*5, srcUser:GetRandom())  then
        return A*2, CommonFun.DamageType.ErLianJi
  end 

   if 1 >= A then
         return 1
   end
   
   return A
end

-----------------------------------------------------------------------------------------------------------------武僧技能伤害计算公式
function CommonFun.calcDamage_28(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

-------------------------------------------------------------------------升龙拳套
  local Num2=1
  if srcUser:HasBuffID(90001513) then
     Num2=1.3 
   end
  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*Num2
   

   if 1 >= A then
         return 1
   end
   
   return A
end
--------------------------------------------------------------------------------------------------------------------------法师魔法伤害计算公式(已改)
function CommonFun.calcDamage_30(srcUser, targetUser, params, damageParam, logger)
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")

  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2
  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  
  if 1 >= A then
    return 1
  end
 
  return A

end

--------------------------------------------------------------------------------------------------------------------------法师魔法伤害计算公式((为了冰箭术火箭术，神圣之击前期技能专用)
function CommonFun.calcDamage_31(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)  
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
  ---------------------------------------------星盘
  local Num1 = srcUser:GetRunePoint(22160)
  local Num2 = srcUser:GetRunePoint(22161)
  local RuneDamage = (Num1+Num2)*0.1+1
---------------------------------------------贤者之书＋灵犀宝珠
  local taozhuang1 = 1
  if srcUser:HasBuffID(91000470) then 
    taozhuang1 = 1.15
  end

  local A = (((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))+damChangePer1)*RuneDamage * taozhuang1
  
  if 1 >= A then
    return 1
  end
 
  return A

end

--------------------------------------------------------------------------------------------------------------------------法师范围技能魔法伤害计算公式(已改)
function CommonFun.calcDamage_32(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine  = srcUser:GetProperty("MRefine")
  local RangeDam = srcUser:GetProperty("RangeDam")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)   
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*(1 + RangeDam)
  
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  ----------------------------------------------------------暴风雪
  if skillID==81 then
        if srcUser:HasBuffID(52170) and srcUser:HasBuffID(81000040) then --------------冰暴骑士卡片增加暴风雪伤害
          A =A *1.2
        end
  end

  if 1 >= A then
    return 1
  end
     
     return A

end

--------------------------------------------------------------------------------------------------------------------------神圣之击技能专用((为了冰箭术火箭术，神圣之击前期技能专用)
function CommonFun.calcDamage_33(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local Luk = srcUser:GetProperty("Luk")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")
  local skilllv_1 = srcUser:GetLernedSkillLevel(235)

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)   
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
  -------------------------------------------------------------------------------------------------------------复仇女神效果
  local Weapon=srcUser:GetEquipedID(7)
  local B = 0
 ------------------------------------------------------------------------厄利尼厄斯之杖
  if (Weapon==41521 or Weapon==141521 or Weapon==41568 or Weapon==141568) then
     B = Luk*50
  end   

  local WeaponRefineLv=srcUser:GetEquipedRefineLv(7)
  if srcUser:HasBuffID(90001413) or  srcUser:HasBuffID(41980) then
    if WeaponRefineLv >=10 then
      B = B*2
    end
  end   

  local A = ((((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer+ B*MDefReduc*(1-MDamReduc2)*(1-RefineMDamReduc))*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))+damChangePer1)*(1+skilllv_1*0.1)
    
  if 1 >= A then
    return 1
  end
 
  return A

end

--------------------------------------------------------------------------------------------------------------------------火球术技能伤害计算公式单独修改
function CommonFun.calcDamage_34(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer1 = srcUser:GetProperty("MAtkPer")
  ------------------------------------------------------------------------------------------星盘额外加成
  local Num1 = srcUser:GetRunePoint(21007)
  local Num2 = srcUser:GetRunePoint(22001)
  local Num3 = srcUser:GetRunePoint(22002)
  local Num4 = srcUser:GetRunePoint(22005)
  local RuneDamage = (Num1 + Num2 + Num3 + Num4)*0.05
  local MAtkPer  =  MAtkPer1 + RuneDamage
  -------------------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine  = srcUser:GetProperty("MRefine")
  local RangeDam = srcUser:GetProperty("RangeDam")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)   
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2


  --迪塔勒泰晤勒斯卡片[存储]
  local DamageRatio = 1
  if srcUser:HasBuffID(80001450) then
    DamageRatio = 1.15
  end

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*(1 + RangeDam)*DamageRatio
  
  if 1 >= A then
    return 1
  end
     
     return A

end
--------------------------------------------------------------------------------------------------------------------------火箭术单独计算公式
function CommonFun.calcDamage_35(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end

  local Num1 = srcUser:GetRunePoint(22006)
  local RuneRate = 0

  if Num1 > 0 then
    RuneRate = 8
  end

  local RuneDamage = Num1*0.1 +1

  local Num2 = srcUser:GetRunePoint(22160)
  local Num3 = srcUser:GetRunePoint(22161)
  local RuneDamage1 = (Num2+Num3)*0.1+1
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)  
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
 ---------------------------------------------贤者之书＋灵犀宝珠
  local taozhuang1 = 1
  if srcUser:HasBuffID(91000470) then 
    taozhuang1 = 1.15
  end

  local A = (((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))+damChangePer1)*RuneDamage1*taozhuang1
  
  if CommonFun.IsInRate(RuneRate, srcUser:GetRandom()) then 
     return A*RuneDamage
  end   

  if 1 >= A then
    return 1
  end
 
  return A

end


--------------------------------------------------------------------------------------------------------------------------只有法师普攻才会使用的伤害公式
function CommonFun.calcDamage_36(srcUser, targetUser, params, damageParam, logger)
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  ------------------------------------------------------普通攻击力
  local NormalAtk = srcUser:GetProperty("NormalAtk")
        NormalAtk = NormalAtk + 3*Int
  ------------------------------------
  local MAtkPer1 = srcUser:GetProperty("MAtkPer")
  ---------------------------------------------------------------------------------星盘额外增加的法师普攻享受额外攻击加成
  local Num1 = srcUser:GetRunePoint(22017)
  local Num2 = srcUser:GetRunePoint(22022)
  local Num3 = srcUser:GetRunePoint(22023)
  local RuneDamage3 = (Num1 + Num2 + Num3)*0.05 
  local MAtkPer = MAtkPer1 + RuneDamage3
  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
 
 ------------------------------------------------------------------------------------星盘额外增加法师普攻暴击效果
  local Num11 = srcUser:GetRunePoint(21005)
  local Num12 = srcUser:GetRunePoint(21008)
  local Num13 = srcUser:GetRunePoint(21009)
  local Num14 = srcUser:GetRunePoint(21011)
  local Num15 = srcUser:GetRunePoint(21017)
  local Num16 = srcUser:GetRunePoint(22011)
  local Num17 = srcUser:GetRunePoint(22026)
  local Num18 = srcUser:GetRunePoint(22029)
  ----------------------------------------------------------------升级装备 丝质外袍 暴击伤害
  local Num19 = srcUser:GetBuffLayer(90000952)
  local Num20 = srcUser:GetBuffLayer(90000953)
  local Num21 = srcUser:GetBuffLayer(90000954)
  ----------------------------------------------------------------升级装备 防水靴 暴击概率
  local Num22 = srcUser:GetBuffLayer(90000942)
  local Num23 = srcUser:GetBuffLayer(90000944)  

  local RuneDamage  = (Num11 + Num12 + Num13 + Num14 + Num15 + Num16 + Num17 + Num18)*0.1 + 1 + 0.03*Num19 + 0.03*Num20 + 0.04*Num21
  local RuneDamage1 =  0
  if (Num11 + Num12 + Num13 + Num14 + Num15 + Num16 + Num17 + Num18 + Num22 + Num23)>0 then 
     RuneDamage1 = 5 + Luk/3 + Num22*5 + Num23*5
  end   

  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk+NormalAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
    -------------------------------------------------四种元素伤害分别判断 
  local srcAtkElement1  = 1
    local elementInc1 = 0
    local elementRed1 = 0

    local targetDefElement = targetUser:GetProperty("DefAttr")

    
    if nil == targetDefElement then
        logger.error(string.format("%s targetDefElement is nil", targetUser.name))
        return 0
    end
    if nil == CommonFun.NatureProps[targetDefElement] then
        logger.error(string.format("%s CommonFun.NatureProps[%s] is nil", srcUser.name, tostring(targetDefElement)))
        return 0
    end

    if nil == CommonFun.NatureProps[srcAtkElement1] then
        logger.error(string.format("CommonFun.NatureProps[%s] is nil", tostring(srcAtkElement1)))
        return 0
    end

    elementInc1 = srcUser:GetProperty(CommonFun.NatureProps[targetDefElement][1])
    elementRed1 = targetUser:GetProperty(CommonFun.NatureProps[srcAtkElement1][2])
    elementAtk1 = srcUser:GetProperty(CommonFun.NatureProps[srcAtkElement1][3])

    if nil==elementAtk1 then
        elementAtk1 = 0
    end
    local result1 = 1+elementAtk1-elementRed1

    if result1 <= 0.1 then
        result1 = 0.1
    end

    local srcAtkElement2   = 2
    local elementInc2 = 0
    local elementRed2 = 0

    local targetDefElement = targetUser:GetProperty("DefAttr")

    
    if nil == targetDefElement then
        logger.error(string.format("%s targetDefElement is nil", targetUser.name))
        return 0
    end
    if nil == CommonFun.NatureProps[targetDefElement] then
        logger.error(string.format("%s CommonFun.NatureProps[%s] is nil", srcUser.name, tostring(targetDefElement)))
        return 0
    end

    if nil == CommonFun.NatureProps[srcAtkElement2] then
        logger.error(string.format("CommonFun.NatureProps[%s] is nil", tostring(srcAtkElement2)))
        return 0
    end

    elementInc2 = srcUser:GetProperty(CommonFun.NatureProps[targetDefElement][1])
    elementRed2 = targetUser:GetProperty(CommonFun.NatureProps[srcAtkElement2][2])
    elementAtk2 = srcUser:GetProperty(CommonFun.NatureProps[srcAtkElement2][3])

    if nil==elementAtk2 then
        elementAtk2 = 0
    end
    local result2 = 1+elementAtk2-elementRed2

    if result2 <= 0.1 then
        result2 = 0.1
    end

  local srcAtkElement3   = 3
    local elementInc3 = 0
    local elementRed3 = 0

    local targetDefElement = targetUser:GetProperty("DefAttr")

    
    if nil == targetDefElement then
        logger.error(string.format("%s targetDefElement is nil", targetUser.name))
        return 0
    end
    if nil == CommonFun.NatureProps[targetDefElement] then
        logger.error(string.format("%s CommonFun.NatureProps[%s] is nil", srcUser.name, tostring(targetDefElement)))
        return 0
    end

    if nil == CommonFun.NatureProps[srcAtkElement3] then
        logger.error(string.format("CommonFun.NatureProps[%s] is nil", tostring(srcAtkElement3)))
        return 0
    end

    elementInc3 = srcUser:GetProperty(CommonFun.NatureProps[targetDefElement][1])
    elementRed3 = targetUser:GetProperty(CommonFun.NatureProps[srcAtkElement3][2])
    elementAtk3 = srcUser:GetProperty(CommonFun.NatureProps[srcAtkElement3][3])

    if nil==elementAtk3 then
        elementAtk3 = 0
    end
    local result3 = 1+elementAtk3-elementRed3

    if result3 <= 0.1 then
        result3 = 0.1
    end

  local srcAtkElement4   = 4
    local elementInc4 = 0
    local elementRed4 = 0

    local targetDefElement = targetUser:GetProperty("DefAttr")

    
    if nil == targetDefElement then
        logger.error(string.format("%s targetDefElement is nil", targetUser.name))
        return 0
    end
    if nil == CommonFun.NatureProps[targetDefElement] then
        logger.error(string.format("%s CommonFun.NatureProps[%s] is nil", srcUser.name, tostring(targetDefElement)))
        return 0
    end

    if nil == CommonFun.NatureProps[srcAtkElement4] then
        logger.error(string.format("CommonFun.NatureProps[%s] is nil", tostring(srcAtkElement4)))
        return 0
    end

    elementInc4 = srcUser:GetProperty(CommonFun.NatureProps[targetDefElement][1])
    elementRed4 = targetUser:GetProperty(CommonFun.NatureProps[srcAtkElement4][2])
    elementAtk4 = srcUser:GetProperty(CommonFun.NatureProps[srcAtkElement4][3])

    if nil==elementAtk4 then
        elementAtk4 = 0
    end
    local result4 = 1+elementAtk4-elementRed4

    if result4 <= 0.1 then
        result4 = 0.1
    end
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  
  local elementparam21 = result1
  local elementparam22 = result2
  local elementparam23 = result3
  local elementparam24 = result4


  local A1 = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement1][targetDefElement]*elementparam21-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  local A2 = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement2][targetDefElement]*elementparam22-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  local A3 = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement3][targetDefElement]*elementparam23-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  local A4 = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement4][targetDefElement]*elementparam24-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))

    ----------------------------------------------------------------------------元素强化
  local skilllv_1 = srcUser:GetLernedSkillLevel(1163)
  local A5=0 
  if skilllv_1 >=6 then
    local fireball=0
    local waterball=0
    local windball=0
    local earthball=0
    if srcUser:HasBuffID(116830) then
      fireball=1
    end
     if srcUser:HasBuffID(116831) then
      waterball=1
    end
     if srcUser:HasBuffID(116832) then
      windball=1
    end
     if srcUser:HasBuffID(116833) then
      earthball=1
    end
   A5=(A1*windball+A2*earthball+A3*waterball+A4*fireball)*(skilllv_1-5)*0.02
  end

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))+A5
  
  if 1 >= A then
    return 1
  end

  if CommonFun.IsInRate(RuneDamage1, srcUser:GetRandom()) then
     return (A-A5)*RuneDamage+A5,CommonFun.DamageType.Crit
  end   
 
  return A

end


--------------------------------------------------------------------------------------------------------------------------念力连击暴击伤害计算公式
function CommonFun.calcDamage_37(srcUser, targetUser, params, damageParam, logger)
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
 
 ------------------------------------------------------------------------------------星盘额外增加法师普攻暴击效果
  local Num1 = srcUser:GetRunePoint(22050)

  local RuneDamage  = Num1*0.1 + 1 
  local RuneRate =  0
  if Num1>0 then 
     RuneRate = Luk/3
  end   

  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  --傀儡娃娃卡片[存储]
  local DamageRatio = 1
  if srcUser:HasBuffID(80001090) then
    DamageRatio = 1.1
  end
  local Num1= srcUser:GetRunePoint(23030)------------星盘点
  local RuneDamage2= Num1*0.05+1
  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*DamageRatio*RuneDamage2
  
  if 1 >= A then
    return 1
  end

  if CommonFun.IsInRate(RuneRate, srcUser:GetRandom()) then
     return A*RuneDamage,CommonFun.DamageType.Crit
  end   
 
  return A

end


--------------------------------------------------------------------------------------------------------------------------冰箭术专用伤害技能
function CommonFun.calcDamage_38(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
   
  ------------------------------------------------------------------------------------冰箭术星盘增加效果
  local Num1 = srcUser:GetRunePoint(22120)
  local RuneRate = 0
  
  if Num1 > 0 then
    RuneRate = 8
  end

  local RuneDamage = Num1*0.1 + 1

  local Num2 = srcUser:GetRunePoint(22160)
  local Num3 = srcUser:GetRunePoint(22161)
  local RuneDamage1 = (Num2+Num3)*0.1+1
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)  
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  ---------------------------------------------贤者之书＋灵犀宝珠
  local taozhuang1 = 1
  if srcUser:HasBuffID(91000470) then 
    taozhuang1 = 1.15
  end

  local A = (((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))+damChangePer1)*RuneDamage1*taozhuang1
  
  if 1 >= A then
    return 1
  end
  
  if CommonFun.IsInRate(RuneRate, srcUser:GetRandom()) then
     return A*RuneDamage,CommonFun.DamageType.Crit
  end   

  return A

end

--------------------------------------------------------------------------------------------------------------------------火柱伤害计算
function CommonFun.calcDamage_39(srcUser, targetUser, params, damageParam, logger)
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  ---------------------------------------------------------------------------------星盘额外增加的法师普攻享受额外攻击加成
  local Num1 = srcUser:GetRunePoint(22041)
  local Num2 = srcUser:GetRunePoint(22042)
  local Num3 = srcUser:GetRunePoint(22043)

  
  local RuneDamage = (Num1 + Num2 + Num3)*0.5
  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*RuneDamage*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  
  if 1 >= A then
    return 1
  end
 
  return A

end
-----------------------------------------------------------------------------------------------------------------------近战刺客系普通攻击伤害计算公式(已改)
function CommonFun.calcDamage_40(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  ------------------------------------------------------普通攻击力
  local NormalAtk = srcUser:GetProperty("NormalAtk")
        NormalAtk = NormalAtk + 5*Str
  ------------------------------------
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
 
  local WeaponType =srcUser:GetEquipedWeaponType()
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk+NormalAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
  ------------------------------------------------------------------------------------------------------------星盘二刀连击
  local Num1=srcUser:GetRunePoint(31006)
  local Num2=srcUser:GetRunePoint(31007)
  local Num3=srcUser:GetRunePoint(31008)
  local Num4=srcUser:GetRunePoint(31009)
  local Num5=srcUser:GetRunePoint(31010)

  local RuneDamage=Num1*0.05+Num2*0.1+Num3*0.1+Num4*0.05+Num5*0.1+1
  ------------------------------------------------------------------------------------------------------------华丽短剑buff状态下刺客普通攻击伤害提升
  local Buff=srcUser:HasBuffID(24441)
  local huali=1
  
     --------------------------------------------华丽短剑[第四档]
  if (Buff==true and srcUser:HasBuffID(90001903)) then
      huali=1.25
      elseif  Buff==true then
      huali=1.1
  end

  -------------------------------------------------------------------------------------------------星盘触发双刀破甲
  local Num6=srcUser:GetRunePoint(32001)
  local Num7=srcUser:GetRunePoint(32002)
  local RuneDamage2=1
  if targetUser:HasBuffID(95491) then
      RuneDamage2=Num6*0.1+Num7*0.05+1
  end

   if 1 >= A then
         return 1
   end
   -----------------------------------------------巅峰等级 二刀
  local ErDaoDam = 0
  if skilllv_1>10 then
      ErDaoDam = (skilllv_1-10)*0.05
      skilllv_1 = 10
  end
  ---------------------------------------------------斩击带来的下次普通攻击伤害会额外增加100%
  local NextAtk = 1
  if bits2[CommonFun.AttrEffect.NextAttackIncrease]==1 then
      NextAtk = 2
  end
  ---------------------------------------------伤口恶化
  local skilllv_eh = srcUser:GetLernedSkillLevel(1106)
   -----------------------------------------------------------------------------------------------------------判断二刀连击触发成功造成双倍伤害
  if WeaponType==250 and CommonFun.IsInRate(skilllv_1*5, srcUser:GetRandom()) then
    -------------------------------------------------------------------------------二刀连击伤口恶化
    if CommonFun.IsInRate(skilllv_eh*12, srcUser:GetRandom()) then
      -----------------------------------------只在后端调用  给对方添加buff
        if srcUser.isServerCall then
            srcUser:AddBuff(116051, targetUser:GetGuid())  
        end
    end

    return A*(2+ErDaoDam)*NextAtk*huali*RuneDamage*RuneDamage2, CommonFun.DamageType.ErLianJi
  end
  
  return A*huali*RuneDamage2*NextAtk
end

---------------------------------------------------------------------------------------------------------------------------近战刺客系技能攻击伤害倍率伤害计算公式（已改）
function CommonFun.calcDamage_41(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)


  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
     
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease) + damChangePer1-Vit2*(1+VitPer2)
      if 1 >= A then
         return 1
      end
  
  if bits2[CommonFun.AttrEffect.Hualiduanjian]==1 then
     return A*1.5
  end    

  return A
end

---------------------------------------------------------------------------------------------------------------------------病毒散播伤害计算公式（已改）
function CommonFun.calcDamage_42(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)


  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  -------------------------------------------------------------------------------------------------------------紫毒短剑效果
  local Weapon=srcUser:GetEquipedID(7)
  local B = 1

  if (Weapon==40738 or Weapon==140738) then
     B = 2
  end  

  -------------------------------------------------------------------------------------------------------------紫毒短剑效果 (第四档)  
  local weaponRefineLv_2=srcUser:GetEquipedRefineLv(7)
  local zidu = 0

  if srcUser:HasBuffID(90001313)  then
     zidu = weaponRefineLv_2*0.05
  end  


  -------------------------------------------------------------------------------------------------------------星盘病毒散播
  local Num1=srcUser:GetRunePoint(32014)
  local Num2=srcUser:GetRunePoint(32015)
  local Num3=srcUser:GetRunePoint(32016)
  local Num4=srcUser:GetRunePoint(32017)
  local Num5=srcUser:GetRunePoint(32018)
  local RuneDamage=Num1*0.05+Num2*0.05+Num3*0.05+Num4*0.05+Num5*0.05+1
  
  local A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+zidu))*(1-RefineDamReduc)*(1+DamIncrease) + damChangePer1 - Vit2*(1+VitPer2))*B*RuneDamage
      if 1 >= A then
         return 1
      end
  
  if bits2[CommonFun.AttrEffect.Hualiduanjian]==1 then
     return A*1.5
  end    

  return A
end
-----------------------------------------------------------------------------------------------------------------无视对方物理防御攻击
function CommonFun.calcDamage_43(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  ----------------------------物理防御减免

  
  local A = ((AtkFinal*(1-DamReduc2)+Refine)*damChangePer)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
   
   if 1 >= A then
         return 1
   end
   
   return A
end
--------------------------------------------------------------------------------------------------------------牧师普攻伤害计算公式
function CommonFun.calcDamage_50(srcUser, targetUser, params, damageParam, logger)
  local Str1 = srcUser:GetProperty("Str")
  --------------------------------------------------------------------------------------------------------星盘加成的力量转换的普攻加成率提升百分比
  local Num1 = srcUser:GetRunePoint(51013)
  local RuneDamage = Num1*0.05 + 1
  local Str = Str1*RuneDamage
  --------------------------------------------------------------------------------------------------------分割线
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk1 = srcUser:GetProperty("Atk")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  -------------------------------------------------------------------------------------------------------星盘加成的牧师普攻会受到魔法攻击影响
  local Num1 = srcUser:GetRunePoint(52013)
  local Num2 = srcUser:GetRunePoint(52014)
  local Num3 = srcUser:GetRunePoint(52015)
  local Num4 = srcUser:GetRunePoint(52016)
  local Num5 = srcUser:GetRunePoint(52017)
  local Num6 = srcUser:GetRunePoint(52018)
  local RuneDamage1 = (Num1 + Num2 + Num3 + Num4 + Num5 + Num6)*0.07
  local Atk  = Atk1 + RuneDamage1*MAtk*(1+MAtkPer)
  --------------------------------------------------------------------------------------------------------分割线2  
  local AtkPer = srcUser:GetProperty("AtkPer")
  ------------------------------------------------------普通攻击力
  local NormalAtk = srcUser:GetProperty("NormalAtk")
        NormalAtk = NormalAtk + 5*Str
  ------------------------------------
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")


  local fromid = targetUser:GetBuffFromID(45000120)
  local guid = srcUser:GetGuid()
  local BUffDam = 1
                   
  if fromid==guid then
    BUffDam = 1.3
  end


  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local race2 = targetUser.race
  local DefAttr2=targetUser:GetProperty("DefAttr")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
  
  local BaseAtk   = Str1*2 + math.floor(Str1*Str1/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local BaseAtk1  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
 
  local AtkFinal = ((Atk-BaseAtk+NormalAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk1)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*BUffDam
   if 1 >= A then
         return 1
   end
  --------------------------------------------------------------------------------------------------------天使之击带来的伤害加成效果
  if race2==3 or DefAttr2==9 then
     return A*(1+skilllv_1*0.05)
  end  
 
  return A 

end

-----------------------------------------------------------------------------------------------------------------商人普攻及技能伤害计算公式(已改)
function CommonFun.calcDamage_60(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  local skilllv_1 = srcUser:GetLernedSkillLevel(266)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk+skilllv_1*15)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
   
   if 1 >= A then
         return 1
   end

   return A
end
--------------------------------------------------------------------------------------------------------------------------贤者 普攻 伤害公式
function CommonFun.calcDamage_80(srcUser, targetUser, params, damageParam, logger)
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  ------------------------------------------------------普通攻击力
  local Numxp= srcUser:GetRunePoint(82001)-----------------------------星盘
  local NormalAtk = srcUser:GetProperty("NormalAtk")
        NormalAtk = NormalAtk + (3+0.3*Numxp)*Int
  ------------------------------------
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end

  ----------------------------------------------------------------升级装备 丝质外袍 暴击伤害
  local Num1 = srcUser:GetBuffLayer(90000952)
  local Num2 = srcUser:GetBuffLayer(90000953)
  local Num3 = srcUser:GetBuffLayer(90000954)
  ----------------------------------------------------------------升级装备 防水靴 暴击概率
  local Num4 = srcUser:GetBuffLayer(90000942)
  local Num5 = srcUser:GetBuffLayer(90000944)  

  local skilllv_1 = srcUser:GetLernedSkillLevel(1324)-----锐化武器
  local CriDam = 0
  
  if skilllv_1>0 then
      CriDam = 0.1
  elseif skilllv_1>5 then
      CriDam = 0.1 + (skilllv_1-5)*0.05
  end

  local Num_bs = srcUser:GetRunePoint(82024)
  local RuneDamage  =  1 + CriDam + 0.03*Num1 + 0.03*Num2 + 0.04*Num3 + 0.05*Num_bs -----------暴击伤害
  
  local RuneDamage1 =  0 --------------------------------------------------暴击概率

  if (Num4 + Num5 + skilllv_1)>0 then 
     RuneDamage1 = skilllv_1 + Luk/3 + Num4*5 + Num5*5
  end   
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk+NormalAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  
  if 1 >= A then
    return 1
  end

  if CommonFun.IsInRate(RuneDamage1, srcUser:GetRandom()) then
     return A*RuneDamage,CommonFun.DamageType.Crit
  end   
 
  return A

end
  ------------------------------------------------------------------------------------宠物真实伤害计算
function CommonFun.calcDamage_100(srcUser, targetUser, params, damageParam, logger)
  local Atk = srcUser:GetProperty("Atk")
  local damChangePer = damageParam.damChangePer
 
  local A = Atk * damChangePer
  
  if 1 >= A then
    return 1
  end
 
  return A
end

-----------------------------------------------------------------------------------------------------------------神圣复仇者伤害
function CommonFun.calcDamage_101(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local RefineLv=srcUser:GetEquipedRefineLv(7)

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*(1+RefineLv*0.05)
   
   if 1 >= A then
         return 1
   end
   
   return A
end
-----------------------------------------------------------------------------------------------------------------商人手推车技能伤害计算公式(已改)
function CommonFun.calcDamage_6101(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  local skilllv_1 = srcUser:GetLernedSkillLevel(266)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk+skilllv_1*15)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  -----------------------------------------------------------------------------------------------------------------星盘手推车攻击
  local num,numMax=srcUser:GetCartNums()
  local Num1  = srcUser:GetRunePoint(61006)
  local Num2  = srcUser:GetRunePoint(61007)
  local Num3  = srcUser:GetRunePoint(61008)
  local Num4  = srcUser:GetRunePoint(61009)
  local Num5  = srcUser:GetRunePoint(61010)
  local RuneDamage=(Num1*0.005+Num2*0.01+Num3*0.01+Num4*0.005+Num5*0.01)*numMax+1
  ----------------------------------------------------------------------------------------炼金 星盘 手推车攻击
  local Num6  = srcUser:GetRunePoint(130010)
  local RuneDamage2 = Num6*0.1+1

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage*RuneDamage2
  local Weapon=srcUser:GetEquipedID(7) 
 
   ---------------------------------------------------------------------------贝克之斧[第八档]
  local RefineLv7=srcUser:GetEquipedRefineLv(7)
  local beike = 0
  if srcUser:HasBuffID(90000677) then 
        if (RefineLv7>=10 and RefineLv7<15) then 
        beike =(RefineLv7-10)* 0.02 
         elseif RefineLv7 ==15 then
         beike =(RefineLv7-10)* 0.02 + 0.05  
        end
    end
  ---------------------------------------------------------------------------破坏者战斧
    if srcUser:HasBuffID(41920) then 
      if (RefineLv7>=5 and RefineLv7<15) then 
        beike =(RefineLv7-5)* 0.02 
      end
    end

   if Weapon==41835 or Weapon==141835 or Weapon==41867 or Weapon==141867 then
         return A*(1.15+beike)
   end
   
   if 1 >= A then
         return 1
   end

   return A
end

-----------------------------------------------------------------------------------------------------------------商人金钱攻击伤害公式(已改)
function CommonFun.calcDamage_6102(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  local Weapon=srcUser:GetEquipedID(7)
  local RefineLv=srcUser:GetEquipedRefineLv(7)
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ----------------------------------------------------------------------------------------------------------------星盘金钱攻击
  local Num1  = srcUser:GetRunePoint(62050)
  local RuneDamage1 = Num1*0.05+1
  --------------------------------------------------不正当手段
  local skilllv_1 = srcUser:GetLernedSkillLevel(272)

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+skilllv_1*0.3)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage1
   
  ----------------print(Weapon,Dex)
  --血斧或鲜血斧效果
  if (Weapon==41814 or Weapon==141814 or Weapon==41848 or Weapon==141848 or Weapon==41870 or Weapon==141870 ) then
    local CriRandom = 10
    local DexRatio = 0
    local CriRatio = 1
    local RefineRatio = 1

    --灵巧判断
    -----------------------------寻血猎犬
    if Dex>=90 and (Weapon==41814 or Weapon==141814) then
      DexRatio=0.4
    elseif Dex>=90 and (Weapon==41848 or Weapon==141848) then
      DexRatio=0.5
    elseif Dex>=90 and (Weapon==41870 or Weapon==141870) then
      DexRatio=0.5
    end
     -----------------------------力量判断（鲜血斧[第四档]）
    
    if srcUser:HasBuffID(90001873) and Str>=240 then
       DexRatio=DexRatio+0.3 
    end
    -----------------------------寻血猎犬
    if srcUser:HasBuffID(41950) and Str>=240 then
       DexRatio=DexRatio+0.3 
    end


    --精炼判断
    if RefineLv>=5 and RefineLv<10 then
      RefineRatio = 1.1
    elseif RefineLv>=10 and RefineLv<15 then
      RefineRatio = 1.3
    elseif RefineLv>=15 then
      RefineRatio = 1.6
    end
    -----------------------------寻血猎犬暴击
    if srcUser:HasBuffID(41950) then
       CriRandom=CriRandom+10
    end

    --暴击判断
    if CommonFun.IsInRate(CriRandom, srcUser:GetRandom()) and (Weapon==41848 or Weapon==141848 or Weapon==41870 or Weapon==141870 ) then
      CriRatio=1.5
    end 

    --效果显示
    if CriRatio == 1 then
      return A*(RefineRatio + DexRatio) * CriRatio
    else
      return A*(RefineRatio + DexRatio) * CriRatio,CommonFun.DamageType.Crit
    end
  end

   
  if 1 >= A then
    return 1
  end
   
  return A
end
-----------------------------------------------------------------------------------------------------------------商人手推车撞击技能伤害计算公式(已改)
function CommonFun.calcDamage_6103(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local damChangePer = damageParam.damChangePer
  local skilllv_1 = srcUser:GetLernedSkillLevel(266)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk+skilllv_1*15)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  -----------------------------------------------------------------------------------------------------------------星盘手推车撞击
  local num,numMax=srcUser:GetCartNums()
  local Num1  = srcUser:GetRunePoint(62008)
  local Num2  = srcUser:GetRunePoint(62009)
  local Num3  = srcUser:GetRunePoint(62010)
  local Num4  = srcUser:GetRunePoint(62011)
  local Num5  = srcUser:GetRunePoint(62012)
  local RuneDamage=(Num1*0.01+Num2*0.005+Num3*0.005+Num4*0.005+Num5*0.005)*numMax+1

 -----------------------------------------------------------------------------------------------------------------天崩地裂手推车撞击
 local tianben = 1
 if srcUser:HasBuffID(41940) then 
  tianben  = 1.1
 end

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage*tianben
   
   if 1 >= A then
         return 1
   end

   return A
end


------------------------------------------------------------------------------------------------炼金 治愈之手
function CommonFun.calcDamage_6104(srcUser, targetUser, params, damageParam, logger)
  local BaseLv = srcUser.BaseLv
  local HealEncPer = srcUser:GetProperty("HealEncPer")
  local MAtk = srcUser:GetProperty("MAtk")
  local enemy=srcUser:IsEnemy(targetUser)
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)

  ------------------------------------------------------------------------------------------------星盘
  local Master = srcUser:GetMasterUser()
  local RuneDamage = 1
  if Master~=nil then
      local Num1  = Master:GetRunePoint(130050)
      RuneDamage = 1+0.15*Num1
  end

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")

  local BeHealEncPer2 = targetUser:GetProperty("BeHealEncPer")
  local race2 = targetUser.race
  local DefAttr2=targetUser:GetProperty("DefAttr")


  local AttrEffect = targetUser:GetProperty("AttrEffect2")
  local bits=CommonFun.getBits(AttrEffect)
  
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1
   ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  --------------------------------------------------------------------------------------治愈术基本治疗量公式
  
  local A=((math.floor(BaseLv+MAtk/100)*damChangePer+100)*(1+HealEncPer)*(1+BeHealEncPer2) + damChangePer1)*(-1)*RuneDamage

  --------------------------------------------------------------------------------------对不死属性和不死种族怪物造成治疗量/2的圣属性伤害
  --------------------------------------------------------------------------------------这里的正值代表是伤害效果,负值是治疗效果
  if enemy then
        if DefAttr2==9 then
            return A/2*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2*(-1)*(1+MDamIncrease)
        else   
            return 0,0
        end   
  else
        if DefAttr2==9 or bits[CommonFun.AttrEffect.PoisinDamNoUse]==1 then
            return -1
        else   
            return A
        end
  end 

end

--------------------------------------------------------------------------------------------------------------------------善变（生命体)
function CommonFun.calcDamage_6105(srcUser, targetUser, params, damageParam, logger)
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  local skilllv = srcUser:GetLernedSkillLevel(445)

  MAtk = MAtk * (1+MAtkPer) 

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)  

 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  local MAtkFinal=MAtk*raceparam

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
  -------------------------------------------------星盘 善变-强效
  local Num1  = srcUser:GetRunePoint(130100)
  local RuneDamage=Num1*0.1 + 1
 
  -------------------------------------------------熟练者之锤或精炼值之锤
  local Master = srcUser:GetMasterUser()
  local Num2 =0
  local Weapon_1=Master:GetEquipedID(7)
  if (Weapon_1==41543 or Weapon_1==141543 or Weapon_1==41544 or Weapon_1==141544) then
    Num2=0.75
  end
  -------------------------------------------------------------熟练者之锤精炼
  local WeaponRefineLv=Master:GetEquipedRefineLv(7)
  if (Weapon_1==41543 or Weapon_1==141543 or Weapon_1==41544 or Weapon_1==141544) then
    Num2=Num2+WeaponRefineLv*0.35
  end
  -------------------------------------------------------------熟练者之锤套装
  if Master~=nil then
    if Master:HasBuffID(91000150) then 
      Num2=Num2+1.5
    end
  end
 -------------------------------------------------------------羽翼权杖[第二档]
  local Num3 = 1
  if Master~=nil then
    if Master:HasBuffID(90002181) then 
      Num3=Num3+0.15
    end
  end
  -------------------------------------------------------------预言者披风
  if Master~=nil then
    if Master:HasBuffID(90002193) then 
      Num3=Num3+0.15
    end
  end



  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)*(1-RefineMDamReduc)*(damChangePer+Num2)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))+damChangePer1)*RuneDamage*Num3
 


  if 1 >= A then
    return 1
  end
 
  return A

end
--------------------------------------------------------------------------------------------------------------------------生命体技能
function CommonFun.calcDamage_6106(srcUser, targetUser, params, damageParam, logger)
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  local skilllv = srcUser:GetLernedSkillLevel(445)

  MAtk = MAtk * (1+MAtkPer) 

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)  

 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local damChangePer  = damageParam.damChangePer

  local MAtkFinal=MAtk*raceparam

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)


  local A = (MAtkFinal*MDefReduc*(1-MDamReduc2)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
 

  if 1 >= A then
    return 1
  end
 
  return A

end

-----------------------------------------------------------------------------------------------------------------旋风斧技能伤害计算公式(已改)
function CommonFun.calcDamage_6301(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local WeaponType =srcUser:GetEquipedWeaponType()
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)


  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ----------------------------------------------------------------------------------------------------------------旋风斧星盘伤害
  local Num1 = srcUser:GetRunePoint(62060)
  local Num2 = srcUser:GetRunePoint(62061)
  local Num3 = srcUser:GetRunePoint(62062)
  local Num4 = srcUser:GetRunePoint(62063)
  local Num5 = srcUser:GetRunePoint(62064)  
  local Num6 = srcUser:GetRunePoint(62070)

  local RuneDamage = 0.4*(Num1+Num2+Num3+Num4+Num5)+0.05*Num6

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage
  
   if 1 >= A then
         return 1
   end
   
   return A
end

-----------------------------------------------------------------------------------------------------------------分裂斧普攻及技能伤害计算公式(已改)
function CommonFun.calcDamage_6302(srcUser, targetUser, params, damageParam, logger)
  local Str1 = srcUser:GetProperty("Str")
  --------------------------------------------------------------------------------------------------------商人星盘加成的力量转换的普攻加成率提升百分比
  local Num1 = srcUser:GetRunePoint(62080)
  local RuneDamage = Num1*0.01 + 1
  local Str = Str1*RuneDamage
  ---------------------------------------
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local WeaponType =srcUser:GetEquipedWeaponType()
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ------------------------------------------------------------------------------------------------------------------星盘分裂斧溅射伤害
  local Num1 = srcUser:GetRunePoint(62090)
  local Num2 = srcUser:GetRunePoint(62091)
  local Num3 = srcUser:GetRunePoint(62092)
  local Num4 = srcUser:GetRunePoint(62100)

  local RuneDamage = (Num1+Num2+Num3)*0.05+Num4*0.03

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage

   if 1 >= A then
         return 1
   end
   
   return A
end
-------------------------------------------------------------------------------------------------------------------------------------机械维修
function CommonFun.calcDamage_6401(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local MaxHp = targetUser:GetProperty("MaxHp")

  local damChangePer = damageParam.damChangePer
  local Num = srcUser:GetRunePoint(64020)

    local mapid,maptype = srcUser:GetMapInfo()-----------------获取所在地图
    local pvpRatio = 1
    ------------------------maptype 1 :野外 2：pvp 3:其他普通副本 4:gvg 
    if maptype==2 or maptype==4 then
        pvpRatio = 0.25
    end    

  local A = -MaxHp*((damChangePer)*(1+Int/100)*(1+0.05*Num)*pvpRatio)

  return A
end
-----------------------------------------------------------------------------------------------------------------自爆 伤害公式(已改)
function CommonFun.calcDamage_6402(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  local Weapon=srcUser:GetEquipedID(7)
  local RefineLv=srcUser:GetEquipedRefineLv(7)
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  local Sp = srcUser:GetProperty("Sp")
  local Hp = srcUser:GetProperty("Hp")
  local Vit = srcUser:GetProperty("Vit")

    local mapid,maptype = srcUser:GetMapInfo()-----------------获取所在地图
    local pvpRatio = 1
    ------------------------maptype 1 :野外 2：pvp 3:其他普通副本 4:gvg 
    if maptype==2 or maptype==4 then
        pvpRatio = 0.25
    end    
   -------------------------------------------------------工程扳手
  local  Wrench = 1
  local Ring7=srcUser:GetEquipedID(7)
  local RefineLv7=srcUser:GetEquipedRefineLv(7)
  if ( Ring7==41556 or Ring7==141556 )  then
       Wrench=Wrench+RefineLv7*0.02
  end
  ------------------------------------------------星盘
  local Num = srcUser:GetRunePoint(64040)
  local RuneDamage = 1 + Num*0.05

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(Sp/100 + Hp/5000*pvpRatio + Vit/10)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*Wrench*RuneDamage

   
  if 1 >= A then
    return 1
  end
   
  return A
end
-----------------------------------------------------------------------------------------------------------------喷射飞拳 伤害公式(已改)
function CommonFun.calcDamage_6403(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  local Weapon=srcUser:GetEquipedID(7)
  local RefineLv=srcUser:GetEquipedRefineLv(7)
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ------------------------------------------------星盘
  local Num = srcUser:GetRunePoint(64090)
  local RuneDamage = 1 + Num*0.1

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+Dex/30)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage

   
  if 1 >= A then
    return 1
  end
   
  return A
end
-----------------------------------------------------------------------------------------------------------------加农炮 伤害公式(已改)
function CommonFun.calcDamage_6404(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  local Weapon=srcUser:GetEquipedID(7)
  local RefineLv=srcUser:GetEquipedRefineLv(7)
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
 
  local sizeCorrection=1
  if nil ~= CommonFun.Shape then
    if CommonFun.Shape.S == targetUser.shape then
        sizeCorrection = 1.5
    elseif CommonFun.Shape.M == targetUser.shape then
        sizeCorrection = 1
    elseif CommonFun.Shape.L == targetUser.shape then
        sizeCorrection = 0.75
    end
  end

  ------------------------------------------------------------毁灭手斧
  local huimie=1
  local RefineLv7=srcUser:GetEquipedRefineLv(7)
  if srcUser:HasBuffID(90000647) then 
    if (RefineLv7<15) then 
        huimie=RefineLv7*0.01+1+0.05
    elseif RefineLv7 ==15 then
        huimie=RefineLv7*0.01+1+0.05+0.1
    end
  end
  ------------------------------------------------------------天崩地裂
  if srcUser:HasBuffID(41940) then 
    if (RefineLv7<15) then 
        huimie=RefineLv7*0.01+1+0.05
    elseif RefineLv7 ==15 then
        huimie=RefineLv7*0.01+1+0.05+0.1
    end
  end
  ------------------------------------------------星盘
  local Num = srcUser:GetRunePoint(64070)
  local RuneDamage = 1 + Num*0.1

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*sizeCorrection*huimie*RuneDamage
  


   
  if 1 >= A then
    return 1
  end
   
  return A
end
-- -- -----------------------------------------------------------------------------------------------------新剑士系普通攻击技能伤害公式(暂时未使用该技能)
function CommonFun.calcDamage_1101(srcUser, targetUser, params, damageParam, logger)
    
  local Int = srcUser:GetProperty("Int")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  local skilllv_3 = srcUser:GetLernedSkillLevel(damageParam.skill3_id)
  
  local damChangePer2 = damageParam.damChangePer2
  local damChangePer3 = damageParam.damChangePer3
  local damChangePer4 = damageParam.damChangePer4

  local raceparam = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  
  local AtkFinal =Atk*(1+AtkPer)
  local DefFinal =CommonFun.CalcDef(Def2,Vit2,srcUser,targetUser)*(1+DefPer2)
  local div = AtkFinal+DefFinal*(1-IgnoreDef)
  div = (div ~= 0 and div or 1)
  local skilllv_3_dam=0
  if skilllv_3<=5 then
     skilllv_3_dam=skilllv_3*20  
  else
     skilllv_3_dam=(skilllv_3-5)*Int+100
  end
  
  local A=(AtkFinal*AtkFinal/div)*(1-DamReduc2)*damChangePer2*(1+DamIncrease)*(1-RefineDamReduc)+skilllv_1*damChangePer3+damChangePer4+skilllv_3_dam
  
  return A*raceparam*bodyparam*bossparam*elementparam

end

-----------------------------------------------------------------------------------------------------------------战士系狂击技能伤害计算公式(已改)
function CommonFun.calcDamage_1102(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local AttrEffect= srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)

  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
  ----------------------------------------------------------------------附魔之刃 
  local skilllv_fumo = srcUser:GetLernedSkillLevel(1263)-------附魔
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local Num = srcUser:GetRunePoint(14060)
  local MAtk_fumo = 0
  if srcUser:HasBuffID(117630) then
      MAtk_fumo = MAtk*(1+MAtkPer)*skilllv_fumo*0.1*(1+Num/20)
  end

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk+MAtk_fumo)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease)+damChangePer1-Vit2*(1+VitPer2)
   
   if 1 >= A then
         return 1
   end
  
  local Buff = srcUser:HasBuffID(80000550)
  local Weapon=srcUser:GetEquipedID(7)
  local B = 1
  if CommonFun.Shape.M == targetUser.shape and (Weapon==40308 or Weapon==140308) then
     B=1.5
  end   
  ------------------------------------------狂怒之刃[1]
  if CommonFun.Shape.M == targetUser.shape and (Weapon==40359 or Weapon==140359) then
     B=1.5
  end  

  local Num1  = srcUser:GetRunePoint(11001)
  local Num2  = srcUser:GetRunePoint(11004)
  local Num3  = srcUser:GetRunePoint(11005)
  local Num4  = srcUser:GetRunePoint(11006)
  local Num5  = srcUser:GetRunePoint(11012)
  local Num6  = srcUser:GetRunePoint(11014)
  local Num7  = srcUser:GetRunePoint(11015)
  local Num8  = srcUser:GetRunePoint(11018)
  local Num9  = srcUser:GetRunePoint(11019)
  local Num10 = srcUser:GetRunePoint(11025)
  local RuneDamage = (Num1 + Num2 + Num3 + Num4 + Num5 + Num6 + Num7 + Num8 + Num9 + Num10)*(0.1) + 1
  -----------------------------------------------------------------------------------------------------------------------狂击效果[装备狂击之剑]     + 狂击等级>=10 + 妖道卡片BUFF
  -----------------------------------------------------------------------------------------------------------------------装备尖刃多刺刀             + 狂击等级>=10 + 妖道卡片BUFF
  -----------------------------------------------------------------------------------------------------------------------有狂击效果[装备狂击之剑]   + 狂击等级>=10 
  -----------------------------------------------------------------------------------------------------------------------装备尖刃多刺刀             + 狂击等级>=10
  -----------------------------------------------------------------------------------------------------------------------妖道卡片BUFF
   -----------------------------------------------------------------------------------------------------------------------狂怒之刃[1]
  if      bits[CommonFun.AttrEffect.KuangJiDam]==1 and skilllv_1>=10 and Buff==true  then  
             return (A + Str*20)*(1 + 0.5 ) * RuneDamage * (1-RefineDamReduc) 
  elseif  (Weapon==40308 or Weapon==140308) and skilllv_1>=10 and Buff==true  then
             return (A + Str*20)*(1 + 1) * B * RuneDamage *(1-RefineDamReduc) 
  elseif  (Weapon==40359 or Weapon==140359) and skilllv_1>=10 and Buff==true  then
             return (A + Str*20)*(1 + 1) * B * RuneDamage *(1-RefineDamReduc)                      
  elseif  bits[CommonFun.AttrEffect.KuangJiDam]==1 and skilllv_1>=10  then
             return A*(1 + 0.5 ) * RuneDamage * (1-RefineDamReduc) 
  elseif  (Weapon==40308 or Weapon==140308) and skilllv_1>=10   then
             return A*(1 + 1) * B * RuneDamage * (1-RefineDamReduc) 
  elseif  (Weapon==40359 or Weapon==140359) and skilllv_1>=10   then
             return A*(1 + 1) * B * RuneDamage * (1-RefineDamReduc) 
  elseif  Buff==true then
             return (A + Str*20) * RuneDamage * (1-RefineDamReduc)          
  end

   return A * RuneDamage * (1-RefineDamReduc)
end

-------------------------------------------------------------------------------------------------------------------------剑士系怒爆伤害公式
function CommonFun.calcDamage_1103(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
   -----------------------------------------------------------------------------------------------------------------气泡虫怒爆伤害增加
   local Buff = srcUser:HasBuffID(80001190)
   if Buff==true then
      return A*1.5
   end

   if 1 >= A then
         return 1
   end
   
   return A
end

-----------------------------------------------------------------------------------新连刺攻击技能伤害计算公式
-----------------------------------------------------------------------------------技能公式调整,技能PD伤害值考虑伤害减免效果
function CommonFun.calcDamage_1201(srcUser, targetUser, params, damageParam, logger)
  -----------------sizeCorrection这个参数和之前的公式中参数定义一样,也是小体型1倍,中体型2倍,大体型3倍伤害(已改)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")


  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  -------------------------------------------------------------------------------死神之镰
  -------------------------------------------------------------------------------斧锤长矛
  -------------------------------------------------------------------------------戮魂长矛

 local sizeCorrection=1
  if nil ~= CommonFun.Shape then
    if CommonFun.Shape.S == targetUser.shape then
        sizeCorrection = 1
    elseif CommonFun.Shape.M == targetUser.shape then
     if srcUser:HasBuffID(91000170) or srcUser:HasBuffID(91000540) then 
        sizeCorrection = 2*1.1
      elseif srcUser:HasBuffID(90001983) then 
        sizeCorrection = 2*1.3
      else sizeCorrection = 2
        end
    elseif CommonFun.Shape.L == targetUser.shape then
      if srcUser:HasBuffID(41721) then 
        sizeCorrection = 3*1.7
      elseif srcUser:HasBuffID(90001173) then 
        sizeCorrection = 3*1.7
      elseif srcUser:HasBuffID(90001172) then 
        sizeCorrection = 3*1.45
      elseif srcUser:HasBuffID(90001171) then 
        sizeCorrection = 3*1.25
      elseif srcUser:HasBuffID(90001170) then 
        sizeCorrection = 3*1.1
      else sizeCorrection = 3
      end        

    end
  end
  ---------------------------------------------------------------------伤害加深 印记
  local Sign = 1
  local Num1 = targetUser:GetBuffLayer(117660)--------------------------印记
  local fromid = targetUser:GetBuffFromID(117660)
  local guid = srcUser:GetGuid()

  local skilllv_1 = srcUser:GetLernedSkillLevel(1267)----伤害加深

  if fromid==guid then
    Sign = 1+(skilllv_1*0.01+0.02)*Num1
  end
  ------------------------------------------------------------------------
  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*sizeCorrection*Sign
  
  if 1 >= A then
    return 1
  end
  
  return A

end

------------------------------------------------------------------------------新怪物互击技能伤害公式（已改）
function CommonFun.calcDamage_1202(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)


  local AttrEffect= srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local HumanRes = targetUser:GetProperty("DemiHumanResPer")
  local count=params.hitedCount


  local damChangePer = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local countDam = 0.1
  if skilllv_1>10 then 
      countDam = 0.3
  end

  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+countDam*count)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
  
  ----------------------------------------------------------------------------------------------------------------达拉蛙存储减少怪物互击伤害
  local B = 0
  local Buff = targetUser:HasBuffID(80000240)
  local Weapon=srcUser:GetEquipedID(7)
   
  if Buff==true then
        B = HumanRes*100*20
  end

  if 1 >= (A-B) then
         return 1
  end
  
----------------------------------------------------------------------------多刃尖刺刀第4档（怪物互击对中型魔物额外增加伤害10%）
  local guaiwuhujiM = 1
  if CommonFun.Shape.M == targetUser.shape and srcUser:HasBuffID(90001163) then
     guaiwuhujiM=1.1
   end

----------------------------------------------------------------------------狂怒之刃（怪物互击对中型魔物额外增加伤害10%）
   if CommonFun.Shape.M == targetUser.shape and (Weapon==40359 or Weapon==140359)  then
     guaiwuhujiM=1.1
   end




  ---------------------------------------------------------------------------------------------------------------------装备或卡片上有怪物互击加伤百分比的效果
  ---------------------------------------------------------------------------------------------------------------------装备尖刃多刺刀 +技能等级>=10 
  ---------------------------------------------------------------------------------------------------------------------狂怒之刃[1]
  if      bits[CommonFun.AttrEffect.GuaiWuHuJiDam]==1 and skilllv_1>=10 then  
             return (A-B)*(1 + 0.3)*guaiwuhujiM
  elseif  (Weapon==40308 or Weapon== 140308) and skilllv_1 >=10 then
             return (A-B)*(1 + 1)*guaiwuhujiM
  elseif  (Weapon==40359 or Weapon== 140359) and skilllv_1 >=10 then
             return (A-B)*(1 + 1)*guaiwuhujiM
  end

   
   return (A-B)*guaiwuhujiM

end
-----------------------------------------------------------------------------------------------------------------近战战士系骑乘攻击技能伤害计算公式(已改)
function CommonFun.calcDamage_1203(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  -------------------------------------------------------------------------------------------------------------------------------星盘骑乘攻击
  local Num1 = srcUser:GetRunePoint(11021)
  local RuneDamage = 1
  if CommonFun.Shape.M == targetUser.shape then 
      RuneDamage = 0.03*Num1+1
  end

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage
   
   if 1 >= A then
         return 1
   end
   
   return A
end

-----------------------------------------------------------------------------------------------------------------近战战士系 巧打 技能伤害计算公式(已改)
function CommonFun.calcDamage_1204(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  --------------------------------------------------------------------------------------------------------------------星盘巧打
  local Num1=srcUser:GetRunePoint(12100)
  local RuneDamage = Num1*0.15+1

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage
   
   if 1 >= A then
         return 1
   end
   
   return A
end


-----------------------------------------------------------------------------------------------------------------圣十字审判技能伤害计算公式(已改)
function CommonFun.calcDamage_1205(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  
  ----------------------------------------------------------------------------------分割线
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 

  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end

    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")
   --------------------------------------------------------------------------------------------------------物理防御减免
  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
   --------------------------------------------------------------------------------------------------------魔法防御减免
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  -------------------------------------------------------------神佑之光伤害加成
  local skilllv_1 = srcUser:GetLernedSkillLevel(362)
  local Skilldamage = skilllv_1*0.3  
  -------------------------------------------------------------娜迦鳞盾
  local EquipDamage = 0
  local RefineDamage =0
  local RefineLv=srcUser:GetEquipedRefineLv(1)
  if srcUser:HasBuffID(40400) then 
      EquipDamage = 2
      RefineDamage = 0.3*RefineLv
  end


  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer + Skilldamage + EquipDamage + RefineDamage)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)

  ----------------------------------------------------------------------坚定战甲增加物理部分伤害
  if srcUser:HasBuffID(90000965) then
      A = A*1.1
  end
  
  if 1 >= A then
     A = 1 
  end


  local srcAtkElement    = 6
  local targetDefElement = targetUser:GetProperty("DefAttr")
  
  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local B = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(damChangePer + Skilldamage + EquipDamage + RefineDamage)*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))

  ----------------------------------------------------------------------坚定战甲增加魔法部分伤害
  if srcUser:HasBuffID(90000969) then
      B = B*1.1
  end


  if 1 >= B then
     B = 1
  end
  -------------------------------------------------------------星盘圣十字审判
  local Num1 = srcUser:GetRunePoint(70140)
  local RuneDamage = 1 + 0.1*Num1

  local C = (A + B)*RuneDamage
  ----------------------------------------------------------------------娜迦鳞盾 + 旗鱼枪
  if srcUser:HasBuffID(40380) and srcUser:HasBuffID(40400) then
      C = (A + B)*RuneDamage*1.5
  end
  ----------------------------------------------------------------------娜迦鳞盾 + 深海恐惧
  if srcUser:HasBuffID(41770) and srcUser:HasBuffID(40400) then
      C = (A + B)*RuneDamage*1.5
  end

   return C
end
-----------------------------------------------------------------------------------------------------------------投掷长矛 技能伤害计算公式(已改)
function CommonFun.calcDamage_1206(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ---------------------------------------------------------------------伤害加深 印记
  local Sign = 1
  local Num1 = targetUser:GetBuffLayer(117660)--------------------------印记
  local fromid = targetUser:GetBuffFromID(117660)
  local guid = srcUser:GetGuid()

  local skilllv_1 = srcUser:GetLernedSkillLevel(1267)----伤害加深

  if fromid==guid then
    Sign = 1+(skilllv_1*0.01+0.02)*Num1
  end

  local A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*Sign
   
   if 1 >= A then
         return 1
   end
   
   return A
end
-----------------------------------------------------------------------------------------------------------------冲锋攻击 技能伤害计算公式(已改)
function CommonFun.calcDamage_1207(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
-------------------------------------------- 攻击距离加成
  local targetid = targetUser:GetGuid()
  local distance = srcUser:GetDistance(targetid)
  local skilllv_1 = srcUser:GetLernedSkillLevel(601)
  local Num1= srcUser:GetRunePoint(13020)

  local DisDam= 1
        DisDam = 1 + distance*0.05*Num1

  ----------------------------物理防御减免

  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  local A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*DisDam
   if 1 >= A then
         return 1
   end
   
   return A
end
------------------------------------------------------------------------------新螺旋击刺技能伤害公式(已改)
----------------------------------------------------------------------------------------------------------------公式=[((Str/10)^2+武器类型*角色等级*3.5*0.8)*体型修正+精炼]*卡片倍率*属性倍率*5
function CommonFun.calcDamage_1301(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")

  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local WeaponType =srcUser:GetEquipedWeaponType()
  local BaseLv = srcUser.BaseLv
  local Refine = srcUser:GetProperty("Refine")

  local damChangePer = damageParam.damChangePer
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = (Atk-BaseAtk)*(1+AtkPer)

  local sizeCorrection=1
  if nil ~= CommonFun.Shape then
    if CommonFun.Shape.S == targetUser.shape then
        sizeCorrection = 1.3
    elseif CommonFun.Shape.M == targetUser.shape then
        sizeCorrection = 1
    elseif CommonFun.Shape.L == targetUser.shape then
        sizeCorrection = 0.8
    end
  end
  
  local WeaponType_value=0 
  if WeaponType==170 then
     WeaponType_value=2
  else
     WeaponType_value=0.5
  end     

---------------------------------------------------------------------风暴之枪

  local Weapon=srcUser:GetEquipedID(7)
  local calcfbzq=1
  if (Weapon==40041 or Weapon==140041) then
    calcfbzq=1+0.1
  end 


  ---------------------------------------------------------------------戮魂长矛
  if (Weapon==40055 or Weapon==140055) then
    calcfbzq=calcfbzq+0.15
  end 

  ---------------------------------------------------------------------伤害加深 印记
  local Sign = 1
  local Num1 = targetUser:GetBuffLayer(117660)--------------------------印记
  local fromid = targetUser:GetBuffFromID(117660)
  local guid = srcUser:GetGuid()

  local skilllv_1 = srcUser:GetLernedSkillLevel(1267)----伤害加深

  if fromid==guid then
    Sign = 1+(skilllv_1*0.01+0.02)*Num1
  end
  ------------------------------------------------------------------------
  local  A = (((Str/4)^2+(WeaponType_value*AtkFinal)*elementparam*bodyparam)*damChangePer+Refine*15+BaseLv*15)*raceparam*bossparam*(1-RefineDamReduc)*(1+DamIncrease)*(1-DamReduc2)*sizeCorrection*elementparam2*bossparam2*calcfbzq*Sign
  if 1 >= A then
      return 1
  end
  
  return A

end


------------------------------------------------------------------------------怪物用新螺旋击刺技能伤害公式(已改)
----------------------------------------------------------------------------------------------------------------公式=[((Str/10)^2+武器类型*角色等级*3.5*0.8)*体型修正+精炼]*卡片倍率*属性倍率*5
function CommonFun.calcDamage_1302(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")

  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local WeaponType =srcUser:GetEquipedWeaponType()
  local BaseLv = srcUser.BaseLv
  local Refine = srcUser:GetProperty("Refine")



  local damChangePer = damageParam.damChangePer
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = (Atk-BaseAtk)*(1+AtkPer)

  
  local sizeCorrection=1
  if nil ~= CommonFun.Shape then
    if CommonFun.Shape.S == targetUser.shape then
        sizeCorrection = 1.3
    elseif CommonFun.Shape.M == targetUser.shape then
        sizeCorrection = 1
    elseif CommonFun.Shape.L == targetUser.shape then
        sizeCorrection = 0.8
    end
  end
  
  local WeaponType_value=0 
  if WeaponType==170 then
     WeaponType_value=2
  else
     WeaponType_value=0.5
  end      

  local  A = (((Str/4)^2+(WeaponType_value*AtkFinal)*elementparam*bodyparam)*damChangePer+Refine*15+BaseLv*5)*raceparam*bossparam*(1- RefineDamReduc)*(1+DamIncrease)*(1-DamReduc2)*sizeCorrection*elementparam2*bossparam2
  if 1 >= A then
      return 1
  end
  
  return A

end
--------------------------------------------------------------------------------------------------------------------------龙之吐息 伤害计算公式(已改)
function CommonFun.calcDamage_1401(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ----------------------------------------------------------------------自身体质提高伤害
  local Vit = srcUser:GetProperty("Vit")
  local VitRatio = 1+Vit/1000  --------------------每10点体质提高1%伤害
  ---------------------------------生命点燃状态下吐息伤害提高
  local HpFire = 1
  if srcUser:HasBuffID(80220) or srcUser:HasBuffID(80223) then
      HpFire = 1.2
  end
  ---------------------------------------骑乘龙时伤害提高
  local skilllv_1 = srcUser:GetLernedSkillLevel(1260)-------驯龙术
  local Ride = 1
  if srcUser:IsRide(25114) or srcUser:IsRide(25116) or srcUser:IsRide(25117) or srcUser:IsRide(25118) or srcUser:IsRide(25122) then
      Ride = 1+skilllv_1*0.05
  end
  ---------------------------------驯龙者长枪【新】
  local Dragon = 1
  local RefineLv7=srcUser:GetEquipedRefineLv(7)
  if srcUser:HasBuffID(41200)  then 
      Dragon= 1 + RefineLv7*0.01
  end
  local Dragon1 = 0
  if srcUser:HasBuffID(41200) and (RefineLv7 ==15) then 
      Dragon1= 1
  end

  ---------------------------------巨龙咆哮
  if srcUser:HasBuffID(41740)  then 
      Dragon= 1 + RefineLv7*0.01
  end
   if srcUser:HasBuffID(41740) and (RefineLv7 ==15) then 
      Dragon1= 1
  end


  ---------------------------------星盘 龙之吐息
  local Numxp= srcUser:GetRunePoint(14020)------------星盘点
  local RuneDamage = 1 + Numxp*0.06

  ---------------------------------------------------------------火焰精灵卡片
  local  card = 1
  if  srcUser:HasBuffID(52580) then 
    card = 1.1
  end

  local A = (((AtkFinal+MAtkFinal)*DefReduc*(1-DamReduc2)+Refine+MRefine)*(damChangePer+Dragon1)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*HpFire*VitRatio*Ride*Dragon*RuneDamage*card


  
  if 1 >= A then
    return 1
  end
 
  return A

end
---------------------------------------------------------------------------------------------------------------------------------符文骑士 矛 伤害公式
function CommonFun.calcDamage_1402(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")


  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)


  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ---------------------------------------------------------------------伤害加深 印记
  local Sign = 1
  local Num1 = targetUser:GetBuffLayer(117660)--------------------------印记
  local fromid = targetUser:GetBuffFromID(117660)
  local guid = srcUser:GetGuid()

  local skilllv_1 = srcUser:GetLernedSkillLevel(1267)----伤害加深

  if fromid==guid then
    Sign = 1+(skilllv_1*0.01+0.02)*Num1
  end
  ------------------------------------------------------------------------
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*Sign
  
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  ----------------------------------------------------------急速戳刺
  if skillID==1266 then
      local Num = srcUser:GetRunePoint(14040)
      local RuneDamage = 1 + Num*0.06

---------------------------------------------------------------------风暴之枪[第四档]
  local calcfbzq=1
  local RefineLv=srcUser:GetEquipedRefineLv(7)
  if RefineLv >= 10 and srcUser:HasBuffID(90002003) then 
    calcfbzq=calcfbzq+0.15
  end

      A =A * (RuneDamage + calcfbzq)
  end

  if 1 >= A then
    return 1
  end
  
  return A

end
------------------------------------------------------------------------------新圣灵召唤技能伤害计算公式
function CommonFun.calcDamage_2103(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  --------------------------------------------------------------------------------星盘加成概率使触发高能
  local Num1 = srcUser:GetRunePoint(22018)
  local RuneRate = Num1*8  
  local RuneDamage = Num1*0.1 +1

 local MRefine = srcUser:GetProperty("MRefine")


  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser,params,damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")  

  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local enemy = srcUser:IsEnemy(targetUser)
  local race2 = targetUser.race
  
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1
  local damChangePer2 = damageParam.damChangePer2

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger) 
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2+damChangePer2
  

  if CommonFun.IsInRate(RuneRate, srcUser:GetRandom()) then
     if race2==5 then
        return A*(1+damChangePer1)*RuneDamage
     else 
        return A*RuneDamage 
     end
  else
      if race2==5 then
        return A*(1+damChangePer1)
      else
        return A
      end   
  end          
 
  if 1 >= A then
    return 1
  end

  return A
end


-- --------------------------------------------------------------------------------------------------------法师技能魔击术计算公式(已改)
function CommonFun.calcDamage_2201(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local MRefine = srcUser:GetProperty("MRefine")


  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser,params,damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")  

  local Def2      = targetUser:GetProperty("Def")
  local DefPer2   = targetUser:GetProperty("DefPer")
  local Vit2      = targetUser:GetProperty("Vit")
  local VitPer2   = targetUser:GetProperty("VitPer")
  local Int2      = targetUser:GetProperty("Int")
  local IntPer2   = targetUser:GetProperty("IntPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local damChangePer = damageParam.damChangePer
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger) 
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2

  ----------------------------物理防御减免  魔击术计算物理防御
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
 
  local A = ((MAtkFinal*DefReduc*(1-DamReduc2)+MRefine)*(1-RefineDamReduc)*damChangePer-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*(1+MDamIncrease)

  if 1 >= A then
    return 1
  end
 return A

end

---------------------------------------------------------------------------------------------------火焰冲击伤害公式(已改)
function CommonFun.calcDamage_2301(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")

 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2      = targetUser:GetProperty("Vit")
  local VitPer2   = targetUser:GetProperty("VitPer")
  local Int2      = targetUser:GetProperty("Int")
  local IntPer2   = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)   
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2

  local A = (((MAtkFinal*(1-MDamReduc2)*damChangePer+50)+MRefine)*(1-RefineMDamReduc)*damChangePer1-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*(1+MDamIncrease)
  
  if 1 >= A then
    return 1
  end
 
  return A
end

--------------------------------------------------------------------------------------------------------------------------重力原野伤害技能
function CommonFun.calcDamage_2302(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
   
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)  
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))+damChangePer1
  
  if 1 >= A then
    return 1
  end

  return A

end
--------------------------------------------------------------------------------------------------------------------------法师灵魂爆发计算公式(已改)
function CommonFun.calcDamage_2303(srcUser, targetUser, params, damageParam, logger)
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")

  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2
  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
  ---------------------------------------------------------------星盘
  local Num1 = srcUser:GetRunePoint(24040)
  local RuneDamage = 1 + Num1*0.05
  ---------------------------------------------------------------鸟人哈比卡片
  local  card = 1
  if  srcUser:HasBuffID(52550) then 
    card = 1.1
  end

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*card*RuneDamage
 ------------------------------------------对白色监狱状态下敌人双倍伤害
  if targetUser:HasBuffID(116810) then
     A=A*2
  end
  if 1 >= A then
    return 1
  end
 
  return A

end
--------------------------------------------------------------------------------------------------------------------------法师生命吸收计算公式(已改)
function CommonFun.calcDamage_2304(srcUser, targetUser, params, damageParam, logger)
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local target_Hp=targetUser:GetProperty("Hp")
  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  
  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响

 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
  ---------------------------------------------------------------星盘
  local Num1 = srcUser:GetRunePoint(24070)
  local RuneDamage = Num1*4
  if targetUser.boss == true or targetUser.mini == true or targetUser:HasBuffID(160000) then 
           target_Hp = 0
  end   
  local A = ((target_Hp*MDefReduc*(1-MDamReduc2))*(damChangePer+RuneDamage)/100*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))

  if 1 >= A then
    return 1
  end
 
  return A

end
--------------------------------------------------------------------------------------------------------------------------元素漩涡伤害计算公式(已改)
function CommonFun.calcDamage_2305(srcUser, targetUser, params, damageParam, logger)
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")

  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")
  -------------------------------------------------四种元素伤害分别判断 
  local srcAtkElement1  = 1
    local elementInc1 = 0
    local elementRed1 = 0

    local targetDefElement = targetUser:GetProperty("DefAttr")

    
    if nil == targetDefElement then
        logger.error(string.format("%s targetDefElement is nil", targetUser.name))
        return 0
    end
    if nil == CommonFun.NatureProps[targetDefElement] then
        logger.error(string.format("%s CommonFun.NatureProps[%s] is nil", srcUser.name, tostring(targetDefElement)))
        return 0
    end

    if nil == CommonFun.NatureProps[srcAtkElement1] then
        logger.error(string.format("CommonFun.NatureProps[%s] is nil", tostring(srcAtkElement1)))
        return 0
    end

    elementInc1 = srcUser:GetProperty(CommonFun.NatureProps[targetDefElement][1])
    elementRed1 = targetUser:GetProperty(CommonFun.NatureProps[srcAtkElement1][2])
    elementAtk1 = srcUser:GetProperty(CommonFun.NatureProps[srcAtkElement1][3])

    if nil==elementAtk1 then
        elementAtk1 = 0
    end
    local result1 = 1+elementAtk1-elementRed1

    ------------------------------------------------------------------------竞技场额外增加30%元素减免
    local mapid,maptype = srcUser:GetMapInfo()-----------------获取所在地图
    ------------------------maptype 1 :野外 2：pvp 3:其他普通副本 4:gvg 
    if maptype==2 or maptype==4 then
      local B1 = elementRed1 - elementAtk1  ---------------元素伤害减免
      B1 = B1 < -1 and -1 or B1 > 1 and 1 or B1
      B1 = math.floor(B1*1000)/1000
      B1 = B1 + 0.3*(1-math.sin(B1*3.14/2))
      --print("B2="..B)
      result1 = 1 - B1 
    end

    if result1 <= 0.1 then
        result1 = 0.1
    end

    local srcAtkElement2   = 2
    local elementInc2 = 0
    local elementRed2 = 0

    local targetDefElement = targetUser:GetProperty("DefAttr")

    
    if nil == targetDefElement then
        logger.error(string.format("%s targetDefElement is nil", targetUser.name))
        return 0
    end
    if nil == CommonFun.NatureProps[targetDefElement] then
        logger.error(string.format("%s CommonFun.NatureProps[%s] is nil", srcUser.name, tostring(targetDefElement)))
        return 0
    end

    if nil == CommonFun.NatureProps[srcAtkElement2] then
        logger.error(string.format("CommonFun.NatureProps[%s] is nil", tostring(srcAtkElement2)))
        return 0
    end

    elementInc2 = srcUser:GetProperty(CommonFun.NatureProps[targetDefElement][1])
    elementRed2 = targetUser:GetProperty(CommonFun.NatureProps[srcAtkElement2][2])
    elementAtk2 = srcUser:GetProperty(CommonFun.NatureProps[srcAtkElement2][3])

    if nil==elementAtk2 then
        elementAtk2 = 0
    end
    local result2 = 1+elementAtk2-elementRed2

    if maptype==2 or maptype==4 then
      local B2 = elementRed2 - elementAtk2  ---------------元素伤害减免
      B2 = B2 < -1 and -1 or B2 > 1 and 1 or B2
      B2 = math.floor(B2*1000)/1000
      B2 = B2 + 0.3*(1-math.sin(B2*3.14/2))
      --print("B2="..B)
      result2 = 1 - B2 
    end

    if result2 <= 0.1 then
        result2 = 0.1
    end

  local srcAtkElement3   = 3
    local elementInc3 = 0
    local elementRed3 = 0

    local targetDefElement = targetUser:GetProperty("DefAttr")

    
    if nil == targetDefElement then
        logger.error(string.format("%s targetDefElement is nil", targetUser.name))
        return 0
    end
    if nil == CommonFun.NatureProps[targetDefElement] then
        logger.error(string.format("%s CommonFun.NatureProps[%s] is nil", srcUser.name, tostring(targetDefElement)))
        return 0
    end

    if nil == CommonFun.NatureProps[srcAtkElement3] then
        logger.error(string.format("CommonFun.NatureProps[%s] is nil", tostring(srcAtkElement3)))
        return 0
    end

    elementInc3 = srcUser:GetProperty(CommonFun.NatureProps[targetDefElement][1])
    elementRed3 = targetUser:GetProperty(CommonFun.NatureProps[srcAtkElement3][2])
    elementAtk3 = srcUser:GetProperty(CommonFun.NatureProps[srcAtkElement3][3])

    if nil==elementAtk3 then
        elementAtk3 = 0
    end
    local result3 = 1+elementAtk3-elementRed3

    ------------------------maptype 1 :野外 2：pvp 3:其他普通副本 4:gvg 
    if maptype==2 or maptype==4 then
      local B3 = elementRed3 - elementAtk3  ---------------元素伤害减免
      B3 = B3 < -1 and -1 or B3 > 1 and 1 or B3
      B3 = math.floor(B3*1000)/1000
      B3 = B3 + 0.3*(1-math.sin(B3*3.14/2))
      --print("B2="..B)
      result3 = 1 - B3 
    end

    if result3 <= 0.1 then
        result3 = 0.1
    end

  local srcAtkElement4   = 4
    local elementInc4 = 0
    local elementRed4 = 0

    local targetDefElement = targetUser:GetProperty("DefAttr")

    
    if nil == targetDefElement then
        logger.error(string.format("%s targetDefElement is nil", targetUser.name))
        return 0
    end
    if nil == CommonFun.NatureProps[targetDefElement] then
        logger.error(string.format("%s CommonFun.NatureProps[%s] is nil", srcUser.name, tostring(targetDefElement)))
        return 0
    end

    if nil == CommonFun.NatureProps[srcAtkElement4] then
        logger.error(string.format("CommonFun.NatureProps[%s] is nil", tostring(srcAtkElement4)))
        return 0
    end

    elementInc4 = srcUser:GetProperty(CommonFun.NatureProps[targetDefElement][1])
    elementRed4 = targetUser:GetProperty(CommonFun.NatureProps[srcAtkElement4][2])
    elementAtk4 = srcUser:GetProperty(CommonFun.NatureProps[srcAtkElement4][3])

    if nil==elementAtk4 then
        elementAtk4 = 0
    end
    local result4 = 1+elementAtk4-elementRed4
    ------------------------maptype 1 :野外 2：pvp 3:其他普通副本 4:gvg 
    if maptype==2 or maptype==4 then
      local B4 = elementRed4 - elementAtk4  ---------------元素伤害减免
      B4 = B4 < -1 and -1 or B4 > 1 and 1 or B4
      B4 = math.floor(B4*1000)/1000
      B4 = B4 + 0.3*(1-math.sin(B4*3.14/2))
      --print("B2="..B)
      result4 = 1 - B4 
    end

    if result4 <= 0.1 then
        result4 = 0.1
    end
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  
  local elementparam21 = result1
  local elementparam22 = result2
  local elementparam23 = result3
  local elementparam24 = result4
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2
  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A1 = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement1][targetDefElement]*elementparam21-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  local A2 = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement2][targetDefElement]*elementparam22-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  local A3 = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement3][targetDefElement]*elementparam23-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  local A4 = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement4][targetDefElement]*elementparam24-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  -------------------------------------星盘 元素融合
  local Num1 = srcUser:GetRunePoint(24010)
  local RuneDamage = 1 + Num1*0.04
  local A=(A1+A2+A3+A4)*RuneDamage
 
  if 1 >= A then
    return 1
  end
 
  return A

end
--------------------------------------------------------------------------------------------------------------------------法师  连锁闪电 魔法伤害计算公式(已改)
function CommonFun.calcDamage_2306(srcUser, targetUser, params, damageParam, logger)
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")

  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2
  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local index = params.hitedIndex--第几个目标
  -------------------------------------------------星盘 跳跃
  local Num1 = srcUser:GetRunePoint(24020)
  local RuneDamage = Num1*0.03 + 1.1

  local JumpRatio = math.pow(RuneDamage,index)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*JumpRatio
  
  if 1 >= A then
    return 1
  end
 
  return A

end
--------------------------------------------------------------------------------------------------------盗贼技能伏击伤害计算公式
function CommonFun.calcDamage_3101(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")

  local Hiding = srcUser:GetProperty("Hiding")
  
  local AttrEffect = srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)


  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2   = targetUser:GetProperty("VitPer")  
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
   
   if 1 >= A then
         return 1
   end
  ------------------------------------------------------------------------------------------------星盘
    local Num1=srcUser:GetRunePoint(31001)
    local Num2=srcUser:GetRunePoint(31002)
    local Num3=srcUser:GetRunePoint(31003)
    local Num4=srcUser:GetRunePoint(31004)
    local Num5=srcUser:GetRunePoint(31005)

    local RuneDamage=Num1*0.05+Num2*0.1+Num3*0.05+Num4*0.05+Num5*0.05+1  
  ------------------------------------------------------------------------------------------------隐匿伏击伤害提高
    local Num6=srcUser:GetRunePoint(90120)
    local RuneDamage2 = 0.1*Num6 + 1
  ------------------------------------------------------------------------------------------------隐匿状态或隐匿强化状态下伏击造成的伤害会加倍
  if Hiding==1 or bits[CommonFun.AttrEffect.HideStrengthEffect]==1 then
     if bits2[CommonFun.AttrEffect.Hualiduanjian]==1 then
        return A*2*1.5*RuneDamage*RuneDamage2
     else
        return A*2*RuneDamage*RuneDamage2
     end 
  else 
      if bits2[CommonFun.AttrEffect.Hualiduanjian]==1 then
        return A*1.5
      end  

  end
        return A   

end

--------------------------------------------------------------------------------------------------------盗贼技能毒刃伤害计算公式(已改)
function CommonFun.calcDamage_3102(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")
  
  local AttrEffect= srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local StateEffect2 = targetUser:GetProperty("StateEffect")
  local bits2=CommonFun.getBits(StateEffect2)

  local AttrEffect3 = srcUser:GetProperty("AttrEffect")
  local bits3=CommonFun.getBits(AttrEffect3)


  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger) 

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  -------------------------------------------------------------------------------------------------------------紫毒短剑效果
  local Weapon=srcUser:GetEquipedID(7)
  local B = 1

  if (Weapon==40738 or Weapon==140738) then
     B = 2
  end 
  -------------------------------------------------------------------------------------------------------------紫毒短剑效果 (第四档)  
  local weaponRefineLv_2=srcUser:GetEquipedRefineLv(7)
  local zidu = 0

  if srcUser:HasBuffID(90001313)  then
     zidu = weaponRefineLv_2*0.1
  end  


  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+zidu)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*B 
  
  if 1 >= A then
         return 1
  end

  ----------------------------------------------------------血之泪
  local C = 1.25
  if srcUser:HasBuffID(90001040) then-----------------------血之泪升级
      C = 1.3
  end
  if srcUser:HasBuffID(90001046) then-----------------------血之泪再升级
      C = 1.3+0.1
  end
  ----------------------------------------------------------星盘毒刃
  local Num1=srcUser:GetRunePoint(31021)
  local Num2=srcUser:GetRunePoint(31022)
  local Num3=srcUser:GetRunePoint(31023)
  local RuneDamage=Num1*0.1+Num2*0.05+Num3*0.05+1
    --------------------------------------------------------目标处于中毒状态则毒刃造成的伤害翻倍&目标身上有毒刃和无影之牙的伤害加成效果 伤害增加25%
   if bits[CommonFun.AttrEffect.DuRenAndWuYingDam]==1 and bits2[CommonFun.StateEffect.Poison]==1 and bits3[CommonFun.AttrEffect.Hualiduanjian]==1 then 
         return  A*2*C*1.5*RuneDamage
   elseif bits[CommonFun.AttrEffect.DuRenAndWuYingDam]==1 and bits2[CommonFun.StateEffect.Poison]==1 then
         return  A*2*C*RuneDamage      
   elseif bits[CommonFun.AttrEffect.DuRenAndWuYingDam]==1 and bits3[CommonFun.AttrEffect.Hualiduanjian]==1 then
         return  A*C*1.5
   elseif bits2[CommonFun.StateEffect.Poison]==1 and bits3[CommonFun.AttrEffect.Hualiduanjian]==1 then     
         return  A*2*1.5*RuneDamage
   elseif bits[CommonFun.AttrEffect.DuRenAndWuYingDam]==1 then
         return  A*C
   elseif bits2[CommonFun.StateEffect.Poison]==1 then
         return  A*2*RuneDamage
   elseif bits3[CommonFun.AttrEffect.Hualiduanjian]==1 then
         return  A*1.5                  
   end      
         
   return A
end

--------------------------------------------------------------------------------------------------------盗贼音速投掷技能伤害计算公式(已改)
function CommonFun.calcDamage_3103(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")

  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
 
  local AttrEffect= srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)


  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")  
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)  

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  --print("Atk="..Atk,"BaseAtk="..BaseAtk,"AtkPer="..AtkPer,"bodyparam="..bodyparam,"elementparam="..elementparam,"elementparam2="..elementparam2,"raceparam="..raceparam)
  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ----------------------------------------------灰森灵卡片存储
  local card = 1
  if srcUser:HasBuffID(80012130) then
      card = 1.05
  end   

    ----------------------------------------------沙漠之风
  local shamo = 0
  local RefineLv1=srcUser:GetEquipedRefineLv(7)
  if srcUser:HasBuffID(90001293) then
    if RefineLv1==15 then 
      shamo = 1
    end   
  end
  ----------------------------------------------荒漠风暴
  if srcUser:HasBuffID(41850) then
    if RefineLv1==15 then 
      shamo = 1
    end   
  end
  ---------------------------------------时之吟游
  local Wing=srcUser:GetEquipedID(11)
  local RefineLv=srcUser:GetEquipedRefineLv(11)
  local time = 1
  if Wing == 45249 then
      time = 1 + RefineLv/100
  end 
  local Num1 = srcUser:GetRunePoint(33010)
  local RuneDamage = Num1*0.02
  local DefReduc2=math.min(1,DefReduc+RuneDamage)
  ---------------------------------------------------------------------------------------------------------------------------------------------------------包含被动技能音速强化带来的加成效果
  local A = ((AtkFinal*DefReduc2*(1-DamReduc2)+Refine)*(damChangePer+card+shamo)*(1+skilllv_1*0.2)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*time*card
  
  -----------------------------------------------十字斩
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  ----------------------------------------------------------
    if skillID==1111 then
        --------------------------------------------
        local skilllv_yintou = srcUser:GetLernedSkillLevel(181)---音速投掷
        local skilllv_shizi = srcUser:GetLernedSkillLevel(1111)---十字
        local damChangePer = 2.4
        if skilllv_yintou<=10 then
            damChangePer = 2+0.4*skilllv_yintou
        elseif skilllv_yintou>10 then
            damChangePer =6 + 0.2*(skilllv_yintou-10)
        end
        A = ((AtkFinal*DefReduc2*(1-DamReduc2)+Refine)*(damChangePer+card+shamo)*(1+skilllv_1*0.2)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*time*card*(1+0.06*skilllv_shizi)
    end

   if 1 >= A then
         return 1
   end
  
  if bits[CommonFun.AttrEffect.Hualiduanjian]==1 then
     return A*1.5
  end      
   
  return A    

end
-----------------------------------------------------------------------------------------------------------------------近战刺客系斩击技能伤害计算公式(已改)
function CommonFun.calcDamage_3104(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")  
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local Hp2 = targetUser:GetProperty("Hp")
  local MaxHp2 = targetUser:GetProperty("MaxHp")

  local damChangePer = damageParam.damChangePer
  local AttrEffect= srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger) 

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
   
   if 1 >= A then
         return 1
   end
   --------------------------------------------------------------------------------------------------------------------斩击效果当目标生命值低于当前血量伤害的30%时会造成额外伤害
   if Hp2<=MaxHp2*0.3 then
      if bits[CommonFun.AttrEffect.Hualiduanjian]==1 then
           return A*2*1.5
      else  
           return A*2
      end
   else
     if  bits[CommonFun.AttrEffect.Hualiduanjian]==1 then
           return A*1.5         
     end
   end   

   return A
  
end

-----------------------------------------------------------------------------------------------------------------------近战刺客系心灵震波技能伤害公式(已改)
function CommonFun.calcDamage_3105(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")
  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")   
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  local AttrEffect= srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)
 
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)  

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  local Num1=srcUser:GetRunePoint(32060)
  local Num2=srcUser:GetRunePoint(32080)
  local RuneDamage1=0.2*Num1+1
  local RuneDamage2=6*Num2

  --幸运短剑判断规则
  local Bracelet=srcUser:GetEquipedID(1)
  local Weapon=srcUser:GetEquipedID(7)
  local RefineLv=srcUser:GetEquipedRefineLv(7)
  local LuckKnifeRatio = 1

  --目前只有尼罗手环是算远程
  if RefineLv == 15 and (Weapon == 140715 or Weapon == 40715) and (Bracelet == 61506 or Bracelet == 161506) then
    LuckKnifeRatio=1.15
  end
  ------------------------------------------------尼罗手环精炼效果加成 
  local RefineLv1=srcUser:GetEquipedRefineLv(1)

  if RefineLv == 15 and (Weapon == 140715 or Weapon == 40715) and (Bracelet == 61506 or Bracelet == 161506)  and (RefineLv1>=10 and  RefineLv1<15) and srcUser:HasBuffID(90001863) then
    LuckKnifeRatio = LuckKnifeRatio+0.02
  elseif RefineLv == 15 and (Weapon == 140715 or Weapon == 40715) and (Bracelet == 61506 or Bracelet == 161506)  and  RefineLv1==15  and srcUser:HasBuffID(90001863)  then
    LuckKnifeRatio = LuckKnifeRatio+0.06
  end
  ------------------------------------------------------------------心灵威慑
  local StateEffect = targetUser:GetProperty("StateEffect")
  local bits=CommonFun.getBits(StateEffect)
  local skilllv_1 = srcUser:GetLernedSkillLevel(1108)
  local Fear = 1
  local WeaponType =srcUser:GetEquipedWeaponType()
  -----------------------------------------------------------------双刀增伤
  if skilllv_1>10 and WeaponType==250 then
      Fear = Fear + (skilllv_1-10)*0.03
  end
  -----------------------------------------------------------------恐惧增伤
  if bits[CommonFun.StateEffect.Fear] ==1 and skilllv_1>=1 then
      Fear = Fear + math.min(skilllv_1,10)*0.03
  end

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer+Int*(5*damChangePer1+20+RuneDamage2)+math.random(Int*5*RuneDamage1,Int*50*RuneDamage1)-Vit2*(1+VitPer2))*(1-RefineDamReduc)*(1+DamIncrease)*LuckKnifeRatio*Fear
  
  if 1 >= A then
      return 1
  end

  if bits[CommonFun.AttrEffect.Hualiduanjian]==1  then
     return A*1.5
  end   

--------------------------------------------------幸运短剑[4档]
  
  local Weapon=srcUser:GetEquipedID(7)
  local RefineLv7=srcUser:GetEquipedRefineLv(7)
  local xinling=0
  if (srcUser:HasBuffID(90001973) and RefineLv7>=10 )then 
     xinling=0.2
  end
  if Weapon==40715 or Weapon==140715 then 
     return A*(1.2+xinling)
  end

  
           
  return A
   
  end

---------------------------------------------------------------------------------------------------------------------------近战刺客强刃击伤害公式
function CommonFun.calcDamage_3106(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease) + damChangePer1)*(1-RefineDamReduc)-Vit2*(1+VitPer2)
      if 1 >= A then
         return 1
      end
  ---------------------------------------------------------------------------------------------------------------------星盘强刃击    
  local Num1=srcUser:GetRunePoint(31016)
  local StateEffect = targetUser:GetProperty("StateEffect")
  local bits=CommonFun.getBits(StateEffect)
  local a = Num1*10

  if bits[CommonFun.StateEffect.Poison] ==1  and CommonFun.IsInRate(a, srcUser:GetRandom()) and bits2[CommonFun.AttrEffect.Hualiduanjian]==1 then
        return A*2*1.5, CommonFun.DamageType.Crit
  elseif bits[CommonFun.StateEffect.Poison] ==1  and CommonFun.IsInRate(a, srcUser:GetRandom()) then 
        return A*2, CommonFun.DamageType.Crit
  elseif bits2[CommonFun.AttrEffect.Hualiduanjian]==1 then
        return A*1.5
  end 

  return A
end
  ---------------------------------------------------------------------------------------------------------------------------近战刺客系无影之牙伤害计算公式（已改）
function CommonFun.calcDamage_3201(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")
  local AttrEffect= srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local AttrEffect2= srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ----------------------------------------------------------------------------------------------------------------星盘无影之牙
  local Num1=srcUser:GetRunePoint(32026)
  local Num2=srcUser:GetRunePoint(32027)
  local Num3=srcUser:GetRunePoint(32028)
  local Num4=srcUser:GetRunePoint(32029)
  local Num5=srcUser:GetRunePoint(32030)
  local RuneDamage=Num1*0.1+Num2*0.05+Num3*0.05+Num4*0.1+Num5*0.05+1

  local Num6=srcUser:GetRunePoint(32019)
  local Num7=srcUser:GetRunePoint(32020)
  local Num8=srcUser:GetRunePoint(32021)
  local Num9=srcUser:GetRunePoint(32022)
  local Num10=srcUser:GetRunePoint(32023)
  local RuneDamage2=Num6*0.2+Num7*0.2+Num8*0.4+Num9*0.2+Num10*0.4+1
  local RuneRate=(Num6 + Num7 + Num8 + Num9 + Num10)*5

  
  local A =(((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease) + damChangePer1)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*RuneDamage
  
  if 1 >= A then
     return 1
  end
  ----------------------------------------------------------血之泪
  ----------------------------------------------------------血之泪再升级
  local B = 1
  if bits[CommonFun.AttrEffect.DuRenAndWuYingDam]==1 and srcUser:HasBuffID(90001044) and srcUser:HasBuffID(90001047)then
      B = 2
  elseif bits[CommonFun.AttrEffect.DuRenAndWuYingDam]==1 and srcUser:HasBuffID(90001044) then
      B = 1.8
  elseif bits[CommonFun.AttrEffect.DuRenAndWuYingDam]==1 then
      B = 1.5
  end
  ----------------------------------------------------------华丽短剑
  local C = 1
  if bits2[CommonFun.AttrEffect.Hualiduanjian]==1 then
      C = 1.5
  end

  if CommonFun.IsInRate(RuneRate, srcUser:GetRandom()) then
      return A*B*C*RuneDamage2, CommonFun.DamageType.Crit
  end
  
  --print("A="..A,"B="..B,"C="..C,"RuneDamage2="..RuneDamage2)

  return A*B*C
end
---------------------------------------------------------------------------------------------------------------------------近战刺客系剧毒暗器伤害公式
function CommonFun.calcDamage_3202(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)


  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ---------------------------------------------------------------------------------------------------------------------星盘剧毒暗器
  local Num1=srcUser:GetRunePoint(32006)
  local Num2=srcUser:GetRunePoint(32007)
  local Num3=srcUser:GetRunePoint(32008)
  local Num4=srcUser:GetRunePoint(32009)
  local RuneDamage=Num1*0.05+Num2*0.1+Num3*0.1+Num4*0.05+1

  local A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease) + damChangePer1)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*RuneDamage
      if 1 >= A then
         return 1
      end
  
  if bits2[CommonFun.AttrEffect.Hualiduanjian]==1 then
     return A*1.5
  end    

  return A
end
-----------------------------------------------------------------------------------------------------------------------近战刺客系技能黑暗瞬间伤害计算公式(已改)
function CommonFun.calcDamage_3301(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local AttrEffect2= srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")  
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local StateEffect2 = targetUser:GetProperty("StateEffect")
  local bits2=CommonFun.getBits(StateEffect2)

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger) 

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease)*(1-RefineDamReduc)-Vit2*(1+VitPer2)
   
   if 1 >= A then
         return 1
   end
  -----------------------------------------------------------------------------------------------------------------星盘黑暗瞬间
  local Num1=srcUser:GetRunePoint(32120)
  local a=0
  if Num1>0 then
    a=20
  end
  local RuneDamage=Num1*0.1+1
  -----------------------------------------------------------------------------------------------------------------装备上黑暗瞬间效果带来的伤害加成  
  if bits[CommonFun.AttrEffect.HeiAnDam]==1 and bits2[CommonFun.AttrEffect.Hualiduanjian]==1 and CommonFun.IsInRate(a, srcUser:GetRandom()) then
         return A*1.5*1.5*RuneDamage,CommonFun.DamageType.Crit
  elseif bits[CommonFun.AttrEffect.HeiAnDam]==1 and CommonFun.IsInRate(a, srcUser:GetRandom()) then
         return A*1.5*RuneDamage,CommonFun.DamageType.Crit
  elseif bits2[CommonFun.AttrEffect.Hualiduanjian]==1 and CommonFun.IsInRate(a, srcUser:GetRandom()) then
         return A*1.5*RuneDamage,CommonFun.DamageType.Crit
  elseif CommonFun.IsInRate(a, srcUser:GetRandom()) then
         return A*RuneDamage,CommonFun.DamageType.Crit
  elseif bits[CommonFun.AttrEffect.HeiAnDam]==1 then
         return A*1.5
  elseif bits2[CommonFun.AttrEffect.Hualiduanjian]==1 then
         return A*1.5                   
  end
  
  return A  

end
-----------------------------------------------------------------------------------------------------------------------十字切割者 技能 计算公式
function CommonFun.calcDamage_3401(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
 
  local WeaponType =srcUser:GetEquipedWeaponType()
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)
  local damChangePer  = damageParam.damChangePer
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
  
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  ----------------------------------------------------------回旋利刃
  if skillID==1104 then
    local Num1= srcUser:GetRunePoint(34010)------------星盘点
    local Num2 = srcUser:GetBuffLayer(116080)----------旋转点数
    A = A * (1+Num1*0.01*Num2)
  end
  -------------------------------------------------------------华丽短剑 伤害提高
    local AttrEffect2 = srcUser:GetProperty("AttrEffect")
    local bits=CommonFun.getBits(AttrEffect2)  

      if bits[CommonFun.AttrEffect.Hualiduanjian]==1 then
           return A*1.5
      end

  return A
end
-----------------------------------------------------------------------------------------------------------------------十字切割者 回旋十字斩 计算公式
function CommonFun.calcDamage_3402(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
 
  local WeaponType =srcUser:GetEquipedWeaponType()
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)
  local damChangePer  = damageParam.damChangePer
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local Num1 = srcUser:GetBuffLayer(116080)--------------------------旋转点数
  local Numxp= srcUser:GetRunePoint(34020)------------星盘点
  local Point = 1+Num1*(0.2+Numxp*0.03)

  ----------------------------洛奇的指甲
  local RefineLv7=srcUser:GetEquipedRefineLv(7)
  local luoqi = 1

  if srcUser:HasBuffID(90001038) then   
    if ( RefineLv7>=5 and RefineLv7<10) then 
      luoqi=0.05 + 1
      elseif  (RefineLv7>=10 and RefineLv7<15) then 
      luoqi=0.05 + 0.05 + 1
      elseif RefineLv7 ==15 then
      luoqi=0.05 + 0.05 + 0.1 + 1
    end
  end
   ----------------------------死亡切割
  if srcUser:HasBuffID(41860) then   
    if ( RefineLv7>=5 and RefineLv7<10) then 
      luoqi=0.05 + 1
      elseif  (RefineLv7>=10 and RefineLv7<15) then 
      luoqi=0.05 + 0.05 + 1
      elseif RefineLv7 ==15 then
      luoqi=0.05 + 0.05 + 0.1 + 1
    end
  end
  ----------------------------风行者斗篷
  local RefineLv3=srcUser:GetEquipedRefineLv(3)
  if srcUser:HasBuffID(90001963) and RefineLv3 > 5 then   
    luoqi =luoqi + (RefineLv3-5)* 0.01 
  end
  ---------------------------------洛奇的指甲Ⅸ＋风行者斗篷
  if srcUser:HasBuffID(90001038) and srcUser:HasBuffID(40420) then 
    luoqi =luoqi + 0.05
  end
  ---------------------------------死亡切割＋风行者斗篷
  if srcUser:HasBuffID(41860) and srcUser:HasBuffID(40420) then 
    luoqi =luoqi + 0.05
  end


  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*Point*luoqi
  -------------------------------------------------------------华丽短剑
    local AttrEffect2 = srcUser:GetProperty("AttrEffect")
    local bits=CommonFun.getBits(AttrEffect2)

      if bits[CommonFun.AttrEffect.Hualiduanjian]==1 then
           return A*1.5
      end

  return A
end

  ------------------------------------------------------------------------------------------------------------------弓手二连矢技能伤害计算公式(已改)
function CommonFun.calcDamage_4101(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")   
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger) 

  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  ------------------------------------------------------------------------巅峰等级 苍鹰之眼
  local targetid = targetUser:GetGuid()
  local distance = srcUser:GetDistance(targetid)
  local skilllv_1 = srcUser:GetLernedSkillLevel(133)
  local DisDam= 1
  if skilllv_1>10 then 
      DisDam = 1 + distance/7.5*(skilllv_1-10)*0.06
  end

  local A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease-LongRangeDamReduc2) + damChangePer1)*(1- RefineDamReduc)-Vit2*(1+VitPer2))*DisDam
   
  if 1 >= A then
      return 1
  end
 ---------------------------------------------------------------------------------------------------------------------装备或卡片上有二连矢加伤百分比的效果
  if bits[CommonFun.AttrEffect.ErLianDam]==1 then  
     return A*1.5
  end
     
     return A    

end

-------------------------------------------------------------------------------------------------------------------弓手冲锋箭技能伤害计算公式(已改)
function CommonFun.calcDamage_4102(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")   
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger) 

  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  local Weapon=srcUser:GetEquipedID(7)
  local B = 1

  if (Weapon==41232 or Weapon==141232) then
     B = 2
  end
  ---------------------------------------------------------------------------星盘冲锋箭
  local Num1=srcUser:GetRunePoint(41016)
  local Num2=srcUser:GetRunePoint(41017)
  local Num3=srcUser:GetRunePoint(41018)
  local Num4=srcUser:GetRunePoint(41019)
  local Num5=srcUser:GetRunePoint(41020)
  local RuneDamage1=Num1*0.05+Num2*0.05+Num3*0.05+Num4*0.05+Num5*0.05+1

  local Num6=srcUser:GetRunePoint(41014)
  local Num7=srcUser:GetRunePoint(41015)
  local StateEffect = targetUser:GetProperty("StateEffect")
  local bits=CommonFun.getBits(StateEffect)
  local RuneDamage2=1
  
  if bits[CommonFun.StateEffect.NoMove] ==1 then 
     RuneDamage2=Num6*0.15+Num7*0.15+1
  end

  local A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease-LongRangeDamReduc2) + damChangePer1)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*B*RuneDamage1*RuneDamage2

   
  if 1 >= A then
      return 1
  end
 
  return A    

end
------------------------------------------------------------------------------------------------------------------箭雨伤害公式
function CommonFun.calcDamage_4103(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = targetUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)


  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  -------------------------------------------------------------------------------------------星盘箭雨
  local Num1=srcUser:GetRunePoint(41001)
  local Num2=srcUser:GetRunePoint(41002)
  local Num3=srcUser:GetRunePoint(41003)
  local Num4=srcUser:GetRunePoint(41004)
  local Num_srwn=srcUser:GetRunePoint(102006)---诗人舞娘
  local RuneDamage=Num1*0.05+Num2*0.1+Num3*0.05+Num4*0.05+Num_srwn*0.05+1
  -------------------------------------------------------------------------------------------星盘火箭雨暴击
  local Rate = 0
  local Num1=srcUser:GetRunePoint(41007)
  local UserArrow = srcUser:GetArrowID()
  local ArrowAttr = 0
  if UserArrow ~=0 then
     ArrowAttr = CommonFun.GetAtkAttrByArrow(UserArrow)
  end

  if ArrowAttr ==4 and Num1>0 then
      Rate=10
  end
  ----------------------------------------------------------------------------------------卡片箭雨
  local card1 =1
  local RefineLv1=srcUser:GetEquipedRefineLv(7)
  local CardNum = srcUser:GetEquipCardNum(7,24053)-------------获取武器部位 万箭增发卡 卡片数量
  if srcUser:HasBuffID(52410) then 
    card1 =RefineLv1*0.02*CardNum+1
  end

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease-LongRangeDamReduc2)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*RuneDamage*card1
   
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  ----------------------------------------------------------------------------箭矢风暴
  if skillID ==1246 then
      local skilllv_Arrow = srcUser:GetLernedSkillLevel(1246) -----箭矢风暴 等级
      local skilllv_Rain = srcUser:GetLernedSkillLevel(121)--------箭雨 等级
      local damChangePer = 0.75
      if skilllv_Rain<=10 then
          damChangePer = 0.75 + (skilllv_Rain-1)*0.15
      elseif skilllv_Rain>10 then
          damChangePer = 2.1 + (skilllv_Rain-10)*0.3
      end

      A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease-LongRangeDamReduc2)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*RuneDamage*card1*(skilllv_Arrow*0.2+1.6)
  end
  ----------------------------------------------------------------------------狂风暴雨
  if skillID ==1384 or skillID== 1433 then
      local skilllv_wn = srcUser:GetLernedSkillLevel(1384) -----箭矢风暴 等级 (舞娘)
      local skilllv_sr = srcUser:GetLernedSkillLevel(1433) -----箭矢风暴 等级 (诗人)
      local skill_all = skilllv_wn + skilllv_sr

      local skilllv_Rain = srcUser:GetLernedSkillLevel(121)--------箭雨 等级
      local damChangePer = 0.75
      if skilllv_Rain<=10 then
          damChangePer = 0.75 + (skilllv_Rain-1)*0.15
      elseif skilllv_Rain>10 then
          damChangePer = 2.1 + (skilllv_Rain-10)*0.3
      end

   -------------------------------------------------------------------------贝斯或秘鞭眷恋
      local RefineLv=srcUser:GetEquipedRefineLv(7)
      local beisi=1
      local Ring1=srcUser:GetEquipedID(7)
      if (Ring1==63109 or Ring1==163109 or Ring1==62820 or Ring1==162820) then
            beisi = 1 + RefineLv * 0.02
      end
      -----------------------------------------狂风暴雨 星盘
      local Num_kfby=srcUser:GetRunePoint(102040)

      A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease-LongRangeDamReduc2)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*RuneDamage*card1*(skill_all*0.04+0.4)*beisi*(1+Num_kfby*0.06)
  end

   if 1 >= A then
         return 1
   end
  
   if CommonFun.IsInRate(Rate, srcUser:GetRandom()) then
      return A*1.5, CommonFun.DamageType.Crit
   end    

   return A

end
------------------------------------------------------------------------------------------------------------------分裂箭伤害公式
function CommonFun.calcDamage_4201(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = targetUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)


  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ------------------------------------------------------------------------------星盘分裂箭
  local Num1=srcUser:GetRunePoint(42016)
  local Num2=srcUser:GetRunePoint(42018)
  local Num3=srcUser:GetRunePoint(42019)
  local Num4=srcUser:GetRunePoint(42020)
  local Num5=srcUser:GetRunePoint(42021)
  local RuneDamage=Num1*0.05+Num2*0.05+Num3*0.05+Num4*0.05+Num5*0.1+1
  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease-LongRangeDamReduc2)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*RuneDamage
   
   if 1 >= A then
         return 1
   end

   return A

end

------------------------------------------------------------------------------------------------------------------远程物理陷阱技能（地雷陷阱）伤害计算公式(已改)
function CommonFun.calcDamage_4202(srcUser, targetUser, params, damageParam, logger)
  local BaseLv = srcUser.BaseLv
  local Dex = srcUser:GetProperty("Dex")
  local Int = srcUser:GetProperty("Int")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
 

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
   ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  local skilllv_2 = srcUser:GetLernedSkillLevel(damageParam.skill2_id)

  local AttrEffect = srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local damChangePer = damageParam.damChangePer

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  -------------------------------------------------------------------------------------------------------------------星盘地雷陷阱
  local StateEffect = targetUser:GetProperty("StateEffect")
  local bits2=CommonFun.getBits(StateEffect)
  local Num6 = srcUser:GetRunePoint(42050)
  local RuneDamage2=1
  if bits2[CommonFun.StateEffect.NoMove] ==1 then
        RuneDamage2=1+Num6*0.1
  end
  -------------------------------------------装备升级  星尘外套+月亮胸针
  local suit = 1
  if srcUser:HasBuffID(90000773) and srcUser:HasBuffID(90001005) then
      suit = 1.1
  end
  -------------------------------------------星尘外套[第八档]
  local RefineLv2=srcUser:GetEquipedRefineLv(2)
  if srcUser:HasBuffID(90000777) then 
        if (RefineLv2>=10 and RefineLv2<15) then 
        suit =suit+(RefineLv2-10)* 0.02 
         elseif RefineLv2 ==15 then
         suit =suit+(RefineLv2-10)* 0.02 + 0.05  
        end
    end
      -------------------------------------------露娜弓[第八档]
  local RefineLv7=srcUser:GetEquipedRefineLv(7)
    if srcUser:HasBuffID(90000999) then 
        if (RefineLv7>=10 and RefineLv7<15) then 
        suit =suit+0.08
        elseif RefineLv7 ==15 then
         suit =suit+0.08+0.12
        end
    end
    -------------------------------------------月光女神
    if srcUser:HasBuffID(41812) then 
      if (RefineLv7>=5 and RefineLv7<10) then 
           suit =suit+0.05
      elseif(RefineLv7>=10 and RefineLv7<15) then 
           suit =suit+0.05+0.1
      elseif RefineLv7 ==15 then
           suit =suit+0.05+0.1+0.15
      end
    end
    ----------------------------------------------------------------月亮胸针[第十档]
  
  local RefineLv5=srcUser:GetEquipedRefineLv(5)
  local RefineLv6=srcUser:GetEquipedRefineLv(6)

  local a = 0
  local b = 0
  if srcUser:HasBuffID(90001009)  then
      a = RefineLv5*0.01
  end
  if srcUser:HasBuffID(90001009) then
      b = RefineLv6*0.01
  end
  suit = suit + a + b  
  -------------------------------------------炽天使精炼
  local Angel = 1
  if srcUser:HasBuffID(90001014) then 
      local RefineLv=srcUser:GetEquipedRefineLv(7)
      Angel = 1 + 0.02*RefineLv
  end
  -------------------------------------------------------------------------------------------------------------------星盘陷阱研究
  local Num7 = srcUser:GetRunePoint(42060)
  local RuneDamage3 = 1+Num7*0.03*skilllv_1


  --------------------------------------------------------------------------------------------------------------------地雷陷阱等级大于5级
  local Refine = srcUser:GetProperty("Refine")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local skilllv_add = srcUser:GetLernedSkillLevel(116)
  local atk_add = 0

  if skilllv_add > 5 then
    atk_add = (Atk*(1+AtkPer)+Refine)*((skilllv_add-5)*0.05)
  end
  ------------------------------------------------------三转器械专家
  local skilllv_trap = srcUser:GetLernedSkillLevel(1248)
  local trap = 1 + skilllv_trap*0.02

  local A = ((Dex*(3+BaseLv/100)*(1+Int/35)+atk_add)*damChangePer+skilllv_1*20*RuneDamage3)*DefReduc*(1+MDamIncrease)*(1-RefineMDamReduc)*(1-MDamReduc2)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2*raceparam*bossparam*RuneDamage2*suit*Angel*trap

  if 1 >= A then
    return 1
  end
  ------------------------------------------------------------------------------------手动引爆时伤害额外增加
  local Num1 = srcUser:GetRunePoint(42031)--------------------------------------------星盘引爆伤害
  local Num2 = srcUser:GetRunePoint(42032)
  local Num3 = srcUser:GetRunePoint(42033)
  local Num4 = srcUser:GetRunePoint(42034)
  local Num5 = srcUser:GetRunePoint(42035)
  local RuneDamage = Num1*0.1+Num2*0.05+Num3*0.05+Num4*0.1+Num5*0.05+1

  if bits[CommonFun.AttrEffect.TriggerTrapMark]==1 then
      return A*(1+skilllv_2*0.1)*RuneDamage
  end
      
      return A     
end
------------------------------------------------------------------------------------------------------------------远程物理陷阱技能（电击陷阱）伤害计算公式(已改)
function CommonFun.calcDamage_4203(srcUser, targetUser, params, damageParam, logger)
  local BaseLv = srcUser.BaseLv
  local Dex = srcUser:GetProperty("Dex")
  local Int = srcUser:GetProperty("Int")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
 

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
   ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  local skilllv_2 = srcUser:GetLernedSkillLevel(damageParam.skill2_id)

  local AttrEffect = srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local damChangePer = damageParam.damChangePer

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  -------------------------------------------装备升级  星尘外套+月亮胸针
  local suit = 1
  if srcUser:HasBuffID(90000773) and srcUser:HasBuffID(90001005) then
      suit = 1.1
  end
  -------------------------------------------星尘外套[第八档]
  local RefineLv2=srcUser:GetEquipedRefineLv(2)
  if srcUser:HasBuffID(90000777) then 
        if (RefineLv2>=10 and RefineLv2<15) then 
        suit =suit+(RefineLv2-10)* 0.02 
         elseif RefineLv2 ==15 then
         suit =suit+(RefineLv2-10)* 0.02 + 0.05  
        end
    end
    -------------------------------------------露娜弓[第八档]
  local RefineLv7=srcUser:GetEquipedRefineLv(7)
    if srcUser:HasBuffID(90000999) then 
        if (RefineLv7>=10 and RefineLv7<15) then 
        suit =suit+0.08
        elseif RefineLv7 ==15 then
         suit =suit+0.08+0.12
        end
    end
    -------------------------------------------月光女神
    if srcUser:HasBuffID(41812) then 
      if (RefineLv7>=5 and RefineLv7<10) then 
           suit =suit+0.05
      elseif(RefineLv7>=10 and RefineLv7<15) then 
           suit =suit+0.05+0.1
      elseif RefineLv7 ==15 then
           suit =suit+0.05+0.1+0.15
      end
    end
     ----------------------------------------------------------------月亮胸针[第十档]
  
  local RefineLv5=srcUser:GetEquipedRefineLv(5)
  local RefineLv6=srcUser:GetEquipedRefineLv(6)

  local a = 0
  local b = 0
  if srcUser:HasBuffID(90001009)  then
      a = RefineLv5*0.01
  end
  if srcUser:HasBuffID(90001009) then
      b = RefineLv6*0.01
  end
  suit = suit + a + b  
  -------------------------------------------炽天使精炼
  local Angel = 1
  if srcUser:HasBuffID(90001014) then 
      local RefineLv=srcUser:GetEquipedRefineLv(7)
      Angel = 1 + 0.02*RefineLv
  end
  -------------------------------------------------------------------------------------------------------------------星盘陷阱研究
  local Num7 = srcUser:GetRunePoint(42060)
  local RuneDamage3 = 1+Num7*0.03*skilllv_1
  ------------------------------------------------------三转器械专家
  local skilllv_trap = srcUser:GetLernedSkillLevel(1248)
  local trap = 1 + skilllv_trap*0.02
  -------------------------------------------------星盘电击
  local NumDj = srcUser:GetRunePoint(44080)
  local RuneDj = 1 + NumDj*0.08

  local A = ((Dex*(3+BaseLv/100)*(1+Int/35))*damChangePer+skilllv_1*20*RuneDamage3)*DefReduc*(1+MDamIncrease)*(1-RefineMDamReduc)*(1-MDamReduc2)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2*raceparam*bossparam*suit*Angel*trap*RuneDj

  if 1 >= A then
    return 1
  end
  ------------------------------------------------------------------------------------手动引爆时伤害额外增加
  local Num1 = srcUser:GetRunePoint(42031)--------------------------------------------星盘引爆伤害
  local Num2 = srcUser:GetRunePoint(42032)
  local Num3 = srcUser:GetRunePoint(42033)
  local Num4 = srcUser:GetRunePoint(42034)
  local Num5 = srcUser:GetRunePoint(42035)
  local RuneDamage = Num1*0.1+Num2*0.05+Num3*0.05+Num4*0.1+Num5*0.05+1

  if bits[CommonFun.AttrEffect.TriggerTrapMark]==1 then
      return A*(1+skilllv_2*0.1)*RuneDamage
  end
      
      return A     
end
------------------------------------------------------------------------------------------------------------------多重扫射远程物理伤害计算公式(已改)
function CommonFun.calcDamage_4301(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = targetUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)


  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  -------------------------------------------------------------------------------------星盘多重扫射
  local Num1 = srcUser:GetRunePoint(42110)
  local RuneDamage = 1+Num1*0.1
  
---------------------------------------------------------------------------------------卡片多重扫射
  local card1 =1
  local RefineLv1=srcUser:GetEquipedRefineLv(7)
  local CardNum = srcUser:GetEquipCardNum(7,24053)-------------获取武器部位 万箭增发卡 卡片数量
  if srcUser:HasBuffID(52410) then 
    card1 =RefineLv1*0.02*CardNum+1
   end 

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease-LongRangeDamReduc2)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*RuneDamage*card1
   
   if 1 >= A then
         return 1
   end

   return A

end

------------------------------------------------------------------------------------------------------------------死亡狙击 伤害公式
function CommonFun.calcDamage_4401(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = targetUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)


  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  ----------------------------------------------------森林猎手
  local hunter = 0
  local Forest = 1
  local Ring7=srcUser:GetEquipedID(7)
  local RefineLv7=srcUser:GetEquipedRefineLv(7)
  if (Ring7==41246 or Ring7==141246) and RefineLv7>8 then
      hunter=hunter+(RefineLv7-8)*0.1
    end 
  if srcUser:HasBuffID(91000430) then 
      hunter=hunter+0.5
    end
  if (Ring7==41246 or Ring7==141246) and RefineLv7==15 then
      Forest=Forest+0.1
    end 
  ------------------------------------------------星盘
  local Num = srcUser:GetRunePoint(44050)
  local Num2 = srcUser:GetRunePoint(44060) ----暴击
  local RuneDamage = 1 + Num*0.05

  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+hunter)*(1+DamIncrease-LongRangeDamReduc2)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*Forest*RuneDamage
  -----------------------------------------死亡狙击可进行暴击
  local Cri = srcUser:GetProperty("Cri")
  local CriRes2 = targetUser:GetProperty("CriRes")
  local CriDamPer = srcUser:GetProperty("CriDamPer")
  local CriDefPer2 = targetUser:GetProperty("CriDefPer")

  local Rate = (Cri-CriRes2)/3+Num2*3

  if CommonFun.IsInRate(Rate, srcUser:GetRandom()) then
      A = ((AtkFinal*(1-DamReduc2)+Refine)*(damChangePer+hunter)*(1+DamIncrease-LongRangeDamReduc2)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*Forest*RuneDamage
     
      return A * (1.5+CriDamPer-CriDefPer2) , CommonFun.DamageType.Crit
  end

   if 1 >= A then
         return 1
   end

   return A

end

------------------------------------------------------------------------------------------------牧师治愈术治疗计算公式(已改)
------------------------------------------------------------------------------------------------【下面有个BUFF效果需要用到这里的伤害公式，每次更改时需要同步修改】
function CommonFun.calcDamage_5101(srcUser, targetUser, params, damageParam, logger)
  local BaseLv = srcUser.BaseLv
  local Int = srcUser:GetProperty("Int")
  local HolyAtk = srcUser:GetProperty("HolyAtk")
  local HealEncPer = srcUser:GetProperty("HealEncPer")
  local enemy=srcUser:IsEnemy(targetUser)
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)

  local skilllv_1 = srcUser:GetLernedSkillLevel(50034)
  local skilllv_2 = srcUser:GetLernedSkillLevel(50035)
  ------------------------------------------------------------------------------------------------治愈术-强效
  local Num1=srcUser:GetRunePoint(51001)
  local Num2=srcUser:GetRunePoint(51011)
  local RuneDamage=Num1*0.02 + Num2*0.02 + 1
  ------------------------------------------------------------------------------------------------白素贞卡片
  local c=1
  if srcUser:HasBuffID(51580) then
        c=1.1
  end
  ------------------------------------------------------------------------------------------------大天使之盾
  local RefineLv = srcUser:GetEquipedRefineLv(1)
  local Angel = 1
  if srcUser:HasBuffID(40430) then
     Angel = 1 + RefineLv/100
  end

  --------------------------------------------------------------------------大天使之盾升级
  if srcUser:HasBuffID(90001813) then
     if (RefineLv>=5 and RefineLv<10) then 
        Angel=Angel+0.03
       elseif RefineLv>=10 then
        Angel=Angel+0.03+0.07
    end
  end

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")

  local BeHealEncPer2 = targetUser:GetProperty("BeHealEncPer")
  local race2 = targetUser.race
  local DefAttr2=targetUser:GetProperty("DefAttr")


  local AttrEffect = targetUser:GetProperty("AttrEffect2")
  local bits=CommonFun.getBits(AttrEffect)
  
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1
   ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  --------------------------------------------------------------------------------------治愈术基本治疗量公式
  
  local A=((math.floor((BaseLv+Int)/10)*damChangePer+100 + skilllv_1*50 + skilllv_2*50)*(1+HealEncPer)*(1+BeHealEncPer2) + damChangePer1)*(-1)*(1+HolyAtk)*RuneDamage*c*Angel

  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  ----------------------------------------------------------治愈之光
  if skillID==1224 then
    local skilllv_3 = srcUser:GetLernedSkillLevel(144)
    local damChangePer = 4
      if skilllv_3<=10 then 
        damChangePer = 4+skilllv_3*8
      elseif skilllv_3>10 then
        damChangePer =64+ skilllv_3*2
      end
    --------------------------------------------------星盘
    local MaxHp = targetUser:GetProperty("MaxHp")
    local Hp = targetUser:GetProperty("Hp")
    local Num = srcUser:GetRunePoint(54030)
    local RuneDamage1 = (MaxHp-Hp)*0.02*Num

    A=((math.floor((BaseLv+Int)/10)*damChangePer+100 + skilllv_1*50 + skilllv_2*50)*damChangePer1*(1+HealEncPer)*(1+BeHealEncPer2))*(-1)*(1+HolyAtk)*RuneDamage*c*Angel-RuneDamage1
  end
  -----------------------------------------------十字军濒死回复
  if targetUser:HasBuffID(41100050) then
      local MaxHp = targetUser:GetProperty("MaxHp")
      local Hp = targetUser:GetProperty("Hp")
      local Num1  = targetUser:GetBuffLayer(41100050)
      if Hp<MaxHp*(0.15*Num1) then
         A = A*3
      end
  end

  --------------------------------------------------------------------------------------对不死属性和不死种族怪物造成治疗量/2的圣属性伤害
  --------------------------------------------------------------------------------------这里的正值代表是伤害效果,负值是治疗效果
  if enemy then
        if DefAttr2==9 then
            return A/2*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2*(-1)*(1+MDamIncrease)
        else   
            return 0,0
        end   
  else
        if DefAttr2==9 or bits[CommonFun.AttrEffect.PoisinDamNoUse]==1 then
            return -1
        else   
            return A
        end
  end 
end



--------------------------------------------------------------------------------------------------牧师系新转生术伤害公式(已改)
function CommonFun.calcDamage_5102(srcUser, targetUser, params, damageParam, logger)
  local BaseLv = srcUser.BaseLv
  local Int = srcUser:GetProperty("Int")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local DefAttr2=targetUser:GetProperty("DefAttr")
  
  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  
  local damChangePer = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  local A=(BaseLv+Int+damChangePer)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2*(1+MDamIncrease)
  
  -------------------------------对恶魔种族伤害单独计算
  local race2 = targetUser.race

  if race2==3 then
    local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
    local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger) 
    local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
    local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
    local MAtk = srcUser:GetProperty("MAtk")
    local MAtkPer = srcUser:GetProperty("MAtkPer")
    local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
    local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
    local MRefine = srcUser:GetProperty("MRefine")

    local BaseMAtk  = Int+math.floor(Int*Int/100)
    local MAtkFinal = ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2
    ----------------------------魔法防御减免
    local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
    -------------------------------星盘
    local Num0 = srcUser:GetRunePoint(52180)
    local RuneDamage0 = Num0

    A = (MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*(damChangePer1+RuneDamage0)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2
  end

  if 1>= A then
    A=1
  end  
  ------------------------------------------------------------------------------------------------------------------星盘加成吸血效果
  local Num1 = srcUser:GetRunePoint(51014)
  local Num2 = srcUser:GetRunePoint(51018)
  local Num3 = srcUser:GetRunePoint(52027)
  local RuneDamage = (Num1 + Num2 + Num3)*0.07
  -------------------------------------------------------------------------------------------------------------------分割线
  if targetUser.isServerCall then -- 服务端调用
     if RuneDamage>0 then
       if DefAttr2 == CommonFun.Nature.Undead then
            srcUser:DoExtraDamage(A*(-1)*RuneDamage)
       else
            srcUser:DoExtraDamage(A*(-1)*RuneDamage*0.5)
       end
    end      
  end   
 
  return A

end

-- ----------------------------------------------------------------------------------------------------服事十字驱魔攻击计算公式(已改)
function CommonFun.calcDamage_5103(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  local MRefine = srcUser:GetProperty("MRefine")
  
  local enemy=srcUser:IsEnemy(targetUser)
  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")

 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local race2 = targetUser.race
  local DefAttr2=targetUser:GetProperty("DefAttr")
  
  local AttrEffect= srcUser:GetProperty("AttrEffect2")
  local bits=CommonFun.getBits(AttrEffect)
  
  local damChangePer = damageParam.damChangePer
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger) 
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseMAtk  = Int+math.floor(Int*Int/100)
  local MAtkFinal = ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
  -----------------------------------------------------星盘 十字驱魔
  local Num1 = srcUser:GetRunePoint(52037)
  local RuneDamage = Num1*0.3
  --------------------------------------------------------十字驱魔增强
  local qumo = 1
  if bits[CommonFun.AttrEffect2.Shiziqumo]==1 then
       qumo = 1.2
  end
  --------------------------------------------------------复仇女神增强
  local weaponRefineLv=srcUser:GetEquipedRefineLv(7)
   if srcUser:HasBuffID(90001413) then
      qumo=weaponRefineLv*0.01+qumo
   end  
  --------------------------------------------------------厄利尼厄斯之杖

  if srcUser:HasBuffID(41980) then
      qumo=weaponRefineLv*0.01+qumo
   end   


  --------------------------------------------------------驱魔圣经增强
  local weaponRefineLv2=srcUser:GetEquipedRefineLv(1)
   if srcUser:HasBuffID(90001423) then
      qumo=weaponRefineLv2*0.01+qumo
   end  
  -----------------------------------------------------巅峰等级 转生术 提高倍率
  local skilllv_1 = srcUser:GetLernedSkillLevel(160)
  local SkillPer = 0
  if skilllv_1 >10 then 
    SkillPer = (skilllv_1-10)*0.1
  end

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*(damChangePer+RuneDamage+SkillPer)-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2*qumo
  
  if 1 >= A then
    return 1
  end
  ----------------------------------------------只有特定类型的怪物才会受到伤害
  local Num2 = srcUser:GetRunePoint(52030)

  if enemy then
     if race2==3 or DefAttr2==9 then
          return A
     elseif Num2>0 then
          return A * Num2 * 0.07
     end
  else
       return 0,0
  end

  return 0, 0

end
----------------------------------------------------------------------------------------------------------------------------服事系光耀之堂技能公式修改(已改)
function CommonFun.calcDamage_5104(srcUser, targetUser, params, damageParam, logger)
  local BaseLv = srcUser.BaseLv
  local Int = srcUser:GetProperty("Int")
  local HolyAtk = srcUser:GetProperty("HolyAtk")
  local HealEncPer = srcUser:GetProperty("HealEncPer")
  local enemy=srcUser:IsEnemy(targetUser)
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)

  ------------------------------------------------------------------------------------------------------------------星盘加成额外治愈量效果
  local Num1 = srcUser:GetRunePoint(51010)
  local RuneDamage = Num1*0.15 + 1
  local Num2 = srcUser:GetRunePoint(53020)
  local RuneDamage1 = Num2*0.02 + 1
  ------------------------------------------------------------------------------------------------------------------白素贞卡片
  local c=1
  if srcUser:HasBuffID(51580) then
        c=1.1
  end

  local AttrEffect = srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")

  local BeHealEncPer2 = targetUser:GetProperty("BeHealEncPer")
  local race2 = targetUser.race
  local AttrEffect2 = targetUser:GetProperty("AttrEffect")
  local DefAttr2=targetUser:GetProperty("DefAttr")
  
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  --------------------------------------------------------------------------------------治愈术基本治疗量公式
  
  --local A=(math.floor((BaseLv+Int)/10)*damChangePer*(1+HealEncPer)*(1+BeHealEncPer2) + damChangePer1)*(-1)
  local A=damChangePer1*(1+HealEncPer)*(1+BeHealEncPer2)*(-1)*(1+HolyAtk)*RuneDamage*c*RuneDamage1
  -----------------------------------------------十字军濒死回复
  if targetUser:HasBuffID(41100050) then
      local MaxHp = targetUser:GetProperty("MaxHp")
      local Hp = targetUser:GetProperty("Hp")
      local Num1  = targetUser:GetRunePoint(70110)
      if Hp<MaxHp*(0.15*Num1) then
         return A*3
      end
  end
  --------------------------------------------------------------------------------------对不死属性和不死种族怪物造成治疗量/2的圣属性伤害
  --------------------------------------------------------------------------------------这里的正值代表是伤害效果,负值是治疗效果
  if enemy then
        if race2==3 or DefAttr2==9 then
            return A/2*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2*(-1)*(1+MDamIncrease)
        else   
            return 0,0
        end   
  else
        if race2==3 or DefAttr2==9 then
            return -1
        else   
            return A
        end
  end 

end

-- ----------------------------------------------------------------------------------------------------服事审判技能攻击计算公式(已改)
function CommonFun.calcDamage_5105(srcUser, targetUser, params, damageParam, logger)
  local BaseLv = srcUser.BaseLv
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  local Luk=srcUser:GetProperty("Luk")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  local enemy=srcUser:IsEnemy(targetUser)

 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local race2 = targetUser.race
  local DefAttr2=targetUser:GetProperty("DefAttr")
  
  local damChangePer = damageParam.damChangePer
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)   

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal = ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
 --------------------------------------------------------------------------------------------------------------复仇女神效果
  local Weapon=srcUser:GetEquipedID(7)
  local B = 0

  if (Weapon==41521 or Weapon==141521 or Weapon==41568 or Weapon==141568) then
     B = Luk*50
  end    

  local WeaponRefineLv=srcUser:GetEquipedRefineLv(7)
  if srcUser:HasBuffID(90001413) or srcUser:HasBuffID(41980) then
    if WeaponRefineLv==15 then
      B = B*2
    end
  end
   

  local A = (((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*BaseLv/50 + B*MDefReduc*(1-MDamReduc2)*(1-RefineMDamReduc))-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2

  if srcUser:HasBuffID(52140) then
        A = A * 1.05
  end

  if 1 >= A then
    return 1
  end
  
  return A

end
-----------------------------------------------------------------------------------------------------佣兵猫使用治愈术
function CommonFun.calcDamage_5106(srcUser, targetUser, params, damageParam, logger)
  local BaseLv = srcUser.BaseLv
  local Int = srcUser:GetProperty("Int")
  local HealEncPer = srcUser:GetProperty("HealEncPer")
  local enemy=srcUser:IsEnemy(targetUser)
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")

  local BeHealEncPer2 = targetUser:GetProperty("BeHealEncPer")
  local race2 = targetUser.race
  local DefAttr2=targetUser:GetProperty("DefAttr")
  
  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  if damChangePer1 == nil then
    damChangePer1 = 0
  end

   ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  --------------------------------------------------------------------------------------治愈术基本治疗量公式
  
  local A=((math.floor((BaseLv+Int)/10)*damChangePer+100)*(1+HealEncPer)*(1+BeHealEncPer2) + damChangePer1)*(-1)
      if 0 <= A then
         return -1
      end
    
        return A
end
-----------------------------------------------------------------------------------------------------------------大主教双重圣光技能伤害计算公式(已改)
function CommonFun.calcDamage_5401(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  ---------------------------------星盘
  local Num = srcUser:GetRunePoint(54080)
  local RuneDamage = 1+Num*0.05

  local A = (((AtkFinal+MAtkFinal)*(1-DamReduc2)+Refine+MRefine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage


   if 1 >= A then
         return 1
   end

   return A
end
--------------------------------------------------------------------------------------------------------------------------赞歌伤害计算公式(已改)
function CommonFun.calcDamage_5402(srcUser, targetUser, params, damageParam, logger)
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")

  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2
  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  ----------------------------审判之锤+审判之袍+审判之靴
  local Trial1 = 0
  local Trial2 = 1
  local Ring1=srcUser:GetEquipedID(7)
  local RefineLv7=srcUser:GetEquipedRefineLv(7)
  local Ring2=srcUser:GetEquipedID(2)
  local RefineLv2=srcUser:GetEquipedRefineLv(2)
  local Ring3=srcUser:GetEquipedID(4)
  local RefineLv4=srcUser:GetEquipedRefineLv(4)

  if (Ring1==41526 or Ring1==141526) and RefineLv7>5 then
       Trial1=Trial1+(RefineLv7-5)*0.2
  end 
  if (Ring2==42076 or Ring2==142076) and RefineLv2>=10 then
       Trial1=Trial1+1
  end
  ----------------------------裁决之锤
  if (Ring1==41565 or Ring1==141565) and RefineLv7>5 then
       Trial1=Trial1+(RefineLv7-5)*0.2
  end 
  ------------------------------------------------------审判之袍[第四档]
  if srcUser:HasBuffID(90002053) and RefineLv2>= 5 then 
    Trial1=Trial1+0.5
  end

  if (Ring3==43552 or Ring3==143552)  then
      if (RefineLv4>=10 and RefineLv4<15) then
         Trial1=Trial1+0.5
      elseif (RefineLv4==15) then
         Trial1=Trial1+1+0.5
      end
  end

  if srcUser:HasBuffID(91000410) or srcUser:HasBuffID(91000690) then  
    Trial2=1.1
  end

  ---------------------------------星盘
  local Num = srcUser:GetRunePoint(54050)
  local RuneDamage = 1+Num*0.06

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(damChangePer+Trial1)*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*Trial2*RuneDamage
  
  if 1 >= A then
    return 1
  end
 
  return A

end
-----------------------------------------------------------------------------------------------------------------近战十字军圣十字攻击技能伤害计算公式(已改)
function CommonFun.calcDamage_7201(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  local WeaponType =srcUser:GetEquipedWeaponType()
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")
  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  --------------------------------------------------------------------------------------------------------魔法防御减免
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)


  -------------------------------------------------------------星盘圣十字攻击
  local Num1 = srcUser:GetRunePoint(70020)
  local RuneDamage = 1 + 0.1*Num1
  -------------------------------------------------------------神佑之光伤害加成
  local skilllv_1 = srcUser:GetLernedSkillLevel(362)
  local Skilldamage = skilllv_1*0.2
  -------------------------------------------------------------旗鱼枪
  local EquipDamage = 0
  local RefineDamage =0
  local RefineLv=srcUser:GetEquipedRefineLv(7)
  if srcUser:HasBuffID(40380) then 
      EquipDamage = 1
      RefineDamage = 0.3*RefineLv
  end
  -------------------------------------------------------------旗鱼枪四档
  local EquipDamage_1 = 0
  if srcUser:HasBuffID(90001253) then 
    EquipDamage_1 = 0.5
  end

  -----------------------------------------------------------深海恐惧
  if srcUser:HasBuffID(41770) then 
      EquipDamage = EquipDamage + 1.5
      RefineDamage = RefineDamage + 0.3*RefineLv
  end




  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer + Skilldamage + EquipDamage + RefineDamage+EquipDamage_1)*(1+DamIncrease)*(1-RefineDamReduc)-Vit2*(1+VitPer2)

  if 1 >= A then
     A = 1
  end

  local srcAtkElement    = 6
  local targetDefElement = targetUser:GetProperty("DefAttr")
  
  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local B = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(damChangePer + Skilldamage + EquipDamage + RefineDamage)*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))

  if 1 >= B then
     B = 1
  end

  local C = (A + B)*RuneDamage

  local WeaponType =srcUser:GetEquipedWeaponType() 
  if WeaponType~=170 then
      C=C*0.5
  end

   return C
end

-----------------------------------------------------------------------------------------------------------------神之威压 技能伤害计算公式(已改)
function CommonFun.calcDamage_7202(srcUser, targetUser, params, damageParam, logger)
  
  local damChangePer = damageParam.damChangePer
  
  local A = damChangePer

   return A
end
-----------------------------------------------------------------------------------------------------------------皇家卫士 大地猛击伤害计算公式(已改)
function CommonFun.calcDamage_7401(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)


  local Vit = srcUser:GetProperty("Vit")
  local Def = srcUser:GetProperty("Def")
  local DefPer = srcUser:GetProperty("DefPer")

  local BaseAtk  = Vit*Vit*Def*(1+DefPer)/10000
  local AtkFinal = BaseAtk*bodyparam*elementparam*elementparam2*raceparam*bossparam*bossparam2

  local skilllv_1 = srcUser:GetLernedSkillLevel(1181)--------------守护之盾
  local Sheild = skilllv_1*0.01+1
  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  local A = ((AtkFinal*DefReduc*(1-DamReduc2))*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*Sheild

   if 1 >= A then
         return 1
   end

   return A
end
-----------------------------------------------------------------------------------------------------------------血十字 技能伤害计算公式(已改)
function CommonFun.calcDamage_7402(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  local WeaponType =srcUser:GetEquipedWeaponType()
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")
  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  --------------------------------------------------------------------------------------------------------魔法防御减免
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease)*(1-RefineDamReduc)-Vit2*(1+VitPer2)

  if 1 >= A then
     A = 1
  end
  
  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  
  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local B = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))

  if 1 >= B then
     B = 1
  end
  -----------------------------------------------星盘
  local Num = srcUser:GetRunePoint(74030)
  local RuneDamage = 1+Num*0.07

  -----------------------------------------------无颅武士卡片
  local Card = 1 
  if srcUser:HasBuffID(52790) then 
    Card = 1.1
  end
  -----------------------------------------------------------深海恐惧
  local EquipDamage = 1
  if srcUser:HasBuffID(41770) then 
      EquipDamage = EquipDamage + 0.3
  end




  local C = (A + B)*RuneDamage*Card*EquipDamage

   return C
end
------------------------------------------------------------------------------------------------------随机伤害技能攻击计算公式(已改)
function CommonFun.calcDamage_8000(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local BaseLv = targetUser.BaseLv
  local WeaponType =srcUser:GetEquipedWeaponType()
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local damChangePer  = damageParam.damChangePer

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)


  local AtkFinal = math.floor(BaseLv,BaseLv*3)*damChangePer

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(1+DamIncrease)*(1-RefineDamReduc)-Vit2*(1+VitPer2)
            
   
   if 1 >= A then
         return 1
   end
  
  return A

end

-----------------------------------------------------------------------------------------------------------------连续盾击技能伤害(已改)
function CommonFun.calcDamage_7203(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Vit = srcUser:GetProperty("Vit")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local shield=srcUser:GetEquipedID(1)
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  -------------------------------------------------------------星盘连续盾击
  local Num1 = srcUser:GetRunePoint(70040)
  local RuneDamage = 1 + 0.1*Num1

    ------------------------------------------------------------体质和灵巧带来伤害加成
  local RefineLv=srcUser:GetEquipedRefineLv(1)
  local VDDamage = Vit/150 +Dex/200 + RefineLv/15
  if VDDamage <= 0 then
     VDDamage  = 0
  end   

  local skilllv_1 = srcUser:GetLernedSkillLevel(1181)--------------守护之盾
  local Sheild = skilllv_1*0.01+1

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer + VDDamage)*(1+DamIncrease)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*RuneDamage*Sheild
  

    ---------------------------------------------------------------------------------------------------------------------皇家战甲[第四档]
  local RefineLvH = srcUser:GetEquipedRefineLv(2)
  local huangjiazhanjia = 0
  if RefineLvH >= 10 and srcUser:HasBuffID(90002013) then 
       huangjiazhanjia = 0.15
  end
  ---------------------------------------------------------------------------------------------------------------------镜盾[第四档]
  local RefineLvJ = srcUser:GetEquipedRefineLv(1)
  local jingdun = 0
  if RefineLvJ >= 10 and srcUser:HasBuffID(90002033) then 
       jingdun = 0.1
  end
  ----------------------------------------------------------------------------------------------------------------------------镜盾装备效果
  if shield==42508 or shield==142508 then
    return A*(1.15 + huangjiazhanjia + jingdun ) else 
    return A*(1 + huangjiazhanjia + jingdun)
  end


   if 1 >= A then
         return 1
   end

   return A
end


-----------------------------------------------------------------------------------------------------------------回旋盾击技能伤害(已改)
function CommonFun.calcDamage_7204(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Vit = srcUser:GetProperty("Vit")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local shield=srcUser:GetEquipedID(1)
  local RefineLv=srcUser:GetEquipedRefineLv(1)
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
  --------------------------------------------------------------回旋盾击巅峰等级
  local skilllv_1 = srcUser:GetLernedSkillLevel(352)
  local TopAtk = 0
  if skilllv_1>5 then 
      TopAtk = (Atk*(1+AtkPer) + Refine)*(skilllv_1-5)/10
  end

  local BaseAtk  = Vit*8 + math.floor(Vit*Vit/100)*4 + math.floor(Dex/5) + math.floor(Luk/5) + RefineLv*RefineLv*2 + TopAtk
  local AtkFinal = BaseAtk*elementparam*elementparam2*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  -------------------------------------------------------------星盘回旋盾击
  local Num1 = srcUser:GetRunePoint(70100)
  local RuneDamage = 1 + 0.05*Num1

  ------------------------------------------------------------体质和灵巧带来伤害加成
  local RefineLv=srcUser:GetEquipedRefineLv(1)
  local VDDamage = Vit/150 + Dex/200 + RefineLv/15
  if VDDamage <= 0 then
     VDDamage  = 0
  end   

  local skilllv_1 = srcUser:GetLernedSkillLevel(1181)--------------守护之盾
  local Sheild = skilllv_1*0.01+1

  local A = (AtkFinal*DefReduc*(1-DamReduc2)*(damChangePer + VDDamage)*(1+DamIncrease)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*RuneDamage*Sheild
  
     ---------------------------------------------------------------------------------------------------------------------皇家战甲[第四档]
  local RefineLvH = srcUser:GetEquipedRefineLv(2)
  local huangjiazhanjia = 0
  if RefineLvH >= 10 and srcUser:HasBuffID(90002013) then 
       huangjiazhanjia = 0.15
  end
  ---------------------------------------------------------------------------------------------------------------------镜盾[第四档]
  local RefineLvJ = srcUser:GetEquipedRefineLv(1)
  local jingdun = 0
  if RefineLvJ >= 10 and srcUser:HasBuffID(90002033) then 
       jingdun = 0.1
  end
  ----------------------------------------------------------------------------------------------------------------------------镜盾装备效果
  if shield==42508 or shield==142508 then
    return A*(1.15 + huangjiazhanjia + jingdun ) else 
    return A*(1 + huangjiazhanjia + jingdun)
  end

   if 1 >= A then
         return 1
   end

   return A
end


-----------------------------------------------------------------------------------------------------------------盾击技能伤害(已改)
function CommonFun.calcDamage_7205(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Vit = srcUser:GetProperty("Vit")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local shield=srcUser:GetEquipedID(1)
  local RefineLv=srcUser:GetEquipedRefineLv(1)
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ------------------------------------------------------------体质和灵巧带来伤害加成
  local RefineLv=srcUser:GetEquipedRefineLv(1)
  local VDDamage = Vit/150 + Dex/200 + RefineLv/15
  if VDDamage <= 0 then
     VDDamage  = 0
  end   
  
  local skilllv_1 = srcUser:GetLernedSkillLevel(1181)--------------守护之盾
  local Sheild = skilllv_1*0.01+1

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer + VDDamage)*(1+DamIncrease)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*Sheild
  
     ---------------------------------------------------------------------------------------------------------------------皇家战甲[第四档]
  local RefineLvH = srcUser:GetEquipedRefineLv(2)
  local huangjiazhanjia = 0
  if RefineLvH >= 10 and srcUser:HasBuffID(90002013) then 
       huangjiazhanjia = 0.15
  end
  ---------------------------------------------------------------------------------------------------------------------镜盾[第四档]
  local RefineLvJ = srcUser:GetEquipedRefineLv(1)
  local jingdun = 0
  if RefineLvJ >= 10 and srcUser:HasBuffID(90002033) then 
       jingdun = 0.1
  end
  ----------------------------------------------------------------------------------------------------------------------------镜盾装备效果
  if shield==42508 or shield==142508 then
    return A*(1.15 + huangjiazhanjia + jingdun ) else 
    return A*(1 + huangjiazhanjia + jingdun)
  end

   if 1 >= A then
         return 1
   end

   return A
end
-----------------------------------安生命值百分比决定的伤害
function CommonFun.calcDamage_8001(srcUser, targetUser, params, damageParam, logger)

  local damChangePer = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1
  local MaxHp = targetUser:GetProperty("MaxHp")
  
  local A = MaxHp*damChangePer+damChangePer1
   
   if 1 >= A then
         return 1
   end
  
  return A

end

-- ----------------------------------------------------------------------------------------------------随机伤害技能攻击计算公式(已改)
function CommonFun.calcDamage_8002(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
  
  local BaseLv = targetUser.BaseLv
  local WeaponType =srcUser:GetEquipedWeaponType()
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local damChangePer   = damageParam.damChangePer
  local damChangePer1  = damageParam.damChangePer1

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)


  local AtkFinal = math.random(BaseLv*10,BaseLv*16)*damChangePer + math.random(500,1500)*damChangePer1

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(1+DamIncrease)*(1-RefineDamReduc)-Vit2*(1+VitPer2)
            
   
   if 1 >= A then
         return 1
   end
  
  return A

end

-----------------------------------------------------------------------------------------------------佣兵猫使用冲锋箭
function CommonFun.calcDamage_8003(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")   
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger) 

  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5)
  local AtkFinal = (Atk*(1+AtkPer)*elementparam*elementparam2+BaseAtk)*raceparam*bossparam
  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease-LongRangeDamReduc2) + damChangePer1)*(1-RefineDamReduc)-Vit2*(1+VitPer2)
   
  if 1 >= A then
      return 1
  end
 ---------------------------------------------------------------------------------------------------------------------装备或卡片上有二连矢加伤百分比的效果
  if bits[CommonFun.AttrEffect.ErLianDam]==1 then  
     return A*1.5
  end
     
     return A  
end



------------------------------------------------------------------------------------------------------------------远程物理伤害计算公式(已改)
function CommonFun.calcDamage_8004(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = targetUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)


  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5)
  local AtkFinal = (Atk*(1+AtkPer)*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease-LongRangeDamReduc2)*(1-RefineDamReduc)-Vit2*(1+VitPer2)
   
   if 1 >= A then
         return 1
   end
   
   if bits[CommonFun.AttrEffect.NormalSkillDam]==1 then
      return A*1.3
   end    

   return A

end


------------------------------------------------------------------------------------------------------------------伤害返回数值为0但是播放命中特效的计算公式(已改)
function CommonFun.calcDamage_8005(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = targetUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer  = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)


  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5)
  local AtkFinal = (Atk*(1+AtkPer)*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
   local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1+DamIncrease) + damChangePer1)*(1-RefineDamReduc)-Vit2*(1+VitPer2)

   return A,CommonFun.DamageType.Normal

end
--------------------------------------------------------------------------------------------------------------------------魔焰伤害计算公式(已改)
function CommonFun.calcDamage_8006(srcUser, targetUser, params, damageParam, logger)
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")

  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2
  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  local skilllv_1 = srcUser:GetLernedSkillLevel(103140)
  local Rate = skilllv_1*5+30
  -- --------------燃烧吧 火焰伤害增加
  if CommonFun.IsInRate(Rate, srcUser:GetRandom()) then
      return A*1.5
  end
  
  if 1 >= A then
    return 1
  end
 
  return A

end
-- ---------------------------------------------------------------------------------------------------能量之拳  计算公式(已改)
function CommonFun.calcDamage_8007(srcUser, targetUser, params, damageParam, logger)
  
   local A = 111111
   return A,CommonFun.DamageType.Normal

end
-- ---------------------------------------------------------------------------------------------------游侠 任务怪  计算公式(已改)
function CommonFun.calcDamage_8008(srcUser, targetUser, params, damageParam, logger)
   local MaxHp = targetUser:GetProperty("MaxHp")
   local A = MaxHp*0.25
   
   return A,CommonFun.DamageType.Normal

end
------------------------------------------------------------------------------------------------------奥特曼普通攻击计算公式(已改)
function CommonFun.calcDamage_8020(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local BaseLv = targetUser.BaseLv
  local WeaponType =srcUser:GetEquipedWeaponType()
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local damChangePer  = damageParam.damChangePer

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)


  local AtkFinal = math.floor(BaseLv,BaseLv*3)*damChangePer

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(1+DamIncrease)*(1-RefineDamReduc)-Vit2*(1+VitPer2)
            
   
   if 1 >= A then
         return 1
   end
  
  return A

end
-- ----------------------------------------------------------------------------------------------------奥特曼随机伤害公式
function CommonFun.calcDamage_8021(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
  
  local BaseLv = targetUser.BaseLv
  local WeaponType =srcUser:GetEquipedWeaponType()
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local damChangePer   = damageParam.damChangePer
  local damChangePer1  = damageParam.damChangePer1

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)


  local AtkFinal = math.random(BaseLv*10,BaseLv*16)*damChangePer + math.random(500,1500)*damChangePer1

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)

  if targetUser:GetNpcID() ~= 56008 and targetUser:GetNpcID() ~= 56009 and skillID == 40032 then
     AtkFinal=0
  end
  if targetUser:GetNpcID() ~= 56010 and targetUser:GetNpcID() ~= 56011 and skillID == 40034 then
     AtkFinal=0
  end
  if targetUser:GetNpcID() ~= 56012 and targetUser:GetNpcID() ~= 56013 and skillID == 40036 then
     AtkFinal=0
  end
  local A = AtkFinal
            
   
   if 1 >= A then
         return 1
   end
  
  return A

end
-- ----------------------------------------------------------------------------------------------------海之吐息伤害公式
function CommonFun.calcDamage_8030(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine  = srcUser:GetProperty("MRefine")
  local RangeDam = srcUser:GetProperty("RangeDam")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)   
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
  local MaxHp = srcUser:GetProperty("MaxHp")
  local Hp = srcUser:GetProperty("Hp")  
  local HpPerRatio=1
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
 
  local count=params.hitedCount
  local CountDam = 1/(count^0.6)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*CountDam 
  

            
   
   if 1 >= A then
         return 1
   end
  
  return A

end
-----------------------------------------------------------------------------------------------------------------mvp崩裂术技能魔法伤害计算公式(已改)
function CommonFun.calcDamage_8031(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine  = srcUser:GetProperty("MRefine")
  local RangeDam = srcUser:GetProperty("RangeDam")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)   
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
  local MaxHp = srcUser:GetProperty("MaxHp")
  local Hp = srcUser:GetProperty("Hp")  
  local HpPerRatio=1
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  ----------------------------------------------------------暴风雪
  if skillID==71850 then
         if Hp<0.8*MaxHp then
            HpPerRatio=2
         end
  end
  if skillID==71860 then
         if Hp<0.5*MaxHp then
            HpPerRatio=2
         end
  end

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*(1 + RangeDam)*HpPerRatio
  

  if 1 >= A then
    return 1
  end
     
     return A

end

-- ----------------------------------------------------------------------------------------------------毁灭打击伤害公式
function CommonFun.calcDamage_8032(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = targetUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)


  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5)
  local AtkFinal = (Atk*(1+AtkPer)*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  local count=params.hitedCount
  local CountDam = math.max(1-0.08*count,0.2)
  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(1+DamIncrease)*(1-RefineDamReduc)-Vit2*(1+VitPer2))*CountDam
            
   
   if 1 >= A then
         return 1
   end
  
  return A

end


--------------------------------------------------------------------------------------------------------------------------贤者  精神损耗术 魔法伤害计算公式(已改)
function CommonFun.calcDamage_8201(srcUser, targetUser, params, damageParam, logger)
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")

  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  -----------------------------------------------------损耗术
  local Sp = targetUser:GetProperty("Sp")

  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk+Sp)*raceparam*bossparam*bossparam2
  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
  ------------------------------------------星盘
  local Num_js = srcUser:GetRunePoint(82020)
  local RuneDamage = 1 + Num_js*0.1
  ------------------------------------------精神手杖
  local RefineLv=srcUser:GetEquipedRefineLv(7)
  local JSSZ = 1
   if RefineLv == 15 and srcUser:HasBuffID(90002133) then 
        JSSZ = 1.15
   end

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*RuneDamage*JSSZ

  if 1 >= A then
    return 1
  end
 
  return A

end
--------------------------------------------------------------------------------------------------------------------------贤者 范围技能魔法伤害计算公式(已改)
function CommonFun.calcDamage_8202(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine  = srcUser:GetProperty("MRefine")
  local RangeDam = srcUser:GetProperty("RangeDam")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)   
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*(1 + RangeDam)
  
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  
   local skilllv_ele = srcUser:GetLernedSkillLevel(1333)-------召唤元素

   local ElementNpc = srcUser:getCurElementElfID()---获取元素生物
  -----------------------------------------------------------------岩枪
  if skillID==1330 then
      if ElementNpc==580030 then
         A = A * (1 + skilllv_ele*0.03)
      end
  end
  -----------------------------------------------------------------钻石星尘
  if skillID==1328 then
      local Num_xc = srcUser:GetRunePoint(82031)

      A = A * (1 + Num_xc*0.08)

      if ElementNpc==580020 then
         A = A * (1 + skilllv_ele*0.01)
      end
  ----------------------------冷澈之魔法书
    local RefineLv=srcUser:GetEquipedRefineLv(7)
    local Ring1=srcUser:GetEquipedID(7)
      if (Ring1==63433 or Ring1==163433) then 
     A = A * (RefineLv * 0.02 + 1)
    end
  end
  -----------------------------------------------------------------地震术
  if skillID==1305 then
      local Num_dz = srcUser:GetRunePoint(82002)
      A = A*(1 + Num_dz*0.1)
  end
  ----------------------------------------------------------------精神冲击
  if skillID==1331 then
      local Num_js = srcUser:GetRunePoint(82033)
      A = A * (1 + Num_js*0.08)
  end

  if 1 >= A then
    return 1
  end
     
     return A

end
--------------------------------------------------------------------------------------------------------------------------贤者 闪电之枪 技能魔法伤害计算公式(已改)
function CommonFun.calcDamage_8203(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine  = srcUser:GetProperty("MRefine")
  local RangeDam = srcUser:GetProperty("RangeDam")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)   
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
  ------------------------------------------------------------------------星盘
  local Num_shand = srcUser:GetRunePoint(82028)
  local RuneDamage = 1 + Num_shand*0.08
  --------------------------------------------------------------------------------------魔法伤害
  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*RuneDamage
  
  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")

  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  --------------------------------------------------------------------------------------物理伤害
  local B = ((MAtkFinal*DefReduc*(1-DamReduc2)+MRefine)*(1-RefineDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))


  local skilllv_ele = srcUser:GetLernedSkillLevel(1333)-------召唤元素

  local ElementNpc = srcUser:getCurElementElfID()---获取元素生物
  local elementRatio = 1
      
      if ElementNpc==580040 then
         elementRatio = 1 + skilllv_ele*0.01
      end
  -------------------------------------------------------------------------------------------------------------------星盘闪电压制
  local StateEffect = targetUser:GetProperty("StateEffect")
  local bits2=CommonFun.getBits(StateEffect)
  local Num_yaz = srcUser:GetRunePoint(82029)
  local RuneDamage2= 1 

  if bits2[CommonFun.StateEffect.Freeze] ==1 then
        RuneDamage2=1 + Num_yaz*0.2
  end

  local C = (A + B)*elementRatio*RuneDamage2
  
  if 1 >= C then
    return 1
  end
     
     return C

end
--------------------------------------------------------------------------------------------------------------------------贤者  元素生物  普攻技能 魔法伤害计算公式(已改)
function CommonFun.calcDamage_8204(srcUser, targetUser, params, damageParam, logger)

  local Master = srcUser:GetMasterUser()
  if Master==nil then
      return 0
  end

  local Int = Master:GetProperty("Int")
  local MAtk = Master:GetProperty("MAtk")
  local MAtkPer = Master:GetProperty("MAtkPer")
  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = Master:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")

  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)

  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2
  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local skilllv_ele = Master:GetLernedSkillLevel(1333)-------召唤元素
  local skilllv_ele2 = Master:GetLernedSkillLevel(1334)-------元素交流
  local Final = (1 + 0.05*skilllv_ele)*(1 + 0.1*skilllv_ele2)

  local Num_hp = Master:GetRunePoint(82025)---星盘
  local RuneDamage = 1 + Num_hp*0.1

  local A = (MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2*Final*RuneDamage
  
  if 1 >= A then
    return 1
  end
 
  return A

end
--------------------------------------------------------------------------------------------------------------------------贤者 精神冲击 范围技能魔法伤害计算公式(已改)
function CommonFun.calcDamage_8205(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine  = srcUser:GetProperty("MRefine")
  local RangeDam = srcUser:GetProperty("RangeDam")

  local srcAtkElement    = 5

  local ElementNpc = srcUser:getCurElementElfID()---获取元素生物
  
  if ElementNpc==580010 then
      srcAtkElement = 4
  elseif ElementNpc==580020 then
      srcAtkElement = 3
  elseif ElementNpc==580030 then    
      srcAtkElement = 2
  elseif ElementNpc==580040 then        
      srcAtkElement = 1
  end

  local targetDefElement = targetUser:GetProperty("DefAttr")
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
    if nil == CommonFun.NatureProps[srcAtkElement] or nil == CommonFun.NatureProps[targetDefElement] or nil == targetDefElement then
       return 0
    end

    local elementRed = targetUser:GetProperty(CommonFun.NatureProps[srcAtkElement][2])
    local elementAtk = srcUser:GetProperty(CommonFun.NatureProps[srcAtkElement][3])

    if nil==elementAtk then
        elementAtk = 0
    end

    local elementparam2 = 1+elementAtk-elementRed
    ------------------------------------------------------------------------竞技场额外增加30%元素减免
    local mapid,maptype = srcUser:GetMapInfo()-----------------获取所在地图
    ------------------------maptype 1 :野外 2：pvp 3:其他普通副本 4:gvg 
    if maptype==2 or maptype==4 then
      local B = elementRed - elementAtk  ---------------元素伤害减免
      B = B < -1 and -1 or B > 1 and 1 or B
      B = math.floor(B*1000)/1000
      B = B + 0.3*(1-math.sin(B*3.14/2))
      --print("B2="..B)
      elementparam2 = 1 - B 
    end

    if elementparam2 <= 0.1 then
        elementparam2 = 0.1
    end

  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)   
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)
  local Num_js = srcUser:GetRunePoint(82033)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*(1 + Num_js*0.08)*(1 + RangeDam)

  if 1 >= A then
    return 1
  end
     
     return A

end
--------------------------------------------------------------------------------------------------------------------------BOSS专用技能
function CommonFun.calcDamage_9000(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  local count=params.hitedCount
  if count<=1 then
     count=1
  end 
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))/count
  

  if 1 >= A then
    return 1
  end
 
  return A

end

--------------------------------------------------------------------------------------------------------------------------BOSS专用技能
function CommonFun.calcDamage_9001(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  local count=params.hitedCount
  if count<=1 then
     count=1
  end 
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*count
  

  if 1 >= A then
    return 1
  end
 
  return A

end

function CommonFun.calcDamage_9002(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")
  local count=params.hitedCount
  if count<=1 then
     count=1
  end 



  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))/count
   
   if 1 >= A then
         return 1
   end
   
   return A
end

function CommonFun.calcDamage_9003(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  local count=params.hitedCount
  if count<=1 then
     count=1
  end   
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))/count
  

  if 1 >= A then
    return 1
  end

  return A

end

-------------------------------------------------------------------------------------------------------------------濒死之术
function CommonFun.calcDamage_9004(srcUser, targetUser, params, damageParam, logger)
  local Hp = targetUser:GetProperty("Hp")
  local Weapon = srcUser:GetEquipedID(7)
  local targetRace = targetUser.race
  local enemy=srcUser:IsEnemy(targetUser)
  local A = Hp-1
  ----------------------------------------------------------------------------暗灵之斧,斯特勒手斧濒死之术
  if enemy then
      if targetRace==3 and (Weapon==41815 or Weapon==141815) then
         if targetUser.boss == true or targetUser.mini == true then 
           return 0,0
         else
           return A
         end   
      elseif targetRace==1 and (Weapon==41836 or Weapon==141836) then
         if targetUser.boss == true or targetUser.mini == true then 
           return 0,0
         else
           return A
         end 
      else
           return 0,0  
      end  
  else
    return 0,0
  end
 
  return 0,0 

end

function CommonFun.calcDamage_9005(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local BaseLv = srcUser.BaseLv
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")
  local count=params.hitedCount
  if count<=1 then
     count=1
  end 

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))/count
   
   if 1 >= A then
         return 1,CommonFun.DamageType.Normal_Sp
   end
   
   return A,CommonFun.DamageType.Normal_Sp
end

-----------------------------------------------------------------------------------------------------------------巴风特之怒技能伤害计算公式(已改)
function CommonFun.calcDamage_9006(srcUser, targetUser, params, damageParam, logger)
  local BaseLv = srcUser.BaseLv
  local RefineLv=srcUser:GetEquipedRefineLv(7)
  local B = 0
  local Num1 = srcUser:GetBuffLayer(24522)
  local weapon=srcUser:GetEquipedID(7)
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  if (weapon==40020 or weapon==140020) then
     if RefineLv>=2 and RefineLv < 4 then
        B = 0.05
     elseif RefineLv>=4 and RefineLv < 6 then
        B = 0.1
     elseif RefineLv>=6 and RefineLv < 8 then
        B = 0.15
     elseif RefineLv>=8 and RefineLv < 10 then
        B = 0.20
     elseif RefineLv>=10 and RefineLv < 12 then
        B = 0.25
     elseif RefineLv>=12 and RefineLv < 14 then
        B = 0.30
     elseif RefineLv>=14 and RefineLv < 16 then
        B = 0.35
     elseif RefineLv>=16 and RefineLv < 18 then
        B = 0.40
     elseif RefineLv>=18 and RefineLv < 20 then
        B = 0.45
     elseif RefineLv==20 then
        B = 0.50   
     end
  end                                 
 
  local damChangePer = damageParam.damChangePer
    ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local A = math.max(1,BaseLv*Num1*damChangePer*(1+B))*elementparam*elementparam2*raceparam*bossparam*bossparam2*(1-DamReduc2)*(1-RefineDamReduc)*(1+DamIncrease)
   
   if 1 >= A then
         return 1
   end
   
   return A
end


--波利乱斗 撞击
function CommonFun.calcDamage_9010(srcUser, targetUser, params, damageParam, logger)

  if targetUser:GetNpcID() == 0 then --------------------为玩家
    local TargetAppleNum = targetUser:GetAppleNum()
    if  targetUser:HasBuffID(200020) or targetUser:HasBuffID(200021) then----目标苹果数量为0或有护盾Buff
      return 1, CommonFun.DamageType.Normal
    elseif TargetAppleNum == 0  then
      return 0, CommonFun.DamageType.Normal
    elseif targetUser:HasBuffID(200070) then---------------目标身上存在变大效果
      return math.ceil(TargetAppleNum/4)
    else
      return math.ceil(TargetAppleNum/2)
    end
  else-----------------------------为怪物（命中和暴击不在此处判断）
    local A = 100
    local SelfAppleNum = srcUser:GetAppleNum()
    if SelfAppleNum>5 then
      A = 100*((SelfAppleNum-5)*0.1+1)
    end
    return A
  end
end

--波利乱斗 怪物普攻
function CommonFun.calcDamage_9011(srcUser, targetUser, params, damageParam, logger)

  local damageParam = damageParam.damChangePer
  if damageParam == 0 then
    return 0, CommonFun.DamageType.Miss
  end

  if targetUser:GetNpcID() == 0 then --------------------为玩家
    local TargetAppleNum = targetUser:GetAppleNum()

    if TargetAppleNum <= 1 or targetUser:HasBuffID(200020) or targetUser:HasBuffID(200021) then----目标苹果数量为0或有护盾Buff
      return 0, CommonFun.DamageType.Miss
    elseif  CommonFun.IsInRate(damageParam/2, srcUser:GetRandom()) and targetUser:HasBuffID(200070)  then---------------目标身上存在变大则概率减半
      return 1
    elseif CommonFun.IsInRate(damageParam, srcUser:GetRandom()) then---------------默认30%概率掉落1个苹果
      return 1
    else
      return 0, CommonFun.DamageType.Miss
    end
  else-----------------------------为怪物
    return 0, CommonFun.DamageType.Miss
  end
end
----------------------------------------------------------------------卡仑技能 冰锥治疗
function CommonFun.calcDamage_9012(srcUser, targetUser, params, damageParam, logger)
  local MaxHp = targetUser:GetProperty("MaxHp")
  local A = -MaxHp*0.03

  return A 

end
----------------------------------------------------------------------卡仑技能 冰锥伤害
function CommonFun.calcDamage_9013(srcUser, targetUser, params, damageParam, logger)
  local MaxHp = targetUser:GetProperty("MaxHp")
  local A = MaxHp*0.2

  return A 

end
---------------------------------------------------------------------- 神器  冰霜结晶
function CommonFun.calcDamage_9014(srcUser, targetUser, params, damageParam, logger)
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local Refine = srcUser:GetProperty("Refine")
  local CriDamPer = srcUser:GetProperty("CriDamPer")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  local A = (Atk*(1+AtkPer)+Refine)*(1.5+CriDamPer)*(1-RefineDamReduc)*damChangePer

  return A 

end
---------------------------------------------------------------------- 神器  雷神之怒
function CommonFun.calcDamage_9015(srcUser, targetUser, params, damageParam, logger)
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local Refine = srcUser:GetProperty("Refine")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MRefine = srcUser:GetProperty("MRefine")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  local A = (Atk*(1 + AtkPer) + Refine + MAtk*(1 + MAtkPer) + MRefine)*(1-RefineDamReduc)*damChangePer

  return A 

end
------------------------------------------------------------------------------Mini怪火球弹射技能伤害公式（已改）
function CommonFun.calcDamage_9016(srcUser, targetUser, params, damageParam, logger)
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")

  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")
  local count=params.hitedCount
  if count<=1 then
     count=1
  end 
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))*count


  if 1 >= A then
    return 1
  end
 
  return A

end

--波利乱斗 炸弹
function CommonFun.calcDamage_9017(srcUser, targetUser, params, damageParam, logger)

  if targetUser:GetNpcID() == 0 then --------------------为玩家
    local TargetAppleNum = targetUser:GetAppleNum()
    return TargetAppleNum
  else-----------------------------为怪物（命中和暴击不在此处判断）
    return 500
  end
end
-------------------------------------------------------------------------------------------------------------------------风暴之心伤害计算公式(已改)
function CommonFun.calcDamage_9018(srcUser, targetUser, params, damageParam, logger)
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Vit = srcUser:GetProperty("Vit")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")

  -----------------------------------------------------------------------------------分割线
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
  if IgnoreMDef >= 1 then
     IgnoreMDef  = 1
  end
 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")
  -------------------------------------------------四种元素伤害分别判断 
  local srcAtkElement1  = 1
    local elementInc1 = 0
    local elementRed1 = 0

    local targetDefElement = targetUser:GetProperty("DefAttr")

    
    if nil == targetDefElement then
        logger.error(string.format("%s targetDefElement is nil", targetUser.name))
        return 0
    end
    if nil == CommonFun.NatureProps[targetDefElement] then
        logger.error(string.format("%s CommonFun.NatureProps[%s] is nil", srcUser.name, tostring(targetDefElement)))
        return 0
    end

    if nil == CommonFun.NatureProps[srcAtkElement1] then
        logger.error(string.format("CommonFun.NatureProps[%s] is nil", tostring(srcAtkElement1)))
        return 0
    end

    elementInc1 = srcUser:GetProperty(CommonFun.NatureProps[targetDefElement][1])
    elementRed1 = targetUser:GetProperty(CommonFun.NatureProps[srcAtkElement1][2])
    elementAtk1 = srcUser:GetProperty(CommonFun.NatureProps[srcAtkElement1][3])

    if nil==elementAtk1 then
        elementAtk1 = 0
    end
    local result1 = 1+elementAtk1-elementRed1

    if result1 <= 0.1 then
        result1 = 0.1
    end


  local srcAtkElement3   = 3
    local elementInc3 = 0
    local elementRed3 = 0

    local targetDefElement = targetUser:GetProperty("DefAttr")

    
    if nil == targetDefElement then
        logger.error(string.format("%s targetDefElement is nil", targetUser.name))
        return 0
    end
    if nil == CommonFun.NatureProps[targetDefElement] then
        logger.error(string.format("%s CommonFun.NatureProps[%s] is nil", srcUser.name, tostring(targetDefElement)))
        return 0
    end

    if nil == CommonFun.NatureProps[srcAtkElement3] then
        logger.error(string.format("CommonFun.NatureProps[%s] is nil", tostring(srcAtkElement3)))
        return 0
    end

    elementInc3 = srcUser:GetProperty(CommonFun.NatureProps[targetDefElement][1])
    elementRed3 = targetUser:GetProperty(CommonFun.NatureProps[srcAtkElement3][2])
    elementAtk3 = srcUser:GetProperty(CommonFun.NatureProps[srcAtkElement3][3])

    if nil==elementAtk3 then
        elementAtk3 = 0
    end
    local result3 = 1+elementAtk3-elementRed3

    if result3 <= 0.1 then
        result3 = 0.1
    end


  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  
  local elementparam21 = result1
  local elementparam23 = result3
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local Int2 = targetUser:GetProperty("Int")
  local IntPer2 = targetUser:GetProperty("IntPer")
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*bossparam*bossparam2
  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A1 = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement1][targetDefElement]*elementparam21-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  local A3 = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement3][targetDefElement]*elementparam23-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))

  local A=A1+A3
  
  if 1 >= A then
    return 1
  end
 
  return A

end
------------------------------------------------------------------------------------------------------------------流氓 弓箭 物理伤害计算公式(已改)
function CommonFun.calcDamage_9201(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  ------------------------------------------------------普通攻击力
  local NormalAtk = srcUser:GetProperty("NormalAtk")
        NormalAtk = NormalAtk + 3*Dex
  ------------------------------------
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = targetUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
  

  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5) 
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  
  if skillID==469 then
     AtkFinal = ((Atk-BaseAtk+NormalAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  end
  -----------------------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  -----------------------------------------------------苍鹰之眼  距离加伤
  local targetid = targetUser:GetGuid()
  local distance = srcUser:GetDistance(targetid)
  local skilllv_1 = srcUser:GetLernedSkillLevel(478)
  local DisDam= 1
  if skilllv_1>10 then 
      DisDam = 1 + distance/7.5*(skilllv_1-10)*0.06
  end
  -------------------------------------------------------------死亡标记              
    local fromid = targetUser:GetBuffFromID(116470)
    local guid = srcUser:GetGuid()
    local BUffDam = 1
    local skilllv_1 = srcUser:GetLernedSkillLevel(1147)
    ---------------------------------星盘 
    local Numxp= srcUser:GetRunePoint(94080)------------星盘点

    if fromid==guid then
      BUffDam = 1+skilllv_1*0.02+Numxp*0.02
    end

  local A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer)*(1-RefineDamReduc)*(1+DamIncrease-LongRangeDamReduc2)-Vit2*(1+VitPer2))*DisDam*BUffDam

   if 1 >= A then
         return 1
   end

   return A

end

-----------------------------------------------------------------------------------------------------------------------流氓 短剑 普通攻击伤害计算公式(已改)
function CommonFun.calcDamage_9202(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  ------------------------------------------------------普通攻击力
  local NormalAtk = srcUser:GetProperty("NormalAtk")
        NormalAtk = NormalAtk + 5*Str
  ------------------------------------
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
 
  local WeaponType =srcUser:GetEquipedWeaponType()
  local skilllv_1 = srcUser:GetLernedSkillLevel(damageParam.skill1_id)
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local AttrEffect2 = srcUser:GetProperty("AttrEffect")
  local bits2=CommonFun.getBits(AttrEffect2)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk+NormalAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  --------------------------------------------------------逐一击破 三转加成
  local Enemy = 1
  local skilllv_1 = srcUser:GetLernedSkillLevel(1145)
  local EnemyNum = srcUser:GetRangeEnemy(3) ---------------自己3米内的敌人数量
  if skilllv_1>0 and EnemyNum==1 then
      Enemy = 1+skilllv_1*0.03
  end
  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*Enemy
  ------------------------------------------------------------------------------------------------------------华丽短剑buff状态下刺客普通攻击伤害提升
  local Buff=srcUser:HasBuffID(24441)
  local huali=1
  

   --------------------------------------------华丽短剑[第四档]
  if (Buff==true and srcUser:HasBuffID(90001903)) then
      huali=1.25
      elseif  Buff==true then
      huali=1.1
  end


    ------------------------------------------------------星盘 二刀连击
  local Num1 = srcUser:GetRunePoint(90170)
  local RuneDamage = Num1*0.06 + 1

  if 1 >= A then
      return 1
  end
  -----------------------------------------------------------------------------------------------------------二刀连击
  local WeaponType =srcUser:GetEquipedWeaponType()
  local skilllv_1 = srcUser:GetLernedSkillLevel(179)
  -----------------------------------------------巅峰等级 二刀
  local ErDaoDam = 0
  if skilllv_1>10 then
      ErDaoDam = (skilllv_1-10)*0.05
      skilllv_1 = 10
  end

  if WeaponType==250 and CommonFun.IsInRate(skilllv_1*5, srcUser:GetRandom())  then
        return A*(2+ErDaoDam)*huali*RuneDamage, CommonFun.DamageType.ErLianJi
  end 

  
  return A*huali
end

------------------------------------------------------------------------------------------------------------------流氓 三连矢 物理伤害计算公式(已改)
function CommonFun.calcDamage_9203(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = targetUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
  

  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5) 
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  -----------------------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  --------------------------------------------------------------
  local skilllv_1 = srcUser:GetLernedSkillLevel(468)
  ------------------------------------------------------星盘三连
  local Num1 = srcUser:GetRunePoint(90050)
  local RuneDamage = Num1*0.08 + 1
 ------------------------------------------------------盗贼之弓三连
  local Num2 =1
  local WeaponRefineLv=srcUser:GetEquipedRefineLv(7)
  if srcUser:HasBuffID(90001633) then
      Num2=WeaponRefineLv*0.03+1
  end   
   ------------------------------------------------------盗贼之弓三连[第六档]
   if srcUser:HasBuffID(90001635) then
    Num2 = Num2 + 0.1
  end
  ------------------------------------------------------罗宾汉之弓
  local WeaponRefineLv=srcUser:GetEquipedRefineLv(7)
  if srcUser:HasBuffID(41880) then
      Num2=WeaponRefineLv*0.03+Num2
  end   
   ------------------------------------------------------罗宾汉之弓
  if srcUser:HasBuffID(41880) then
    Num2 = Num2 + 0.2
  end
  

  -------------------------------------------------------------死亡标记              
    local fromid = targetUser:GetBuffFromID(116470)
    local guid = srcUser:GetGuid()
    local BUffDam = 1
    local skilllv_dead = srcUser:GetLernedSkillLevel(1147)
    ---------------------------------星盘 
    local Numxp= srcUser:GetRunePoint(94080)------------星盘点

    if fromid==guid then
      BUffDam = 1+skilllv_dead*0.02+Numxp*0.02
    end

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+skilllv_1*0.1)*(1-RefineDamReduc)*(1+DamIncrease-LongRangeDamReduc2)*RuneDamage-Vit2*(1+VitPer2))*Num2*BUffDam
   
   if 1 >= A then
         return 1
   end

   return A

end

-----------------------------------------------------------------------------------------------------------------------流氓 技能伤害计算公式(已改)
function CommonFun.calcDamage_9204(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")  
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local Hp2 = targetUser:GetProperty("Hp")
  local MaxHp2 = targetUser:GetProperty("MaxHp")

  local damChangePer = damageParam.damChangePer
  local AttrEffect= srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger) 

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)

  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  ----------------------------------------------------------潜击
  if skillID==481 then
      --------------------------------------------星盘 潜击
      local Num1 = srcUser:GetRunePoint(90060)
      local RuneDamage1 = Num1*0.2+1
      A = A*RuneDamage1
  end
  ----------------------------------------------------------胁持
  if skillID==483 then
      --------------------------------------------星盘 胁持
      local Num2 = srcUser:GetRunePoint(90100)
      local RuneDamage2 = Num2*0.1+1
      A = A*RuneDamage2
  end

-------------------------------------------------------------致残袭击
  if (skillID==487 and srcUser:HasBuffID(40672)) then
      A = A*1.5
  end

  if 1 >= A then
         return 1
  end
-------------------------------------------------------------华丽短剑
      if bits[CommonFun.AttrEffect.Hualiduanjian]==1 then
           return A*1.5
      end

   return A
  
end

-----------------------------------------------------------------------------------------------------------------------流氓 背刺 技能伤害计算公式(已改)
function CommonFun.calcDamage_9205(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")  
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local Hp2 = targetUser:GetProperty("Hp")
  local MaxHp2 = targetUser:GetProperty("MaxHp")

  local damChangePer = damageParam.damChangePer
  local AttrEffect= srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger) 

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
    ------------------------------------------------------星盘 背刺
  local Num1 = srcUser:GetRunePoint(90080)
  local RuneDamage = Num1*0.08 + 1
  
------------------------------------------------------考尔德短剑
  local kerd = 1
  if srcUser:HasBuffID(40672) then 
    kerd=1+0.5
  end

   ------------------------------------------------ 牙科手术刀[第一档]
   local yake2 = 1
  if srcUser:HasBuffID(90002160) then 
    yake2=1+0.15
  end
  ----------------------手术刀 精炼时人型加伤
  local RefineLv=srcUser:GetEquipedRefineLv(7)
  local Weapon=srcUser:GetEquipedID(7) 
  local targetRace =  targetUser.race
  local Hand = 1
  if targetRace ==2 and (Weapon==40744 or Weapon==140744 or Weapon==40745 or Weapon==140745) then
      if (RefineLv >=10 and RefineLv<15) then
          Hand =1.05
      elseif RefineLv==15 then
          Hand =1.15
      end
  end
  
  ------------------------------------------------ 牙科手术刀[第二档]
  if targetRace ==2 and srcUser:HasBuffID(90002161)   then  
      if RefineLv >=5  then 
        Hand = Hand + 0.05
    end
  end
  ----------------------------侠盗之衣+牙科手术刀
  local yake = 0
  if targetRace ==2 and srcUser:HasBuffID(91000290) then 
    yake=0.5
  end

  --------------------------------------------------------逐一击破 三转加成
  local Enemy = 1
  local skilllv_1 = srcUser:GetLernedSkillLevel(1145)
  local EnemyNum = srcUser:GetRangeEnemy(3) ---------------自己3米内的敌人数量
  if skilllv_1>0 and EnemyNum==1 then
      Enemy = 1+skilllv_1*0.03
  end

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+yake)*(1-RefineDamReduc)*(1+DamIncrease)*RuneDamage-Vit2*(1+VitPer2))*kerd*Hand*Enemy*yake2
   
   if 1 >= A then
         return 1
   end
-------------------------------------------------------------华丽短剑   伏击后背刺双倍
      if bits[CommonFun.AttrEffect.Hualiduanjian]==1 and srcUser:HasBuffID(106110) then
           return A*1.5*2
      elseif bits[CommonFun.AttrEffect.Hualiduanjian]==1 then
           return A*1.5
      elseif srcUser:HasBuffID(106110) then
           return A*2 
      end

   return A
  
end
-----------------------------------------------------------------------------------------------------------------------流氓 偷钱技能
function CommonFun.calcDamage_9206(srcUser, targetUser, params, damageParam, logger)

   local A = 0
   return A,CommonFun.DamageType.Normal
  
end
-----------------------------------------------------------------------------------------------------------------------逐影  魔力陷阱技能伤害计算公式(已改)
function CommonFun.calcDamage_9401(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 

  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")  
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")
  local Hp2 = targetUser:GetProperty("Hp")
  local MaxHp2 = targetUser:GetProperty("MaxHp")

  local damChangePer = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1

  local AttrEffect= srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger) 

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  local Int2 = targetUser:GetProperty("Int")
  ---------------------------------星盘 
  local Numxp= srcUser:GetRunePoint(94050)------------星盘点
  local RuneDamage = 1 + Numxp*0.1

  local A = (((AtkFinal+Int2*damChangePer1)*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage
-------------------------------------------------------------华丽短剑
      if bits[CommonFun.AttrEffect.Hualiduanjian]==1 then
           return A*1.5
      end

   return A
  
end
------------------------------------------------------------------------------------------------------------------诗人  远程物理伤害计算公式(已改)
function CommonFun.calcDamage_10201(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = targetUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------元素箭额外增加物理伤害      
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  local skilllv_1 = srcUser:GetLernedSkillLevel(127)
  local atk_add = 0
  if skilllv_1 >10 and (skillID == 1410 or skillID==1446) then
    atk_add = Dex * ((skilllv_1-10) * 0.5)
  end
  ------------------------------------------普攻攻击力
  local NormalAtkAttr = srcUser:GetProperty("NormalAtk")
  local NormalAtk = NormalAtkAttr + 3*Dex

  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5) 
  local AtkFinal = ((Atk-BaseAtk+NormalAtk+atk_add)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  -----------------------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ------------------------------------------------------------------------巅峰等级 苍鹰之眼
  local targetid = targetUser:GetGuid()
  local distance = srcUser:GetDistance(targetid)
  local skilllv_1 = srcUser:GetLernedSkillLevel(133)
  local DisDam= 1
  if skilllv_1>10 and skillID==1446 then 
      DisDam = 1 + distance/7.5*(skilllv_1-10)*0.06
  end
  ---------------------------重伤箭
  local Injured = 1
  if bits[CommonFun.AttrEffect.NormalSkillDam]==1 then
      Injured = 1.3
  end    
  local Num1 = srcUser:GetRunePoint(103030)
  local RuneDamage = Num1*0.01+1


  local A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer)*(1-RefineDamReduc)*(1+DamIncrease-LongRangeDamReduc2)-Vit2*(1+VitPer2))*DisDam*Injured*RuneDamage

   if 1 >= A then
         return 1
   end
   --print("DisDam="..DisDam,"Injured="..Injured,"NormalAtk="..NormalAtk,"A="..A)
   return A

end

------------------------------------------------------------------------------------------------------------------舞娘  远程物理伤害计算公式(已改)
function CommonFun.calcDamage_11201(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = targetUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
  
  ----------------------------------------------------------------------------------------------------------------元素箭额外增加物理伤害      
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  local skilllv_1 = srcUser:GetLernedSkillLevel(127)
  local atk_add = 0
  if skilllv_1 >10 and (skillID == 1360 or skillID==1397) then
    atk_add = Dex * ((skilllv_1-10) * 0.5)
  end
  ------------------------------------------普攻攻击力
  local NormalAtkAttr = srcUser:GetProperty("NormalAtk")
  local NormalAtk = NormalAtkAttr + 3*Dex

  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5) 
  local AtkFinal = ((Atk-BaseAtk+NormalAtk+atk_add)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  -----------------------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ------------------------------------------------------------------------巅峰等级 苍鹰之眼
  local targetid = targetUser:GetGuid()
  local distance = srcUser:GetDistance(targetid)
  local skilllv_1 = srcUser:GetLernedSkillLevel(133)
  local DisDam= 1
  if skilllv_1>10 and skillID==1397 then 
      DisDam = 1 + distance/7.5*(skilllv_1-10)*0.06
  end
  ---------------------------重伤箭
  local Injured = 1
  if bits[CommonFun.AttrEffect.NormalSkillDam]==1 then
      Injured = 1.3
  end    
  local Num1 = srcUser:GetRunePoint(103030)
  local RuneDamage = Num1*0.01+1

  local A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer)*(1-RefineDamReduc)*(1+DamIncrease-LongRangeDamReduc2)-Vit2*(1+VitPer2))*DisDam*Injured*RuneDamage

   if 1 >= A then
         return 1
   end
   --print("DisDam="..DisDam,"Injured="..Injured,"NormalAtk="..NormalAtk,"A="..A)
   return A

end
------------------------------------------------------------------------------------------------------------------振动回响 陷阱技能伤害计算公式
function CommonFun.calcDamage_11202(srcUser, targetUser, params, damageParam, logger)
  local BaseLv = srcUser.BaseLv
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
 
  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")

  local damChangePer = damageParam.damChangePer
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")

  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)+BaseAtk)*raceparam*bossparam*bossparam2
  local Refine = srcUser:GetProperty("Refine")
  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = (AtkFinal*MDefReduc*(1-MDamReduc2)+Refine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2

  if 1 >= A then
    return 1
  end
----------------------------------------------------------------------------振动领域
  local skilllv_1 = srcUser:GetLernedSkillLevel(1387)---舞娘
  local skilllv_2 = srcUser:GetLernedSkillLevel(1436)---诗人

  local AttrEffect = srcUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  if bits[CommonFun.AttrEffect.TriggerTrapMark]==1 then
      return A*(1+(skilllv_1+skilllv_2)*0.2)
  end
      
      return A     
end

------------------------------------------------------------------------------------------------------------------舞娘  远程物理  技能 伤害计算公式(已改)
function CommonFun.calcDamage_11203(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
   ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local AttrEffect = targetUser:GetProperty("AttrEffect")
  local bits=CommonFun.getBits(AttrEffect)

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local LongRangeDamReduc2 = targetUser:GetProperty("LongRangeDamReduc")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
  
  ---------------------------------------------------------------------------------------------------------------- 
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  -----------------------------------------------------------------------------------缠箭投掷、乐器攻击星盘
  local RuneDamage =1
  if skillID == 1364 or skillID == 1414 then 
      local Num1 = srcUser:GetRunePoint(102015)----乐器攻击
      local Num2 = srcUser:GetRunePoint(112007)----缠箭投掷
      RuneDamage = 1 + (Num1+Num2)*0.08
  end
  ------------------------------------------------------------------------------------奥义箭乱舞  星盘
  local AtkSp= 0
  if skillID == 1373 or skillID == 1423 then
      local Num3 = srcUser:GetRunePoint(102026)
      local Num4 = srcUser:GetRunePoint(102027)
      local Sp = srcUser:GetProperty("Sp")
      RuneDamage = 1+Num3*0.06
      AtkSp = math.floor(Sp/10)*Num4
  end

  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5) 
  local AtkFinal = ((Atk-BaseAtk+AtkSp)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  -----------------------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)


  local A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer)*(1-RefineDamReduc)*(1+DamIncrease-LongRangeDamReduc2)-Vit2*(1+VitPer2))*RuneDamage

   if 1 >= A then
         return 1
   end

   return A

end
------------------------------------------------------------------------------------------------------------------金属摇滚 技能伤害计算公式
function CommonFun.calcDamage_11204(srcUser, targetUser, params, damageParam, logger)
  local BaseLv = srcUser.BaseLv
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef  = 1
  end 
 
  local srcAtkElement    = CommonFun.GetUserAtkAttr(srcUser, params, damageParam)
  local targetDefElement = targetUser:GetProperty("DefAttr")

  local damChangePer = damageParam.damChangePer
  ----------------------------------------------------------------------------------------------------------------法系职业伤害会受到种族加伤减伤影响
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
 
  local MDef2 = targetUser:GetProperty("MDef")
  local MDefPer2 = targetUser:GetProperty("MDefPer")

  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")

  local damChangePer = damageParam.damChangePer

  local BaseAtk  = Dex*2 + math.floor(Dex*Dex/100) + math.floor(Str/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)+BaseAtk)*raceparam*bossparam*bossparam2
  local Refine = srcUser:GetProperty("Refine")
  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = (AtkFinal*MDefReduc*(1-MDamReduc2)+Refine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2

  if 1 >= A then
    return 1
  end
----------------------------------------------------------------------------演奏课程
  local skilllv_1 = srcUser:GetLernedSkillLevel(1388)---舞娘
  local skilllv_2 = srcUser:GetLernedSkillLevel(1437)---诗人

  A = A * (1 + 0.05*(skilllv_1 + skilllv_2))

  return A     
end
-----------------------------------------------------------------------------------------------------------------武僧弹指神通技能伤害计算公式(已改)
function CommonFun.calcDamage_12201(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  local Num1 = srcUser:GetBuffLayer(100500)--------------------------弹指神通气弹数
        Num1 = math.min(Num1,5)---------------最多5个
  local skilllv_1 = srcUser:GetLernedSkillLevel(322)---------------气弹精修
  local Num2 = Num1*skilllv_1*0.01+1

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*Num1*Num2
  local B = 0
  ---------------------------------------------------------------------------------------------------------------------------------------------------星盘弹指神通附带魔法伤害
  local Num1 = srcUser:GetRunePoint(120130)
  local RuneDamage = Num1*0.1

  if Num1 > 0 then

    local srcAtkElement    = 5
    local targetDefElement = targetUser:GetProperty("DefAttr")
    local Int = srcUser:GetProperty("Int")
    local MAtk = srcUser:GetProperty("MAtk")
    local MAtkPer = srcUser:GetProperty("MAtkPer")
    local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
    local BaseMAtk = Int+math.floor(Int*Int/100)
    local MDef2 = targetUser:GetProperty("MDef")
    local MDefPer2 = targetUser:GetProperty("MDefPer")
    local Vit2 = targetUser:GetProperty("Vit")
    local VitPer2 = targetUser:GetProperty("VitPer")
    local Int2 = targetUser:GetProperty("Int")
    local IntPer2 = targetUser:GetProperty("IntPer")
    local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
    local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
    local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
    local MRefine = srcUser:GetProperty("MRefine")

    local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*RuneDamage

    ----------------------------魔法防御减免
    local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

    B = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  end
  
   if 1 >= B then
        B = 0 
   end    

   if 1 >= (A + B) then
         return 1
   end
   
   return A + B
end

-----------------------------------------------------------------------------------------------------------------武僧阿修罗霸凰拳技能伤害计算公式(已改)
function CommonFun.calcDamage_12202(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local Sp = srcUser:GetProperty("Sp")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1
  ---------------------------------------------------------------------------物理减免
    local DamSpike = srcUser:GetProperty("DamSpike")
    local DamReduc = targetUser:GetProperty("DamReduc")
    ReduceLv = CommonFun.calcSpikeLv(srcUser, targetUser) -----穿刺等级
    local SkillDamReduc = CommonFun.calcSkillDamReduc(srcUser, targetUser)----技能物理伤害减免
    local DamReduc2 =1- (1 + 0.009*ReduceLv + DamSpike - DamReduc)*SkillDamReduc
    -----------------------------------------------------------------------阿修罗霸皇拳  巅峰等级 无视部分减伤  
    local skilllv = srcUser:GetLernedSkillLevel(306)
    if skilllv>5 then
        DamReduc2 =1- (1 + 0.009*ReduceLv + DamSpike - math.max(DamReduc-0.06*(skilllv-5),0))
    end
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)
  ------------------------------------------------------星盘
  local Num1 = srcUser:GetRunePoint(120100)
  local RuneDamage = Num1*0.6
  ---------------------------------------------装备 阿修罗
  local a = 0
  local b = 0
  local c = 0
  local d = 0
  local Equip1=srcUser:GetEquipedID(7)----鹰爪
  local Equip3=srcUser:GetEquipedID(5)----坚定指环
  local Equip4=srcUser:GetEquipedID(6)----坚定指环

  if Equip1 == 62508 or Equip1 == 162508 then
     a = 5
  end
  ---------------------------------------------装备格里芬之爪
  if Equip1 == 62540 or Equip1 == 162540 then
     a = 5
  end
  if srcUser:HasBuffID(90000935) then----坚定战袍升级buff
     b = 2
  end
  if Equip3 == 44003 or Equip3 == 144003 then
     c =1.5
  end
  if Equip4 == 44003 or Equip4 == 144003 then
     d =1.5
  end 
  local BaseAtk   = Str*2 + math.floor(Str*Str/100)   + math.floor(Dex/5) + math.floor(Luk/5)
  local BaseAtk1  = Str*4 + math.floor(Str*Str/100)*2   + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk1)*raceparam*bossparam*bossparam2

  local A = ((AtkFinal*(1 - DamReduc2) + Refine)*(damChangePer + Sp/100 + RuneDamage + a + b + c + d)+2500+500*damChangePer1)*(1+DamIncrease)*(1-RefineDamReduc)

   if 1 >= A then
         return 1
   end

   
   return A
end

-----------------------------------------------------------------------------------------------------------------武僧浸透劲技能伤害计算公式(已改)
function CommonFun.calcDamage_12203(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local Sp = srcUser:GetProperty("Sp")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  local DefFinal = (Def2-Vit2)*(1+DefPer2)+ Vit2*(1+VitPer2)
  if DefFinal >= 800 then
     DefFinal  = 800
  end   

  local A = (AtkFinal*(1 - DamReduc2) + Refine) * (2 + 1.5*damChangePer + DefFinal/120)*(1+DamIncrease)*(1-RefineDamReduc)
  local B = 0
  ---------------------------------------------------------------------------------------------------------------------------------------------------星盘浸透劲附带魔法伤害
  local Num1 = srcUser:GetRunePoint(120220)
  local RuneDamage = Num1*0.1

  if Num1 > 0 then

    local srcAtkElement    = 5
    local targetDefElement = targetUser:GetProperty("DefAttr")
    local Int = srcUser:GetProperty("Int")
    local MAtk = srcUser:GetProperty("MAtk")
    local MAtkPer = srcUser:GetProperty("MAtkPer")
    local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
    local BaseMAtk = Int+math.floor(Int*Int/100)
    local MDef2 = targetUser:GetProperty("MDef")
    local MDefPer2 = targetUser:GetProperty("MDefPer")
    local Vit2 = targetUser:GetProperty("Vit")
    local VitPer2 = targetUser:GetProperty("VitPer")
    local Int2 = targetUser:GetProperty("Int")
    local IntPer2 = targetUser:GetProperty("IntPer")
    local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
    local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
    local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
    local MRefine = srcUser:GetProperty("MRefine")

    local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam*RuneDamage
 
    ----------------------------魔法防御减免
    local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

     B = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(1-RefineMDamReduc)*damChangePer*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
  end
  
   if 1 >= B then
      B = 0
   end  

   if 1 >= (A + B) then
         return 1
   end
   
   return A + B
end

-----------------------------------------------------------------------------------------------------------------近战武僧系六合拳技能伤害计算公式(已改)
function CommonFun.calcDamage_12204(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local Num1 = srcUser:GetRunePoint(120110)
  local RuneDamage = 1 + Num1*0.1

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage
   
   if 1 >= A then
         return 1
   end

   if srcUser:HasBuffID(24890) then
      return A*1.15
   elseif srcUser:HasBuffID(24910) then 
      return A*1.1
   end  

   return A
end

-----------------------------------------------------------------------------------------------------------------近战武僧连环全身掌技能伤害计算公式(已改)
function CommonFun.calcDamage_12205(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Vit = srcUser:GetProperty("Vit")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ----------------------------------------------------星盘连环全身掌
  local Num1 = srcUser:GetRunePoint(120230)
  local RuneDamage = 1 + Num1*0.05
  ----------------------------------------------------体质会给连环全身掌带来伤害加成
  local VitDamage  = Vit/150
  if VitDamage<= 0 then
     VitDamage = 0
  end
 

  local A = ((AtkFinal*DefReduc*(1-DamReduc2) + Refine)*(damChangePer + VitDamage)*(1-RefineDamReduc)*(1 + DamIncrease)-Vit2*(1 + VitPer2))*RuneDamage
   
   if 1 >= A then
         return 1
   end
   
   if srcUser:HasBuffID(24910) then
      return A*1.1
   end 

   return A
end

-----------------------------------------------------------------------------------------------------------------近战武僧猛龙夸强技能伤害计算公式(已改)
function CommonFun.calcDamage_12206(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  --------------------------------------------------------------------星盘猛龙夸强
  local Num1 = srcUser:GetRunePoint(120150)
  local RuneDamage = Num1*0.05+1
  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage
   
   if 1 >= A then
         return 1
   end
   
   if srcUser:HasBuffID(24910) then
        return A*1.15
   end

   return A
end

-----------------------------------------------------------------------------------------------------------------武僧伏虎拳技能伤害计算公式
function CommonFun.calcDamage_12207(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  --------------------------------------------------------------星盘伏虎拳
  local Num1 = srcUser:GetRunePoint(120260)
  local RuneDamage = Num1*0.05+1

  ----------------------------------------------------------升龙拳套
  local Num2=1
   if srcUser:HasBuffID(90001513) then
     Num2=1.3 
   end

  
  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage*Num2
   
   if 1 >= A then
         return 1
   end
   
   return A
end

-----------------------------------------------------------------------------------------------------------------武僧技能气爆散伤害计算公式
function CommonFun.calcDamage_12208(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  --------------------------------------------------------------星盘气爆散
  local Num1 = srcUser:GetRunePoint(120240)
  local RuneDamage = Num1*0.05+1

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage
   
   if 1 >= A then
         return 1
   end
   
   return A
end
-----------------------------------------------------------------------------------------------------------------修罗 技能伤害计算公式(已改)
function CommonFun.calcDamage_12401(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
  
  ------------------------------------------------------------------------------大锤崩坠
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  ----------------------------------------------------------
    if skillID==1201 then
        if srcUser:HasBuffID(117010) then ----接双龙摆尾
          A = A *1.5
        end
    end

   if 1 >= A then
         return 1
   end

   return A
end
-----------------------------------------------------------------------------------------------------------------修罗 虎炮 技能伤害计算公式(已改)
function CommonFun.calcDamage_12402(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  ---------------------------------------------------------秘拳套闪光
  local shanguang=1
  if srcUser:HasBuffID(90001953) then 
    shanguang=0.05 + 1
  end

  local RefineLv7=srcUser:GetEquipedRefineLv(7)
  local miquan =0

  if srcUser:HasBuffID(90001953) then   
    if ( RefineLv7<10) then 
      miquan=RefineLv7* 0.1 
      elseif  (RefineLv7>=10 and RefineLv7<15) then 
      miquan=RefineLv7* 0.1 +0.4
      elseif RefineLv7 ==15 then
      miquan=RefineLv7* 0.1 +0.4+0.8
    end
  end
  ------------------------------------------------星盘
  local Num = srcUser:GetRunePoint(124020)
  local RuneDamage = 1 + Num*0.1

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+miquan)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*shanguang*RuneDamage
   
   if 1 >= A then
         return 1
   end
   ----------------------------------------------大锤崩坠之后伤害翻倍
   if srcUser:HasBuffID(117020) then
     A = A*2
   end

   return A
end
-----------------------------------------------------------------------------------------------------------------修罗 罗刹破凰拳 技能伤害计算公式(已改)
function CommonFun.calcDamage_12403(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------------自身血量越少，伤害越高
  local Numxp = srcUser:GetRunePoint(124030)

  local MaxHp = srcUser:GetProperty("MaxHp")
  local Hp = srcUser:GetProperty("Hp")
  local HpPerRatio = 1+(1-Hp/MaxHp)*(1+0.3*Numxp)
  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  ------------------------------坚定战袍
  local jianding = 0
  if srcUser:HasBuffID(90000939) then
     jianding=0.5
   end
  ------------------------------------------------------------------------------霸王乱舞
  local Ring7=srcUser:GetEquipedID(7)
  if (Ring7 == 62515 or Ring7==162515) then 
    jianding = jianding + 1
  end
------------------------------------------------------------------------------苍天霸皇
  if (Ring7 == 62541 or Ring7==162541) then 
    jianding = jianding + 1
  end
 ------------------------------------------------------------------------------霸王乱舞
  local RefineLv7=srcUser:GetEquipedRefineLv(7)
  local bawang = 1
  if (Ring7 == 62515 or Ring7==162515)  then
    if RefineLv7 > 0 then 
      bawang=(RefineLv7-0)* 0.01+1
    end
  end
  if ((Ring7 == 62515 or Ring7==162515) and srcUser:HasBuffID(90000939)  and srcUser:HasBuffID(90001943) )then
     bawang=bawang+0.05
   end
  ------------------------------------------------------------------------------苍天霸皇

  if (Ring7 == 62541 or Ring7==162541)  then
    if RefineLv7 > 0 then 
      bawang=(RefineLv7-0)* 0.01+1
    end
  end

  if ((Ring7 == 62541 or Ring7==162541) and srcUser:HasBuffID(90000939)  and srcUser:HasBuffID(90001943) )then
     bawang=bawang+0.05
   end
  ------------------------------------------------------------------------------霸王乱舞
  local dabawang = 0
  if (Ring7 == 62515 or Ring7==162515)  then
    if (RefineLv7>=5 and RefineLv7<10) then
        dabawang = 0.05
    elseif (RefineLv7>=10 and RefineLv7<15) then
        dabawang = 0.05 + 0.05
    elseif RefineLv7 ==15 then
        dabawang = 0.05 + 0.05 +0.1
    end
  end
 ------------------------------------------------------------------------------苍天霸皇
  if (Ring7 == 62541 or Ring7==162541)  then
    if (RefineLv7>=5 and RefineLv7<10) then
        dabawang = 0.05
    elseif (RefineLv7>=10 and RefineLv7<15) then
        dabawang = 0.05 + 0.05
    elseif RefineLv7 ==15 then
        dabawang = 0.05 + 0.05 +0.1
    end
  end
  ------------------------------------------------------------------------------坚定指环
  local Ring1=srcUser:GetEquipedID(5)
  local RefineLv1=srcUser:GetEquipedRefineLv(5)
  local Ring2=srcUser:GetEquipedID(6)
  local RefineLv2=srcUser:GetEquipedRefineLv(6)

  local a = 0
  local b = 0

  if (Ring1==44003 or Ring1==144003) and RefineLv1>=10 and RefineLv1< 15 and srcUser:HasBuffID(90001943) then
      a = 0.05
      elseif (Ring1==44003 or Ring1==144003) and RefineLv1==15 and srcUser:HasBuffID(90001943) then 
        a = 0.15
  end
  if (Ring2==44003 or Ring2==144003) and RefineLv2>=10 and  RefineLv2<15  and srcUser:HasBuffID(90001943) then
      b = 0.05
      elseif (Ring2==44003 or Ring2==144003) and RefineLv2==15 and srcUser:HasBuffID(90001943)  then 
        b = 0.15
  end
  local sizeCorrection=1
  if nil ~= CommonFun.Shape then
    if CommonFun.Shape.S == targetUser.shape then
        sizeCorrection = 1 + a + b
    elseif CommonFun.Shape.M == targetUser.shape then
        sizeCorrection = 1
    elseif CommonFun.Shape.L == targetUser.shape then
        sizeCorrection = 1 + a + b
    end
  end
  ------------------------------------------------星盘
  local Num = srcUser:GetRunePoint(124040)
  local RuneDamage = 1 + Num*0.06

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+jianding)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*HpPerRatio*sizeCorrection*bawang*RuneDamage
   
   if 1 >= A then
         return 1
   end
   ----------------------------------------------大锤崩坠之后伤害翻倍
   if srcUser:HasBuffID(117020) then
     A = A*(2+dabawang)
   end

   return A
end

-----------------------------------------------------------------------------------------------------------------修罗 点穴-默伤害计算公式(已改)
function CommonFun.calcDamage_12404(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*(1+Dex/100)
   
   if 1 >= A then
         return 1
   end

   return A
end
-----------------------------------------------------------------------------------------------------------------修罗  气弹爆破 技能伤害计算公式(已改)
function CommonFun.calcDamage_12405(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

   local Num1 = srcUser:GetBuffLayer(100500)--------------------------弹指神通气弹数

    ------------------------------------------------------------------------------霸王乱舞[第二档]
  local RefineLv7=srcUser:GetEquipedRefineLv(7)
  local bawang2 = 1
  if srcUser:HasBuffID(90002061)  then
      bawang2=(RefineLv7-0)* 0.02+1
  end
  if srcUser:HasBuffID(41910)  then
      bawang2=(RefineLv7-0)* 0.02+1
  end


  local A =( (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+damChangePer1*Num1)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)) * bawang2
  
   if 1 >= A then
         return 1
   end

   return A
end
-----------------------------------------------------------------------------------------------------------------炼金术士普攻伤害计算公式(已改)
function CommonFun.calcDamage_13201(srcUser, targetUser, params, damageParam, logger)
  local Str1 = srcUser:GetProperty("Str")
  --------------------------------------------------------------------------------------------------------炼金星盘加成的力量转换的普攻加成率提升百分比
  local Num1 = srcUser:GetRunePoint(130110)
  local RuneDamage = Num1*0.03 + 1
  local Str = Str1*RuneDamage

  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  ------------------------------------------------------普通攻击力
  local NormalAtk = srcUser:GetProperty("NormalAtk")
        NormalAtk = NormalAtk + 5*Str
  ------------------------------------
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk   = Str1*2 + math.floor(Str1*Str1/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local BaseAtk1  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)

  local AtkFinal = ((Atk-BaseAtk+NormalAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk1)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)

  -----------------------------------------------------------------------------------------------------------二刀连击
  local WeaponType =srcUser:GetEquipedWeaponType()
  local skilllv_1 = srcUser:GetLernedSkillLevel(179)

  if WeaponType==250 and CommonFun.IsInRate(skilllv_1*5, srcUser:GetRandom())  then
        return A*2, CommonFun.DamageType.ErLianJi
  end 


   if 1 >= A then
         return 1
   end

   return A
end

-----------------------------------------------------------------------------------------------------------------火烟瓶投掷技能伤害计算公式(已改)
function CommonFun.calcDamage_13202(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  
  local A = (AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2)
  local B = 0
  -----------------------------------------------------------------------------------------------------------------------------------------------强化火烟瓶投掷
  local skilllv_1 = srcUser:GetLernedSkillLevel(425)

    if skilllv_1 >= 1 then

      local srcAtkElement    = 4
      local targetDefElement = targetUser:GetProperty("DefAttr")
      local Int = srcUser:GetProperty("Int")
      local MAtk = srcUser:GetProperty("MAtk")
      local MAtkPer = srcUser:GetProperty("MAtkPer")
      local IgnoreMDef = srcUser:GetProperty("IgnoreMDef")
      local BaseMAtk = Int+math.floor(Int*Int/100)
      local MDef2 = targetUser:GetProperty("MDef")
      local MDefPer2 = targetUser:GetProperty("MDefPer")
      local Vit2 = targetUser:GetProperty("Vit")
      local VitPer2 = targetUser:GetProperty("VitPer")
      local Int2 = targetUser:GetProperty("Int")
      local IntPer2 = targetUser:GetProperty("IntPer")
      local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
      local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)
      local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
      local MRefine = srcUser:GetProperty("MRefine")

      local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam
      ----------------------------魔法防御减免
      local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)


       B = ((MAtkFinal*MDefReduc*(1-MDamReduc2)+MRefine)*(skilllv_1*0.3+0.5)*(1-RefineMDamReduc)*(1+MDamIncrease)*GameConfig.ElementRestrain[srcAtkElement][targetDefElement]*elementparam2-Vit2/2*(1+VitPer2)-Int2*(1+IntPer2))
    end
  
   if 1 >= B then
      B = 0
   end  
   --------------------------------------------星盘火烟瓶投掷
   local Num1 = srcUser:GetRunePoint(130260)
   local RuneDamage1 = Num1*0.1
  -------------------------------------星盘 丽芙祈福
   local Num2 = srcUser:GetRunePoint(130170)
   local RuneDamage2 = 0
   if  srcUser:IsBeingPresent(600010)==true then
      RuneDamage2 = Num2*0.03
   end
   --------------------------------------------------------------艾尔德之锤
   ---------------------------------------------------酸蚀之触
   local aerde = 1
   local weaponRefineLv=srcUser:GetEquipedRefineLv(7)
   if srcUser:HasBuffID(40610) or srcUser:HasBuffID(42000)  then
      aerde=weaponRefineLv*0.05+1
   end   
  ------------------------------------------艾尔德[第四档]【火烟瓶投掷】
  local Int8 = srcUser:GetProperty("Int")
  local Str8 = srcUser:GetProperty("Str")
  local Vit8 = srcUser:GetProperty("Vit")
  if (srcUser:HasBuffID(90001883) and Int8>=119 and Str8>=119 ) then 
    aerde=aerde+0.1
  end
  ---------------------------------------------------酸蚀之触
  if (srcUser:HasBuffID(42000) and Int8>=119 and Str8>=119 ) then 
    aerde=aerde+0.1
  end

   if 1 >= (A + B) then
         return 1
   end
   
   return (A + B)*(1+RuneDamage1+RuneDamage2)*aerde
end

-----------------------------------------------------------------------------------------------------------------炼金术士强酸伤害计算公式(已改)
function CommonFun.calcDamage_13203(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam


  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  --------------------------------------------星盘 强酸攻击
  local Num1 = srcUser:GetRunePoint(130160)
  local RuneDamage1 = Num1*0.05
  -------------------------------------星盘 丽芙祈福
  local Num2 = srcUser:GetRunePoint(130170)
  local RuneDamage2 = 0
  if  srcUser:IsBeingPresent(600010)==true then
        RuneDamage2 = Num2*0.03
  end
------------------------------------------艾尔德
  ---------------------------------------------------酸蚀之触
  local  aerde1=1
  local weaponRefineLv=srcUser:GetEquipedRefineLv(7)
  if srcUser:HasBuffID(40610) or srcUser:HasBuffID(42000)  then 
      aerde1=weaponRefineLv*0.02+1
  end
------------------------------------------艾尔德【第四档】
  local Int8 = srcUser:GetProperty("Int")
  local Str8 = srcUser:GetProperty("Str")
  local Vit8 = srcUser:GetProperty("Vit")
  if (srcUser:HasBuffID(90001883) and Int8>=119 and Str8>=119 ) then 
    aerde1=aerde1+0.05
  end
  ---------------------------------------------------酸蚀之触
  if (srcUser:HasBuffID(42000) and Int8>=119 and Str8>=119 ) then 
    aerde1=aerde1+0.05

  end


  local A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer+(MAtkFinal*DefReduc*(1-DamReduc2)+MRefine)*damChangePer1)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*(1+RuneDamage1+RuneDamage2)*aerde1

   if 1 >= A then
         return 1
   end

   return A
end

-----------------------------------------------------------------------------------------------------------------炼金术士强酸火烟瓶伤害计算公式(已改)
function CommonFun.calcDamage_13204(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
  local BaseMAtk = Int+math.floor(Int*Int/100)
  local MAtkFinal= ((MAtk-BaseMAtk)*(1+MAtkPer)+BaseMAtk)*raceparam

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  --------------------------------------------星盘 强酸火烟瓶
  local Num1 = srcUser:GetRunePoint(130210)
  local RuneDamage1 = Num1*0.08+1

  ------------------------------------------艾尔德
  ---------------------------------------------------酸蚀之触
  local  aerde2=0
  local weaponRefineLv=srcUser:GetEquipedRefineLv(7)
  if srcUser:HasBuffID(40610) or srcUser:HasBuffID(42000) then 
      aerde2=weaponRefineLv*0.3
  end

  ------------------------------------------艾尔德[第四档]【强酸火焰瓶投掷】
  local Int8 = srcUser:GetProperty("Int")
  local Str8 = srcUser:GetProperty("Str")
  local Vit8 = srcUser:GetProperty("Vit")
    if (srcUser:HasBuffID(90001883) and Int8>=119 and Str8>=119 ) then 
    aerde2=aerde2+0.75
  end
  ---------------------------------------------------酸蚀之触
  if (srcUser:HasBuffID(42000) and Int8>=119 and Str8>=119 ) then 
   aerde2=aerde2+0.75
  end


  ------------------------------------------艾尔德+化学防护手套
  local  aerde3=1
  if srcUser:HasBuffID(91000300) then 
      aerde3=0.15 + aerde3
  end
  ---------------------------------------------------酸蚀之触 + 化学防护手套
   if srcUser:HasBuffID(91000710) then 
      aerde3=0.15 + aerde3
  end 

  if srcUser:HasBuffID(90002203) then 
      aerde3=0.05 + aerde3
  end
  
  -------------------------------------星盘 丽芙祈福
  local Num2 = srcUser:GetRunePoint(130170)
  local RuneDamage2 = 1
  if srcUser:IsBeingPresent(600010)==true then
      RuneDamage2 = Num2*0.02+1
  end
  ------------------------------------------目标体质相关的倍率
  local skilllv_1 = srcUser:GetLernedSkillLevel(411)
  local VitRatio = 0
  local Num3 = srcUser:GetRunePoint(133010)
      Vit2 = Vit2+Num3*10
  if Vit2 > 0 and Vit2 <=80 then
      VitRatio = Vit2/50*(1+skilllv_1/40)
  elseif Vit2 > 80 and Vit2 <=120 then
      VitRatio = Vit2/45*(1+skilllv_1/35)
  elseif Vit2 > 120 and Vit2 <=150 then
      VitRatio = Vit2/40*(1+skilllv_1/30)
  elseif Vit2 > 150 and Vit2 <=200 then
      VitRatio = Vit2/30*(1+skilllv_1/25)
  elseif Vit2 > 200 then
      VitRatio = Vit2/20*(1+skilllv_1/25)
  end
  ----------------------------------------------------------灼热风暴
  local Fire=1
  local skilllv_2 = srcUser:GetLernedSkillLevel(1121)

  ---------------------------------星盘 疯狂火焰
  local Numxp= srcUser:GetRunePoint(134010)------------星盘点
  local RuneFire = Numxp*0.04

  if targetUser:HasBuffID(116204) then 
      Fire = skilllv_2*0.04 + 1 + RuneFire
  end

  local A = (((AtkFinal+MAtkFinal)*DefReduc*(1-DamReduc2)+Refine+MRefine)*(damChangePer+VitRatio+aerde2)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage1*aerde3*RuneDamage2*Fire

  -----------------------------------------------火焰爆炸
  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  ----------------------------------------------------------
    if skillID==1122 then
        --------------------------------------------
        local skilllv_3 = srcUser:GetLernedSkillLevel(422)
        local damChangePer = 2.8
        if skilllv_3<=10 then
            damChangePer = 2.8+0.8*skilllv_3
        elseif skilllv_3>10 then
            damChangePer =10.8 + 0.3*(skilllv_3-10)
        end
        ---------------------------------星盘 
        local Numxp= srcUser:GetRunePoint(134090)------------星盘点
        local RuneDamageFire = 1 + Numxp*0.06

        A = (((AtkFinal+MAtkFinal)*DefReduc*(1-DamReduc2)+Refine+MRefine)*(damChangePer+VitRatio+aerde2)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage1*aerde3*RuneDamage2*Fire*RuneDamageFire
   end
   --------------------------------------不稳定药剂
   local skilllv_yj = srcUser:GetLernedSkillLevel(1135)
   local random_yj = srcUser:GetRandom()
   local Final_ran = (80 + random_yj*(skilllv_yj*0.05 + 0.45))/100

   if skilllv_yj>0 then 
      A = A*Final_ran
      if Final_ran>1 then
          return A, CommonFun.DamageType.Crit
      end
   end    

   if 1 >= A then
         return 1
   end

   return A
end

-----------------------------------------------------------------------------------------------------------------炼金术士 气泡虫伤害计算公式(已改)
function CommonFun.calcDamage_13205(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  local damChangePer1 = damageParam.damChangePer1
  local damChangePer2 = damageParam.damChangePer2
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  --------------------------------------------星盘 气泡虫召唤
  local Num1 = srcUser:GetRunePoint(130020)
  local RuneDamage1 = Num1*0.3
  -------------------------------------------------------红色手提包
  local Redhandbag = 1
  local Ring1=srcUser:GetEquipedID(1)
  if (Ring1==42551 or Ring1==142551) then 
    Redhandbag=1.15
  end 
        
   -------------------------------------------------------红色手提包[第四档]

  local RefineLv1=srcUser:GetEquipedRefineLv(1)
   if (RefineLv1>=5 and srcUser:HasBuffID(90002213)) then
    Redhandbag = Redhandbag + 0.1
  end
        
  local A = (((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+RuneDamage1)+damChangePer1*DefReduc*(1-DamReduc2))*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*damChangePer2*Redhandbag


  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
  ----------------------------------------------------------气泡虫寄生
         -------------------------------------------------------红色手提包
  local Redhandbag1 = 1
  local Ring1=srcUser:GetEquipedID(1)
  if (Ring1==42551 or Ring1==142551) then 
    Redhandbag1=1.15
  end 

   -------------------------------------------------------红色手提包[第四档]

  local RefineLv1=srcUser:GetEquipedRefineLv(1)
   if (RefineLv1>=5 and srcUser:HasBuffID(90002213)) then
    Redhandbag1 = Redhandbag1 + 0.1
  end
    if skillID==415 then
 
        --------------------------------------------星盘 气泡虫寄生
        local Num2 = srcUser:GetRunePoint(130080)
        local RuneDamage2 = Num2*0.1+1
        A = A*RuneDamage2*Redhandbag1
   end

   if 1 >= A then
         return 1
   end

   return A
end

-----------------------------------------------------------------------------------------------------------------炼金术士地狱植物计算公式(已改)
function CommonFun.calcDamage_13206(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
 
  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  -----------------------生命体强化2
  local skilllv_1 = srcUser:GetLernedSkillLevel(428)
  --------------------------------------------星盘 地狱植物
  local Num1 = srcUser:GetRunePoint(130140)
  local RuneDamage1 = Num1*0.05+1
  ------------------------------------------生命通灵
  local skilllv_2 = srcUser:GetLernedSkillLevel(417)
  local life = 1
  if srcUser:HasBuffID(104050) then
      life = 1+ 0.02*skilllv_2
  end
  -------------------------------------------生命融合
  local skilllv_3 = srcUser:GetLernedSkillLevel(1126)
  if srcUser:HasBuffID(116221) then
      life = life+ 0.03*skilllv_3
  end

  -------------------------------------- 破灭战斧
  local pomieNum1 = 1
  if  srcUser:HasBuffID(42010)  then
       pomieNum1 = 1.15
  end


  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+skilllv_1*0.1)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage1*life*pomieNum1


   if 1 >= A then
         return 1
   end

   return A
end
-----------------------------------------------------------------------------------------------------------------炼金术士 疯狂火焰伤害计算公式(已改)
function CommonFun.calcDamage_13401(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local MAtk = srcUser:GetProperty("MAtk")
  local MAtkPer = srcUser:GetProperty("MAtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
  ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local MRefine = srcUser:GetProperty("MRefine")
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local MDamReduc2 = CommonFun.calcMDamReDuc(srcUser, targetUser)
  local RefineMDamReduc = targetUser:GetProperty("RefineMDamReduc")
  local MDamIncrease = CommonFun.calcMDamIncrease(srcUser, targetUser)

  local damChangePer = damageParam.damChangePer
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)

  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2

  ----------------------------魔法防御减免
  local MDefReduc = CommonFun.CalcMDef(MDef,Int,Vit,srcUser,targetUser)

  local A = ((AtkFinal*MDefReduc*(1-MDamReduc2)+Refine)*damChangePer*(1-RefineMDamReduc)*(1+MDamIncrease)-Vit2*(1+VitPer2))

   if 1 >= A then
         return 1
   end

   return A
end

-----------------------------------------------------------------------------------------------------------------炼金术士 加农炮技能 计算公式(已改)
function CommonFun.calcDamage_13402(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer
  local skilllv_1 = srcUser:GetLernedSkillLevel(266)
  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk+skilllv_1*15)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
 
  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)
  ---------------------------------星盘 加农炮
  local Numxp= srcUser:GetRunePoint(134040)------------星盘点
  local RuneDamage = 1 + Numxp*0.1

-------------------------------------------------------红色手提包[第四档]

  local Redhandbag = 1
  local RefineLv1=srcUser:GetEquipedRefineLv(1)
   if (RefineLv1>=10 and srcUser:HasBuffID(90002213)) then
    Redhandbag = Redhandbag + 0.15
  end


    local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*(damChangePer+Int/20)*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))*RuneDamage*Redhandbag


   if 1 >= A then
         return 1
   end

   return A
end

-----------------------------------------------------------------------------------------------------------------炼金术士 野草 计算公式(已改)
function CommonFun.calcDamage_13403(srcUser, targetUser, params, damageParam, logger)
  local Str = srcUser:GetProperty("Str")
  local Dex = srcUser:GetProperty("Dex")
  local Luk = srcUser:GetProperty("Luk")
  local Int = srcUser:GetProperty("Int")
  local Atk = srcUser:GetProperty("Atk")
  local AtkPer = srcUser:GetProperty("AtkPer")
  local DamIncrease = srcUser:GetProperty("DamIncrease")
  local IgnoreDef  = 0
  local IgnoreDef1 = srcUser:GetProperty("IgnoreDef")
  local IgnoreDef2 = srcUser:GetProperty("IgnoreEquipDef")
  if targetUser.boss or targetUser.mini then
     IgnoreDef=IgnoreDef1
  else
     IgnoreDef=(IgnoreDef1+IgnoreDef2)  
  end
  
  if IgnoreDef >= 1 then
     IgnoreDef=1
  end 
    ------------------------------------------------------------------------------------将原来的物伤加成改成精炼物理攻击
  local Refine = srcUser:GetProperty("Refine")

  local Def2 = targetUser:GetProperty("Def")
  local DefPer2 = targetUser:GetProperty("DefPer")
  local Vit2 = targetUser:GetProperty("Vit")
  local VitPer2 = targetUser:GetProperty("VitPer")
  local DamReduc2 = CommonFun.calcDamReDuc(srcUser, targetUser)
  local RefineDamReduc = targetUser:GetProperty("RefineDamReduc")

  local damChangePer = damageParam.damChangePer

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS加伤效果
  local raceparam     = CommonFun.CalcRaceParam(srcUser, targetUser, params, damageParam, logger)
  local bodyparam     = CommonFun.CalcBodyParam(srcUser, targetUser, params, damageParam, logger)
  local elementparam  = CommonFun.CalcElementParam(srcUser, targetUser, params, damageParam, logger)
  local bossparam     = CommonFun.CalcBossParam(srcUser, targetUser, params, damageParam, logger)

  ----------------------------------------------------------------------------------------------------------------种族，体型，属性，BOSS减伤效果
  local raceparam2    = CommonFun.CalcRaceParam2(srcUser, targetUser, params, damageParam, logger)
  local bodyparam2    = CommonFun.CalcBodyParam2(srcUser, targetUser, params, damageParam, logger)
  local elementparam2 = CommonFun.CalcElementParam2(srcUser, targetUser, params, damageParam, logger)
  local bossparam2    = CommonFun.CalcBossParam2(srcUser, targetUser, params, damageParam, logger)



  local BaseAtk  = Str*2 + math.floor(Str*Str/100) + math.floor(Dex/5) + math.floor(Luk/5)
  local AtkFinal = ((Atk-BaseAtk)*(1+AtkPer)*CommonFun.ShapeCorrection(srcUser,targetUser)*bodyparam*elementparam*elementparam2+BaseAtk)*raceparam*bossparam*bossparam2
 
  ----------------------------物理防御减免
  local DefReduc= CommonFun.CalcDef(Def,Vit,srcUser,targetUser)

  local A = ((AtkFinal*DefReduc*(1-DamReduc2)+Refine)*damChangePer*(1-RefineDamReduc)*(1+DamIncrease)-Vit2*(1+VitPer2))

   -------------------------------------------------------红色手提包
  local Redhandbag3 = 1
  local Ring1=srcUser:GetEquipedID(1)
    if (Ring1==42551 or Ring1==142551) then 
      Redhandbag3=1.15
    end 

  -------------------------------------------------------红色手提包[第四档]

  local RefineLv1=srcUser:GetEquipedRefineLv(1)
   if (RefineLv1>=10 and srcUser:HasBuffID(90002213)) then
    Redhandbag3 = Redhandbag3 + 0.15
  end


  local skillID, skillLevel = CommonFun.UnmergeSkillID(params.skillIDAndLevel)
   if skillID==1124 then
        ---------------------------------星盘 
        local Numxp= srcUser:GetRunePoint(134060)------------星盘点
        local RuneDamage = 1 + Numxp*0.08
         A = A*Redhandbag3*RuneDamage
   end 


   if 1 >= A then
         return 1
   end

   return A
end

-- 技能吸血
function CommonFun.CalcSuckBlood(srcUser, damage, skillid)
    local skillParams = Table_Skill[skillid]
    if skillParams == nil or skillParams.Logic_Param == nil then
      return 0
    end
    
    local Num1=srcUser:GetRunePoint(42130)
    local RuneDamage=0.01*Num1
    local skilllv_1=srcUser:GetLernedSkillLevel(1168)

    if skillParams.Logic_Param.isSuckSkill then
          if math.floor(skillid/1000)==130 and skillid%100<=5 then
              return damage * (0.15+RuneDamage)
          end
          if math.floor(skillid/1000)==130 and skillid%100>5 then
              return damage * (0.3+RuneDamage)
          end    
          ----------------------------------------生命吸收
          if math.floor(skillid/1000)==1168 then
              return damage*(0.25+math.min(skilllv_1,5)*0.05)
          end 
    end
    
    return 0
end



----------------------------------------------------------公式调用
CommonFun.CalcDamageFuncs = {
  [17]   = CommonFun.calcDamage_17,
  [18]   = CommonFun.calcDamage_18,
  [19]   = CommonFun.calcDamage_19,
  [20]   = CommonFun.calcDamage_20,
  [21]   = CommonFun.calcDamage_21,
  [22]   = CommonFun.calcDamage_22,
  [23]   = CommonFun.calcDamage_23,
  [24]   = CommonFun.calcDamage_24,
  [25]   = CommonFun.calcDamage_25,
  [26]   = CommonFun.calcDamage_26,
  [27]   = CommonFun.calcDamage_27,
  [28]   = CommonFun.calcDamage_28,
  [30]   = CommonFun.calcDamage_30,
  [31]   = CommonFun.calcDamage_31,
  [32]   = CommonFun.calcDamage_32,
  [33]   = CommonFun.calcDamage_33,
  [34]   = CommonFun.calcDamage_34,
  [35]   = CommonFun.calcDamage_35,
  [36]   = CommonFun.calcDamage_36,
  [37]   = CommonFun.calcDamage_37,
  [38]   = CommonFun.calcDamage_38,
  [39]   = CommonFun.calcDamage_39,
  [40]   = CommonFun.calcDamage_40,
  [41]   = CommonFun.calcDamage_41,
  [42]   = CommonFun.calcDamage_42,
  [43]   = CommonFun.calcDamage_43,
  [50]   = CommonFun.calcDamage_50,
  [60]   = CommonFun.calcDamage_60,
  [80]   = CommonFun.calcDamage_80,
  [100]   = CommonFun.calcDamage_100,
  [101]   = CommonFun.calcDamage_101,
  [1101] = CommonFun.calcDamage_1101,
  [1102] = CommonFun.calcDamage_1102,
  [1103] = CommonFun.calcDamage_1103,
  [1201] = CommonFun.calcDamage_1201,
  [1202] = CommonFun.calcDamage_1202,
  [1203] = CommonFun.calcDamage_1203,
  [1204] = CommonFun.calcDamage_1204,
  [1205] = CommonFun.calcDamage_1205,
  [1206] = CommonFun.calcDamage_1206,
  [1207] = CommonFun.calcDamage_1207,
  [1301] = CommonFun.calcDamage_1301,
  [1302] = CommonFun.calcDamage_1302,
  [1401] = CommonFun.calcDamage_1401,
  [1402] = CommonFun.calcDamage_1402,
  [2103] = CommonFun.calcDamage_2103,
  [2201] = CommonFun.calcDamage_2201,
  [2301] = CommonFun.calcDamage_2301,
  [2302] = CommonFun.calcDamage_2302,
  [2303] = CommonFun.calcDamage_2303,
  [2304] = CommonFun.calcDamage_2304,
  [2305] = CommonFun.calcDamage_2305,
  [2306] = CommonFun.calcDamage_2306,
  [3101] = CommonFun.calcDamage_3101,
  [3102] = CommonFun.calcDamage_3102,
  [3103] = CommonFun.calcDamage_3103,
  [3104] = CommonFun.calcDamage_3104,
  [3105] = CommonFun.calcDamage_3105,
  [3106] = CommonFun.calcDamage_3106,
  [3201] = CommonFun.calcDamage_3201,
  [3202] = CommonFun.calcDamage_3202,
  [3301] = CommonFun.calcDamage_3301,
  [3401] = CommonFun.calcDamage_3401,
  [3402] = CommonFun.calcDamage_3402,
  [4101] = CommonFun.calcDamage_4101,
  [4102] = CommonFun.calcDamage_4102,
  [4103] = CommonFun.calcDamage_4103,
  [4201] = CommonFun.calcDamage_4201,
  [4202] = CommonFun.calcDamage_4202,
  [4203] = CommonFun.calcDamage_4203,
  [4301] = CommonFun.calcDamage_4301,
  [4401] = CommonFun.calcDamage_4401,
  [5101] = CommonFun.calcDamage_5101,
  [5102] = CommonFun.calcDamage_5102,
  [5103] = CommonFun.calcDamage_5103,
  [5104] = CommonFun.calcDamage_5104,
  [5105] = CommonFun.calcDamage_5105,
  [5106] = CommonFun.calcDamage_5106,
  [5401] = CommonFun.calcDamage_5401,
  [5402] = CommonFun.calcDamage_5402,
  [6101] = CommonFun.calcDamage_6101,
  [6102] = CommonFun.calcDamage_6102,
  [6103] = CommonFun.calcDamage_6103,
  [6104] = CommonFun.calcDamage_6104,
  [6105] = CommonFun.calcDamage_6105,
  [6106] = CommonFun.calcDamage_6106,
  [6301] = CommonFun.calcDamage_6301,
  [6302] = CommonFun.calcDamage_6302,
  [6401] = CommonFun.calcDamage_6401,
  [6402] = CommonFun.calcDamage_6402,
  [6403] = CommonFun.calcDamage_6403,
  [6404] = CommonFun.calcDamage_6404,
  [7201] = CommonFun.calcDamage_7201,
  [7202] = CommonFun.calcDamage_7202,
  [7203] = CommonFun.calcDamage_7203,
  [7204] = CommonFun.calcDamage_7204,
  [7205] = CommonFun.calcDamage_7205,
  [7401] = CommonFun.calcDamage_7401,
  [7402] = CommonFun.calcDamage_7402,
  [8000] = CommonFun.calcDamage_8000,
  [8001] = CommonFun.calcDamage_8001,
  [8002] = CommonFun.calcDamage_8002,
  [8003] = CommonFun.calcDamage_8003,
  [8004] = CommonFun.calcDamage_8004,
  [8005] = CommonFun.calcDamage_8005,
  [8006] = CommonFun.calcDamage_8006,
  [8007] = CommonFun.calcDamage_8007,
  [8008] = CommonFun.calcDamage_8008,
  [8020] = CommonFun.calcDamage_8020,
  [8030] = CommonFun.calcDamage_8030,
  [8031] = CommonFun.calcDamage_8031,
  [8032] = CommonFun.calcDamage_8032,
  [8021] = CommonFun.calcDamage_8021,
  [8201] = CommonFun.calcDamage_8201,
  [8202] = CommonFun.calcDamage_8202,
  [8203] = CommonFun.calcDamage_8203,
  [8204] = CommonFun.calcDamage_8204,
  [8205] = CommonFun.calcDamage_8205,
  [9000] = CommonFun.calcDamage_9000,
  [9001] = CommonFun.calcDamage_9001,
  [9002] = CommonFun.calcDamage_9002,
  [9003] = CommonFun.calcDamage_9003,
  [9004] = CommonFun.calcDamage_9004,
  [9005] = CommonFun.calcDamage_9005,
  [9006] = CommonFun.calcDamage_9006,
  [9010] = CommonFun.calcDamage_9010,
  [9011] = CommonFun.calcDamage_9011,
  [9012] = CommonFun.calcDamage_9012,
  [9013] = CommonFun.calcDamage_9013,
  [9014] = CommonFun.calcDamage_9014,
  [9015] = CommonFun.calcDamage_9015,
  [9016] = CommonFun.calcDamage_9016,
  [9017] = CommonFun.calcDamage_9017, 
  [9018] = CommonFun.calcDamage_9018, 
  [9201] = CommonFun.calcDamage_9201,
  [9202] = CommonFun.calcDamage_9202,
  [9203] = CommonFun.calcDamage_9203,
  [9204] = CommonFun.calcDamage_9204, 
  [9205] = CommonFun.calcDamage_9205,
  [9206] = CommonFun.calcDamage_9206,
  [9401] = CommonFun.calcDamage_9401,
  [10201] = CommonFun.calcDamage_10201,
  [11201] = CommonFun.calcDamage_11201,
  [11202] = CommonFun.calcDamage_11202,
  [11203] = CommonFun.calcDamage_11203,
  [11204] = CommonFun.calcDamage_11204,
  [12201] = CommonFun.calcDamage_12201,
  [12202] = CommonFun.calcDamage_12202,
  [12203] = CommonFun.calcDamage_12203,
  [12204] = CommonFun.calcDamage_12204,
  [12205] = CommonFun.calcDamage_12205,
  [12206] = CommonFun.calcDamage_12206,
  [12207] = CommonFun.calcDamage_12207,
  [12208] = CommonFun.calcDamage_12208,
  [12401] = CommonFun.calcDamage_12401,
  [12402] = CommonFun.calcDamage_12402,
  [12403] = CommonFun.calcDamage_12403,
  [12404] = CommonFun.calcDamage_12404,
  [12405] = CommonFun.calcDamage_12405,
  [13201] = CommonFun.calcDamage_13201,
  [13202] = CommonFun.calcDamage_13202,
  [13203] = CommonFun.calcDamage_13203,
  [13204] = CommonFun.calcDamage_13204,
  [13205] = CommonFun.calcDamage_13205,
  [13206] = CommonFun.calcDamage_13206,
  [13401] = CommonFun.calcDamage_13401,
  [13402] = CommonFun.calcDamage_13402,
  [13403] = CommonFun.calcDamage_13403,
}
